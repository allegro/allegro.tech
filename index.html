<!DOCTYPE html><html lang="pl"><head><meta charSet="utf-8"/><link rel="prefetch" href="https://allegrotechio.disqus.com/count.js"/><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta name="description" content="Allegro Tech to miejsce, w którym nasi inżynierowie dzielą się wiedzą oraz case study z wybranych projektów w firmie - w formie artykułów, podcastów oraz eventów."/><title>Allegro Tech</title><meta property="og:site_name" content="allegro.tech"/><meta property="og:title" content="allegro.tech"/><meta property="og:url" content="https://allegro.tech"/><meta property="og:type" content="site"/><meta property="og:image" content="https://allegro.tech/images/allegro-tech.png"/><link rel="shortcut icon" href="favicon.ico"/><link rel="canonical" href="https://allegro.tech" itemProp="url"/><link rel="preload" href="images/splash.jpg" as="image"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-1M1FJ5PXWW"></script><script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){dataLayer.push(arguments);}
                    gtag('js', new Date());
                    gtag('config', 'G-1M1FJ5PXWW');
                </script><meta name="next-head-count" content="15"/><link rel="preload" href="/_next/static/css/f90f7240cef95199c2b1.css" as="style"/><link rel="stylesheet" href="/_next/static/css/f90f7240cef95199c2b1.css" data-n-g=""/><link rel="preload" href="/_next/static/css/bab806b57e265845b5ec.css" as="style"/><link rel="stylesheet" href="/_next/static/css/bab806b57e265845b5ec.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-fb76148cfcfb42ca18eb.js" defer=""></script><script src="/_next/static/chunks/framework-0441fae7fd130f37dee1.js" defer=""></script><script src="/_next/static/chunks/main-a220dc5659b4b5150eca.js" defer=""></script><script src="/_next/static/chunks/pages/_app-7f59b0547fcfd7939f7d.js" defer=""></script><script src="/_next/static/chunks/682-97b125405c243e8ea066.js" defer=""></script><script src="/_next/static/chunks/pages/index-9da81bcd06c57dcc8421.js" defer=""></script><script src="/_next/static/jvS2iwz_TaC-EZro3Eupc/_buildManifest.js" defer=""></script><script src="/_next/static/jvS2iwz_TaC-EZro3Eupc/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-bottom_16 m-padding-bottom_24_lg m-padding-left_16 m-padding-left_24_lg m-card Header_navbar__2vWRp m-color-bg_card"><nav class="m-width-max_1600 m-margin-left_auto m-margin-right_auto m-display-flex m-flex-justify-between m-flex-items-center"><a href="/"><img src="images/logo.svg" alt="Allegro Tech" width="205" height="45"/></a><div><ul class="m-font-family_sans m-font-size_14 m-line-height_21 m-color_text m-text-size-adjust_100p m-list-style-type_none m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-padding-top_0 m-padding-right_0 m-padding-bottom_0 m-padding-left_0 m-display-flex@lg m-display-none"><li class="m-margin-left-16@lg"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-display-block m-display-inline@lg m-padding-left-16 m-padding-right-16 m-padding-top-16 m-padding-bottom-16 m-padding-left-0@lg m-padding-top-0@lg m-padding-right-0@lg m-padding-bottom-0@lg m-link--signal m-line-height_21" href="https://blog.allegro.tech">Blog</a></li><li class="m-margin-left-16@lg"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-display-block m-display-inline@lg m-padding-left-16 m-padding-right-16 m-padding-top-16 m-padding-bottom-16 m-padding-left-0@lg m-padding-top-0@lg m-padding-right-0@lg m-padding-bottom-0@lg m-link--signal m-line-height_21" href="https://podcast.allegro.tech">Podcast</a></li><li class="m-margin-left-16@lg"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-display-block m-display-inline@lg m-padding-left-16 m-padding-right-16 m-padding-top-16 m-padding-bottom-16 m-padding-left-0@lg m-padding-top-0@lg m-padding-right-0@lg m-padding-bottom-0@lg m-link--signal m-line-height_21" href="https://github.com/Allegro">Open Source</a></li><li class="m-margin-left-16@lg"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-display-block m-display-inline@lg m-padding-left-16 m-padding-right-16 m-padding-top-16 m-padding-bottom-16 m-padding-left-0@lg m-padding-top-0@lg m-padding-right-0@lg m-padding-bottom-0@lg m-link--signal m-line-height_21" href="https://www.meetup.com/allegrotech/events">Wydarzenia</a></li><li class="m-margin-left-16@lg"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-display-block m-display-inline@lg m-padding-left-16 m-padding-right-16 m-padding-top-16 m-padding-bottom-16 m-padding-left-0@lg m-padding-top-0@lg m-padding-right-0@lg m-padding-bottom-0@lg m-link--signal m-line-height_21" href="https://praca.allegro.pl">Praca</a></li></ul><button class="m-display-none@lg m-height_40 m-line-height_40 m-border-style-top_none m-border-style-right_none m-border-style-bottom_none m-border-style-left_none m-border-radius-top-left_2 m-border-radius-top-right_2 m-border-radius-bottom-left_2 m-border-radius-bottom-right_2 m-cursor_pointer m-overflow_hidden m-appearance_none m-padding-left_4 m-padding-right_4 m-padding-top_4 m-padding-bottom_4 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button" style="background:transparent" aria-label="Otwórz menu"><img src="https://assets.allegrostatic.com/metrum/icon/menu-23e046bf68.svg" alt="" class="m-icon" width="32" height="32"/></button></div></nav></header><div class="Header_hero__n5PN5"><div class="m-width-max_1600 m-margin-left_auto m-margin-right_auto m-display-flex m-flex-column m-flex-justify-end Header_image__15JNc"><div class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-bottom_16 m-padding-bottom_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-color-bg_desk"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text  m-font-weight_100 m-font-size_32 m-font-size_43_sm m-margin-bottom_16 m-margin-bottom_24_sm m-line-height_125">O nas</h2><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text">Allegro to jedna z najbardziej zaawansowanych technologicznie firm w naszej części Europy. Allegro to również ponad 1000 specjalistów IT, różnych specjalizacji, rozwijających nasz serwis. Unikatowa skala i złożoność problemów, które rozwiązujemy na co dzień, dają nam możliwość rozwoju przy bardzo różnorodnych projektach. Allegro Tech to miejsce, w którym nasi inżynierowie dzielą się wiedzą oraz case study z wybranych projektów w firmie – w formie artykułów, podcastów oraz eventów.</p></div></div></div><div class="m-width-max_1600 m-margin-left_auto m-margin-right_auto m-padding-top-24"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_300 m-font-size_27 m-font-size_36_sm m-margin-bottom_16 m-margin-bottom_24_sm m-line-height_125 m-padding-left-24 m-padding-right-24">Blog</h2><div class="m-display_flex m-flex-wrap_1 m-flex-grow_1 m-grid"><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--3@xl m-display-flex m-flex-direction_column"><article class="m-margin-bottom_16 m-display-flex m-flex-column m-flex-grow_1"><a href="https://blog.allegro.tech/2021/11/oauth-rate-limiting.html" title="OAuth rate-limiting"><img width="388" src="images/post-headers/default.jpg" alt="OAuth rate-limiting" class="m-display-block m-width-fluid"/></a><div class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-column m-flex-grow_1 m-padding-bottom-0 m-color-bg_card"><a href="https://blog.allegro.tech/2021/11/oauth-rate-limiting.html" title="OAuth rate-limiting" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">OAuth rate-limiting</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-bottom-16">około 9 godzin temu</time><ul class="m-font-family_sans m-font-size_14 m-line-height_21 m-color_text m-text-size-adjust_100p m-list-style-type_none m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-padding-top_0 m-padding-right_0 m-padding-bottom_0 m-padding-left_0"><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/tech">#<!-- -->tech</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/architecture">#<!-- -->architecture</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/oauth">#<!-- -->oauth</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/microservices">#<!-- -->microservices</a></li></ul><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-flex-grow-1 m-padding-top-16">Every e-commerce platform needs some kind of central authorization system. At Allegro we use
OAuth and have our own implementation that stays true to the
RFC. Allegro…</p><div class="m-display-flex m-flex-justify-between m-padding-top-16 m-flex-items_center"><div class="m-display-flex m-flex-items_center"><div class="MuiAvatarGroup-root m-padding-right_16 Post_avatars__1CeVw"><div class="MuiAvatar-root MuiAvatar-circle MuiAvatarGroup-avatar" style="z-index:2"><img alt="Marek Walkowiak" src="https://blog.allegro.tech/img/authors/marek.walkowiak.jpg" class="MuiAvatar-img" width="32" height="32"/></div><div class="MuiAvatar-root MuiAvatar-circle MuiAvatarGroup-avatar" style="z-index:1"><img alt="Daniel Faderski" src="https://blog.allegro.tech/img/authors/daniel.faderski.jpg" class="MuiAvatar-img" width="32" height="32"/></div></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://blog.allegro.tech/authors/marek.walkowiak">Marek Walkowiak…</a></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://blog.allegro.tech/2021/11/oauth-rate-limiting.html#disqus_thread">0 Comments</a></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://blog.allegro.tech/2021/11/oauth-rate-limiting.html">przejdź do wpisu</a></div></article></div><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--3@xl m-display-flex m-flex-direction_column"><article class="m-margin-bottom_16 m-display-flex m-flex-column m-flex-grow_1"><a href="https://blog.allegro.tech/2021/10/refactoring-opbox-search.html" title="How we refactored the search form UI component"><img width="388" src="images/post-headers/default.jpg" alt="How we refactored the search form UI component" class="m-display-block m-width-fluid"/></a><div class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-column m-flex-grow_1 m-padding-bottom-0 m-color-bg_card"><a href="https://blog.allegro.tech/2021/10/refactoring-opbox-search.html" title="How we refactored the search form UI component" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">How we refactored the search form UI component</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-bottom-16">14 dni temu</time><ul class="m-font-family_sans m-font-size_14 m-line-height_21 m-color_text m-text-size-adjust_100p m-list-style-type_none m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-padding-top_0 m-padding-right_0 m-padding-bottom_0 m-padding-left_0"><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/tech">#<!-- -->tech</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/frontend">#<!-- -->frontend</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/architecture">#<!-- -->architecture</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/refactoring">#<!-- -->refactoring</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/developmentexperience">#<!-- -->developmentexperience</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/typescript">#<!-- -->typescript</a></li></ul><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-flex-grow-1 m-padding-top-16">This article describes a classic case of refactoring a search form UI component, a critical part of every e-commerce
platform. In it I’ll explain the precursor…</p><div class="m-display-flex m-flex-justify-between m-padding-top-16 m-flex-items_center"><div class="m-display-flex m-flex-items_center"><div class="MuiAvatarGroup-root m-padding-right_16 Post_avatars__1CeVw"><div class="MuiAvatar-root MuiAvatar-circle MuiAvatarGroup-avatar" style="z-index:1"><img alt="Volodymyr Khytskyi" src="https://blog.allegro.tech/img/authors/volodymyr.khytskyi.jpg" class="MuiAvatar-img" width="32" height="32"/></div></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://blog.allegro.tech/authors/volodymyr.khytskyi">Volodymyr Khytskyi</a></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://blog.allegro.tech/2021/10/refactoring-opbox-search.html#disqus_thread">0 Comments</a></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://blog.allegro.tech/2021/10/refactoring-opbox-search.html">przejdź do wpisu</a></div></article></div><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--3@xl m-display-flex m-flex-direction_column"><article class="m-margin-bottom_16 m-display-flex m-flex-column m-flex-grow_1"><a href="https://blog.allegro.tech/2021/10/comparing-mongodb-composite-indexes.html" title="Comparing MongoDB composite indexes"><img width="388" src="images/post-headers/mongodb.png" alt="Comparing MongoDB composite indexes" class="m-display-block m-width-fluid"/></a><div class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-column m-flex-grow_1 m-padding-bottom-0 m-color-bg_card"><a href="https://blog.allegro.tech/2021/10/comparing-mongodb-composite-indexes.html" title="Comparing MongoDB composite indexes" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">Comparing MongoDB composite indexes</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-bottom-16">22 dni temu</time><ul class="m-font-family_sans m-font-size_14 m-line-height_21 m-color_text m-text-size-adjust_100p m-list-style-type_none m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-padding-top_0 m-padding-right_0 m-padding-bottom_0 m-padding-left_0"><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/tech">#<!-- -->tech</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/mongodb">#<!-- -->mongodb</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/index">#<!-- -->index</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/performance">#<!-- -->performance</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/query tuning">#<!-- -->query tuning</a></li></ul><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-flex-grow-1 m-padding-top-16">One of the key elements ensuring efficient operation of the services we work on every day at
Allegro is fast responses from the database.
We spend a…</p><div class="m-display-flex m-flex-justify-between m-padding-top-16 m-flex-items_center"><div class="m-display-flex m-flex-items_center"><div class="MuiAvatarGroup-root m-padding-right_16 Post_avatars__1CeVw"><div class="MuiAvatar-root MuiAvatar-circle MuiAvatarGroup-avatar" style="z-index:1"><img alt="Michał Knasiecki" src="https://blog.allegro.tech/img/authors/michal.knasiecki.jpg" class="MuiAvatar-img" width="32" height="32"/></div></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://blog.allegro.tech/authors/michal.knasiecki">Michał Knasiecki</a></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://blog.allegro.tech/2021/10/comparing-mongodb-composite-indexes.html#disqus_thread">0 Comments</a></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://blog.allegro.tech/2021/10/comparing-mongodb-composite-indexes.html">przejdź do wpisu</a></div></article></div><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--3@xl m-display-flex m-flex-direction_column"><article class="m-margin-bottom_16 m-display-flex m-flex-column m-flex-grow_1"><a href="https://blog.allegro.tech/2021/10/how-to-ruin-elasticsearch-performance-part-ii.html" title="How to ruin your Elasticsearch performance — Part II: Breaking things, one at a time"><img width="388" src="images/post-headers/default.jpg" alt="How to ruin your Elasticsearch performance — Part II: Breaking things, one at a time" class="m-display-block m-width-fluid"/></a><div class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-column m-flex-grow_1 m-padding-bottom-0 m-color-bg_card"><a href="https://blog.allegro.tech/2021/10/how-to-ruin-elasticsearch-performance-part-ii.html" title="How to ruin your Elasticsearch performance — Part II: Breaking things, one at a time" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">How to ruin your Elasticsearch performance — Part II: Breaking things, one at a time</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-bottom-16">około miesiąc temu</time><ul class="m-font-family_sans m-font-size_14 m-line-height_21 m-color_text m-text-size-adjust_100p m-list-style-type_none m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-padding-top_0 m-padding-right_0 m-padding-bottom_0 m-padding-left_0"><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/tech">#<!-- -->tech</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/full-text search">#<!-- -->full-text search</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/elasticsearch">#<!-- -->elasticsearch</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/elastic">#<!-- -->elastic</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/es">#<!-- -->es</a></li><li class="m-margin-right-8 m-display-inline-block"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/hashtag/performance">#<!-- -->performance</a></li></ul><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-flex-grow-1 m-padding-top-16">It’s easy to find resources about improving Elasticsearch performance, but what if you wanted to reduce it?
In Part I of this two-part series we looked…</p><div class="m-display-flex m-flex-justify-between m-padding-top-16 m-flex-items_center"><div class="m-display-flex m-flex-items_center"><div class="MuiAvatarGroup-root m-padding-right_16 Post_avatars__1CeVw"><div class="MuiAvatar-root MuiAvatar-circle MuiAvatarGroup-avatar" style="z-index:1"><img alt="Michał Kosmulski" src="https://blog.allegro.tech/img/authors/michal.kosmulski.jpg" class="MuiAvatar-img" width="32" height="32"/></div></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://blog.allegro.tech/authors/michal.kosmulski">Michał Kosmulski</a></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://blog.allegro.tech/2021/10/how-to-ruin-elasticsearch-performance-part-ii.html#disqus_thread">0 Comments</a></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://blog.allegro.tech/2021/10/how-to-ruin-elasticsearch-performance-part-ii.html">przejdź do wpisu</a></div></article></div></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-display_block m-margin-bottom_8 m-width_100 m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://blog.allegro.tech">Zobacz więcej wpisów</a></div><div class="m-width-max_1600 m-margin-left_auto m-margin-right_auto m-padding-top-24"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_300 m-font-size_27 m-font-size_36_sm m-margin-bottom_16 m-margin-bottom_24_sm m-line-height_125 m-padding-left-24 m-padding-right-24">Podcasty</h2><div class="m-display_flex m-flex-wrap_1 m-flex-grow_1 m-grid"><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--3@xl m-display-flex m-flex-direction_column"><article class="m-margin-bottom_16 m-display-flex m-flex-column m-flex-grow_1"><a href="https://podcast.allegro.tech/rola_architekta_w_allegro" title="Rola architekta w Allegro"><img src="images/podcast.png" alt="Rola architekta w Allegro" class="m-display-block m-width-fluid"/></a><div class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-column m-flex-grow_1 m-padding-bottom-0 m-color-bg_card"><a href="https://podcast.allegro.tech/rola_architekta_w_allegro" title="Rola architekta w Allegro" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">Rola architekta w Allegro</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-bottom-16">5 miesięcy temu</time><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-flex-grow-1">Od kodowania do tworzenia strategii technicznej... Jak wygląda rola architekta w Allegro? Ile takich osób pracuje w naszej firmie i dlaczego ta rola jest tak różnorodna? Czym jest Andamio i jak rozwijamy naszą platformę – o tym wszystkim opowie Piotr Betkier – Inżynier, Architekt Platformy Technicznej w Allegro oraz twórca piosenek o IT :)</p><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://podcast.allegro.tech/rola_architekta_w_allegro">Posłuchaj odcinka</a></div></article></div><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--3@xl m-display-flex m-flex-direction_column"><article class="m-margin-bottom_16 m-display-flex m-flex-column m-flex-grow_1"><a href="https://podcast.allegro.tech/infrastruktura_Allegro" title="Infrastruktura Allegro"><img src="images/podcast.png" alt="Infrastruktura Allegro" class="m-display-block m-width-fluid"/></a><div class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-column m-flex-grow_1 m-padding-bottom-0 m-color-bg_card"><a href="https://podcast.allegro.tech/infrastruktura_Allegro" title="Infrastruktura Allegro" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">Infrastruktura Allegro</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-bottom-16">5 miesięcy temu</time><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-flex-grow-1">Jak jest zbudowane środowisko uruchomienia aplikacji Allegro? Jak działają serwerownie firmy i ile ich potrzeba, a które elementy Allegro działają w chmurze publicznej? Jak przebiegała transformacja w Allegro i co zmieniało się przez lata? Jak wzrost biznesu wpływa na wielkość infrastruktury i jak infrastruktura Allegro odczuła przyjście pandemii? O tym, a także o rozwoju liderów technologii w Allegro oraz o historii powstania dżingla do naszych podcastów, opowie Piotr Michoński - menadżer Zespołów tworzących infrastrukturę Allegro.</p><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://podcast.allegro.tech/infrastruktura_Allegro">Posłuchaj odcinka</a></div></article></div><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--3@xl m-display-flex m-flex-direction_column"><article class="m-margin-bottom_16 m-display-flex m-flex-column m-flex-grow_1"><a href="https://podcast.allegro.tech/praca_architekta_ekosystemu_big_data_w_Allegro" title="Praca architekta ekosystemu big data w Allegro"><img src="images/podcast.png" alt="Praca architekta ekosystemu big data w Allegro" class="m-display-block m-width-fluid"/></a><div class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-column m-flex-grow_1 m-padding-bottom-0 m-color-bg_card"><a href="https://podcast.allegro.tech/praca_architekta_ekosystemu_big_data_w_Allegro" title="Praca architekta ekosystemu big data w Allegro" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">Praca architekta ekosystemu big data w Allegro</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-bottom-16">6 miesięcy temu</time><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-flex-grow-1">Jak wygląda praca architekta ekosystemu big data w Allegro? Jakie zadania realizuje nasz zespół odpowiedzialny za narzędzia i infrastrukturę dla przetwarzania danych? Kiedy możemy mówić o dużych danych i ile petabajtów przetwarza Allegro? Skąd pochodzą dane Allegro i dlaczego jest ich tak dużo oraz z jakiego powodu dopiero teraz przenosimy się do chmury? O tym wszystkim opowie zdobywca statuetki Allegro Tech Hero - Dariusz Eliasz – Team Manager &amp; Platform Architect w Allegro.</p><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://podcast.allegro.tech/praca_architekta_ekosystemu_big_data_w_Allegro">Posłuchaj odcinka</a></div></article></div><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--3@xl m-display-flex m-flex-direction_column"><article class="m-margin-bottom_16 m-display-flex m-flex-column m-flex-grow_1"><a href="https://podcast.allegro.tech/od_inzyniera_do_lidera_w_allegro" title="Od inżyniera do lidera w Allegro"><img src="images/podcast.png" alt="Od inżyniera do lidera w Allegro" class="m-display-block m-width-fluid"/></a><div class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-column m-flex-grow_1 m-padding-bottom-0 m-color-bg_card"><a href="https://podcast.allegro.tech/od_inzyniera_do_lidera_w_allegro" title="Od inżyniera do lidera w Allegro" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">Od inżyniera do lidera w Allegro</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-bottom-16">6 miesięcy temu</time><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-flex-grow-1">Czym jest Opbox i jakie wyzwania przed nim stoją? Jak w Allegro angażujemy się w rozwój kultury Open Source? Ile mamy projektów na GitHubie i jak świętujemy Hacktoberfest? W jaki sposób można rozwinąć się od inżyniera do lidera? Na te pytania w najnowszym Allegro Tech Podcast odpowie Bartek Gałek, Team Leader w Allegro.</p><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://podcast.allegro.tech/od_inzyniera_do_lidera_w_allegro">Posłuchaj odcinka</a></div></article></div></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-display_block m-margin-bottom_8 m-width_100 m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://podcast.allegro.tech">Zobacz więcej podcastów</a></div><div class="m-width-max_1600 m-margin-left_auto m-margin-right_auto m-padding-top-24"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_300 m-font-size_27 m-font-size_36_sm m-margin-bottom_16 m-margin-bottom_24_sm m-line-height_125 m-padding-left-24 m-padding-right-24">Wydarzenia</h2><div class="m-display_flex m-flex-wrap_1 m-flex-grow_1 m-grid"><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--6@xl m-display-flex m-flex-direction_column"><div class="m-margin-bottom_16 m-display-flex m-flex-direction_column m-flex-direction_row_sm m-padding-bottom_0"><a href="https://www.meetup.com/allegrotech/events/281692274/" title="Allegro Tech Live #23 - Przygody backendowców w C#" class="m-display_none m-display_block_lg" style="background-color:#fd4a02"><img width="218" src="images/event.png" alt="Allegro Tech Live #23 - Przygody backendowców w C#"/></a><article class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-direction_column m-padding-bottom_0 m-flex_1 m-flex-justify_between m-color-bg_card"><a href="https://www.meetup.com/allegrotech/events/281692274/" title="Allegro Tech Live #23 - Przygody backendowców w C#" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">Allegro Tech Live #23 - Przygody backendowców w C#</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text">5 dni temu</time><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-top-8">------ Rejestracja: https://app.evenea.pl/event/allegro-tech-live-23/------- Allegro Tech Live to w 100% zdalna odsłona naszych stacjonarnych meetupów Allegro Tech Talks. Kiedyś spotykaliśmy się w naszych biurach, a teraz…</time><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://www.meetup.com/allegrotech/events/281692274/">Szczegóły</a></article></div></div><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--6@xl m-display-flex m-flex-direction_column"><div class="m-margin-bottom_16 m-display-flex m-flex-direction_column m-flex-direction_row_sm m-padding-bottom_0"><a href="https://www.meetup.com/allegrotech/events/281441586/" title="Allegro Tech Live #22 - Jak wygląda codzienność lidera w Allegro?" class="m-display_none m-display_block_lg" style="background-color:#fd4a02"><img width="218" src="images/event.png" alt="Allegro Tech Live #22 - Jak wygląda codzienność lidera w Allegro?"/></a><article class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-direction_column m-padding-bottom_0 m-flex_1 m-flex-justify_between m-color-bg_card"><a href="https://www.meetup.com/allegrotech/events/281441586/" title="Allegro Tech Live #22 - Jak wygląda codzienność lidera w Allegro?" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">Allegro Tech Live #22 - Jak wygląda codzienność lidera w Allegro?</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text">19 dni temu<!-- -->, Online event</time><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-top-8">!!!! Rejestracja: https://app.evenea.pl/event/allegro-tech-live-22/ !!!! Allegro Tech Live to w 100% zdalna odsłona naszych stacjonarnych meetupów Allegro Tech Talks. Zazwyczaj spotykaliśmy się w naszych biurach, ale…</time><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://www.meetup.com/allegrotech/events/281441586/">Szczegóły</a></article></div></div><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--6@xl m-display-flex m-flex-direction_column"><div class="m-margin-bottom_16 m-display-flex m-flex-direction_column m-flex-direction_row_sm m-padding-bottom_0"><a href="https://www.meetup.com/allegrotech/events/281199452/" title="Allegro Tech Live #21 - Jak zautomatyzować bezpieczeństwo IT?" class="m-display_none m-display_block_lg" style="background-color:#fd4a02"><img width="218" src="images/event.png" alt="Allegro Tech Live #21 - Jak zautomatyzować bezpieczeństwo IT?"/></a><article class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-direction_column m-padding-bottom_0 m-flex_1 m-flex-justify_between m-color-bg_card"><a href="https://www.meetup.com/allegrotech/events/281199452/" title="Allegro Tech Live #21 - Jak zautomatyzować bezpieczeństwo IT?" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">Allegro Tech Live #21 - Jak zautomatyzować bezpieczeństwo IT?</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text">około miesiąc temu</time><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-top-8">Allegro Tech Live to w 100% zdalna odsłona naszych stacjonarnych meetupów Allegro Tech Talks. Zazwyczaj spotykaliśmy się w naszych biurach, ale tym razem to my…</time><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://www.meetup.com/allegrotech/events/281199452/">Szczegóły</a></article></div></div><div class="m-grid__col m-grid__col--12 m-grid__col--6@sm m-grid__col--6@xl m-display-flex m-flex-direction_column"><div class="m-margin-bottom_16 m-display-flex m-flex-direction_column m-flex-direction_row_sm m-padding-bottom_0"><a href="https://www.meetup.com/allegrotech/events/280149404/" title="Allegro Tech Meeting 2021" class="m-display_none m-display_block_lg" style="background-color:#fd4a02"><img width="218" src="images/event.png" alt="Allegro Tech Meeting 2021"/></a><article class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-display-flex m-flex-direction_column m-padding-bottom_0 m-flex_1 m-flex-justify_between m-color-bg_card"><a href="https://www.meetup.com/allegrotech/events/280149404/" title="Allegro Tech Meeting 2021" class="m-text-decoration_none"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm" style="text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;min-height:2em;overflow:hidden">Allegro Tech Meeting 2021</h2></a><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text">około miesiąc temu<!-- -->, Online event</time><time class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-padding-top-8">❗Uwaga, aby wziąć udział w wydarzeniu zarejestruj się tutaj: https://app.evenea.pl/event/atm-2021/ ❗ Allegro to jedna z najbardziej zaawansowanych technologicznie firm w naszej części Europy. Allegro to…</time><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-margin-top-16 m-display_block m-border-width_1 m-border-color_gray m-border-style-top_solid m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://www.meetup.com/allegrotech/events/280149404/">Szczegóły</a></article></div></div></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-display_block m-margin-bottom_8 m-width_100 m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://www.meetup.com/allegrotech/events/">Zobacz więcej wydarzeń</a></div><div class="m-width-max_1600 m-margin-left_auto m-margin-right_auto m-padding-top-24"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_300 m-font-size_27 m-font-size_36_sm m-margin-bottom_16 m-margin-bottom_24_sm m-line-height_125 m-padding-left-24 m-padding-right-24">Oferty pracy</h2><div class="m-width-max_1600 m-margin-left_auto m-margin-right_auto"><article class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-bottom_16 m-padding-bottom_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-margin-bottom_16 m-display-flex m-flex-justify_between m-flex-items-center m-flex-direction_column m-flex-direction_row_md m-color-bg_card"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm m-margin-bottom_0_sm m-flex-grow_1">Research Engineer - Machine Learning (Reinforcement Learning)</h2><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-font-size_21 m-font-size_25_sm m-font-weight_300 m-line-height_normal m-margin-top_16 m-text-align_left m-padding-right_16">Warszawa, Kraków, Poznań, Toruń, Wrocław, Gdańsk, Katowice, Łódź, Lublin</p><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://www.smartrecruiters.com/Allegro/743999785422127-research-engineer-machine-learning-reinforcement-learning?trid=de9dfdf3-7f9e-4ebf-8a64-49f6c69ad640">Sprawdź</a></article><article class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-bottom_16 m-padding-bottom_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-margin-bottom_16 m-display-flex m-flex-justify_between m-flex-items-center m-flex-direction_column m-flex-direction_row_md m-color-bg_card"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm m-margin-bottom_0_sm m-flex-grow_1">Research Engineer - Machine Learning (Ranking and Recommendations)</h2><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-font-size_21 m-font-size_25_sm m-font-weight_300 m-line-height_normal m-margin-top_16 m-text-align_left m-padding-right_16">Warszawa, Poznań, Kraków, Toruń, Wrocław, Gdańsk, Katowice, Łódź, Lublin</p><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://www.smartrecruiters.com/Allegro/743999785421861-research-engineer-machine-learning-ranking-and-recommendations?trid=de9dfdf3-7f9e-4ebf-8a64-49f6c69ad640">Sprawdź</a></article><article class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-bottom_16 m-padding-bottom_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-margin-bottom_16 m-display-flex m-flex-justify_between m-flex-items-center m-flex-direction_column m-flex-direction_row_md m-color-bg_card"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm m-margin-bottom_0_sm m-flex-grow_1">IT Security Specialist</h2><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-font-size_21 m-font-size_25_sm m-font-weight_300 m-line-height_normal m-margin-top_16 m-text-align_left m-padding-right_16">Warszawa, Poznań, Kraków, Wrocław, Toruń, Gdańsk, Lublin, Łódź, Katowice</p><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://www.smartrecruiters.com/Allegro/743999782019147-it-security-specialist?trid=de9dfdf3-7f9e-4ebf-8a64-49f6c69ad640">Sprawdź</a></article><article class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-bottom_16 m-padding-bottom_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-margin-bottom_16 m-display-flex m-flex-justify_between m-flex-items-center m-flex-direction_column m-flex-direction_row_md m-color-bg_card"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm m-margin-bottom_0_sm m-flex-grow_1">Chief Architect</h2><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-font-size_21 m-font-size_25_sm m-font-weight_300 m-line-height_normal m-margin-top_16 m-text-align_left m-padding-right_16">Warszawa, Kraków, Poznań, Toruń, Gdańsk, Łódź, Katowice, Lublin</p><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://www.smartrecruiters.com/Allegro/743999779485268-chief-architect?trid=de9dfdf3-7f9e-4ebf-8a64-49f6c69ad640">Sprawdź</a></article><article class="m-padding-top_16 m-padding-top_24_lg m-padding-right_16 m-padding-right_24_lg m-padding-bottom_16 m-padding-bottom_24_lg m-padding-left_16 m-padding-left_24_lg m-card m-margin-bottom_16 m-display-flex m-flex-justify_between m-flex-items-center m-flex-direction_column m-flex-direction_row_md m-color-bg_card"><h2 class="m-font-family_roboto m-margin-left_0 m-margin-right_0 m-margin-top_0 m-color_text m-font-weight_500 m-line-height_130 m-margin-bottom_8 m-margin-bottom_16_sm m-font-size_21 m-font-size_25_sm m-margin-bottom_0_sm m-flex-grow_1">Research Engineer - Machine Learning (Reinforcement Learning)</h2><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-font-size_21 m-font-size_25_sm m-font-weight_300 m-line-height_normal m-margin-top_16 m-text-align_left m-padding-right_16">Warszawa, Kraków, Poznań, Toruń, Wrocław, Gdańsk, Katowice, Łódź, Lublin</p><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://www.smartrecruiters.com/Allegro/743999779448775-research-engineer-machine-learning-reinforcement-learning?trid=de9dfdf3-7f9e-4ebf-8a64-49f6c69ad640">Sprawdź</a></article></div><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-display_block m-margin-bottom_8 m-width_100 m-height_40 m-line-height_40 m-text-transform_uppercase m-letter-spacing_2 m-white-space_nowrap m-cursor_pointer m-overflow_hidden m-padding-left_16 m-padding-right_16 m-padding-top_0 m-padding-bottom_0 m-outline-style_dotted--focus m-outline-width_2 m-outline-color_teal m-outline-offset_n2 m-button m-box_border m-text-align_center m-display_inline-block m-color_secondary m-background-position_50p m-background-size_5000p m-transition-property_background-color m-transition-duration_fast m-button--secondary" href="https://allegro.pl/praca">Zobacz więcej ofert</a></div><footer class="m-color-bg_navy m-margin-top-32"><div class="m-width-max_1600 m-margin-left_auto m-margin-right_auto m-padding-top-24 m-padding-bottom-24 m-display-flex@sm m-flex-justify-between m-flex-items-center m-text-align_center"><p class="m-font-family_sans m-line-height_21 m-font-size_14 m-text-size-adjust_100p m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-color_text m-color_white m-padding-left-24@sm">Proudly built by Allegro Tech engineers</p><ul class="m-font-family_sans m-font-size_14 m-line-height_21 m-color_text m-text-size-adjust_100p m-list-style-type_none m-margin-top_0 m-margin-right_0 m-margin-bottom_0 m-margin-left_0 m-padding-top_0 m-padding-right_0 m-padding-bottom_0 m-padding-left_0 m-display-flex m-flex-justify-center"><li style="filter:brightness(0) invert(1);opacity:0.5" class="m-margin-right-8 m-margin-top-16 m-margin-top-0@sm m-color_white"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://github.com/allegro"><img src="https://assets.allegrostatic.com/metrum/icon/github-6a18df1729.svg" alt="Github" class="m-icon"/></a></li><li style="filter:brightness(0) invert(1);opacity:0.5" class="m-margin-right-8 m-margin-top-16 m-margin-top-0@sm m-color_white"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://www.facebook.com/allegro.tech/"><img src="https://assets.allegrostatic.com/metrum/icon/facebook-a2b92f9dcb.svg" alt="Facebook" class="m-icon"/></a></li><li style="filter:brightness(0) invert(1);opacity:0.5" class="m-margin-right-8 m-margin-top-16 m-margin-top-0@sm m-color_white"><a class="m-font-size_14 m-font-family_sans m-color_text m-text-decoration_none m-text-size-adjust_100p m-cursor_pointer m-link m-line-height_21" href="https://twitter.com/allegrotech"><img src="https://assets.allegrostatic.com/metrum/icon/twitter-25164a58aa.svg" alt="Twitter" class="m-icon"/></a></li></ul></div></footer><div style="visibility:hidden;height:0;overflow:hidden;position:relative"><img alt="doubleclick" width="1" height="1" style="position:absolute" src="https://pubads.g.doubleclick.net/activity;dc_iu=/21612525419/DFPAudiencePixel;ord=7997130804839.278;dc_seg=507368552?"/><img alt="fb" height="1" width="1" style="position:absolute" src="https://www.facebook.com/tr?id=1650870088530325&amp;ev=PageView&amp;noscript=1"/></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"posts":[{"title":"OAuth rate-limiting","link":"https://blog.allegro.tech/2021/11/oauth-rate-limiting.html","pubDate":"Tue, 09 Nov 2021 00:00:00 +0100","authors":{"author":[{"name":["Marek Walkowiak"],"photo":["https://blog.allegro.tech/img/authors/marek.walkowiak.jpg"],"url":["https://blog.allegro.tech/authors/marek.walkowiak"]},{"name":["Daniel Faderski"],"photo":["https://blog.allegro.tech/img/authors/daniel.faderski.jpg"],"url":["https://blog.allegro.tech/authors/daniel.faderski"]}]},"content":"\u003cp\u003eEvery e-commerce platform needs some kind of central authorization system. At \u003ca href=\"https://allegro.tech/\"\u003eAllegro\u003c/a\u003e we use\nOAuth and have our own implementation that stays true to the\n\u003ca href=\"https://datatracker.ietf.org/doc/html/rfc6749\"\u003eRFC\u003c/a\u003e. Allegro has millions of users. There are also a lot of requests\nthat go through OAuth services. At some point there comes a need to have better control over how much traffic we want to\nallow in a certain time window, while maintaining full performance of the platform. Here is where the idea of\nrate-limiting comes in handy.\u003c/p\u003e\n\n\u003ch2 id=\"prologue\"\u003ePrologue\u003c/h2\u003e\n\n\u003cp\u003eAccording to OAuth RFC, to use OAuth you need to be a registered client. Some clients are very small external\nintegrators (simple shops), while others are in a different league and can produce millions of requests per day (Allegro\nmobile and other large partner apps). Every user can create their own OAuth client and use it to integrate with\nDevelopers API. Unfortunately, not all of them do that correctly as per RFC.\u003c/p\u003e\n\n\u003cp\u003eNormally such clients are not a big issue, but in certain cases they can generate a lot of unwanted and unneeded\ntraffic. This traffic includes, but is not limited to, creating huge numbers of new access tokens that are then thrown\naway instead of being reused.\u003c/p\u003e\n\n\u003cp\u003eAccording to the RFC, the access tokens generated with most grant types (e.g. authorization code grant) should be reused\nup until their expiration period. When they expire, the\nprovided \u003ca href=\"https://datatracker.ietf.org/doc/html/rfc6749#section-1.5\"\u003erefresh token\u003c/a\u003e should be used to receive a new\naccess token via refresh token grant.\u003c/p\u003e\n\n\u003cp\u003eSome of the clients rarely refresh tokens or even don’t reuse them at all. This causes a lot of unnecessary traffic (\noften in the form of sudden spikes)\nthat can lead to potential issues on both sides. We had pretty good monitoring of this issue, but we needed better tools\nto deal with that problem as well as to educate the clients to make proper use of OAuth.\u003c/p\u003e\n\n\u003ch2 id=\"planning-the-solution\"\u003ePlanning the solution\u003c/h2\u003e\n\n\u003cp\u003eBefore tackling the problem directly we needed a little more information and careful planning. Firstly, we wanted to\nmake sure that our solution would solve the problem. Secondly, blocking too many clients could end up in disaster. To be\ncertain that our solution was error-free, we started by making sure that we knew what we want to achieve. Here are the\nproperties we expected from our solution:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eIt cannot block trusted clients such as Allegro apps.\u003c/li\u003e\n  \u003cli\u003eIt should not negatively affect performance.\u003c/li\u003e\n  \u003cli\u003eIt should be configurable per client since different clients have different traffic characteristics.\u003c/li\u003e\n  \u003cli\u003eIt should be able to distinguish between user and non-user use of OAuth. Client credentials grant used without context\nof a user, for example should be treated differently than user-based authorization code grant. In effect, the limiting\n“per user” should be introduced in the second case.\u003c/li\u003e\n  \u003cli\u003eIt should directly cause an improvement in traffic spikes.\u003c/li\u003e\n  \u003cli\u003eIt should work well in a highly distributed environment with dozens of service instances and database nodes.\u003c/li\u003e\n  \u003cli\u003eIt cannot be too costly or require too much additional infrastructure like additional databases, external systems,\netc.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"tackling-the-problem\"\u003eTackling the problem\u003c/h2\u003e\n\n\u003cp\u003eTo meet those needs we needed a robust solution. Since RFC leaves a lot of room for implementation by end-users, it does\nnot specify how such rate-limiting should work.\u003c/p\u003e\n\n\u003cp\u003eAs with every problem of such kind, it’s worth starting with in-depth research of existing solutions. There are various\nstrategies and approaches to this problem in many different scenarios, but only a few of them were applicable to our\ncase and enabled us to fulfill our goals.\u003c/p\u003e\n\n\u003cp\u003eAs usual, we also explored the existing implementations of such solutions in the form of enterprise or open-source\nlibraries and frameworks. Unfortunately, we did not find any that would meet all of our needs and at the same time be\nflexible enough to easily integrate into our ecosystem. It’s also worth noting that we were limited by certain\nconstraints such as long-term costs of additional resources.\u003c/p\u003e\n\n\u003cp\u003eIn the end, we decided to go with implementing our own solution. There were several algorithms to choose from that could\nserve as its base:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003ePrecise query-based per-user counter — query the database for a token count for each request. Not suitable, because\nit would cause way too much database traffic.\u003c/li\u003e\n  \u003cli\u003eFixed window based on TTL documents — uses a rate-limit counter that is cleared every fixed period. While less\nchallenging for the database, it shares a common vulnerability with the first algorithm: sudden TTL-caused spikes in\nallowed requests that consequently cause all of the following requests to be blocked (rate-limit exhaustion).\u003c/li\u003e\n  \u003cli\u003eSliding window log — stores all requests as a timestamped log entry in a database, that are later aggregated when\nneeded. Too costly, because again it would cause too heavy a load on the database.\u003c/li\u003e\n  \u003cli\u003eSliding window — uses a rate-limit counter that is a time-based weighted moving window. It has the advantage of\nrelatively low database load of the fixed window algorithm without its spike-related flaws.\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eWe carefully weighed the pros and cons of each of those options and finally decided to make a PoC of the fourth option:\nthe sliding window algorithm.\u003c/p\u003e\n\n\u003cp\u003eThe algorithm is based on counters that each hold a count of requests in their respective time frames. At each point of\ntime, an abstract window is calculated from two neighboring frames: current and previous. The further away the window is\nfrom the previous frame, the more important the counter from the current frame is. The weight is based strictly on\nproportions. If, for example, the span of the current window is 75% of the previous frame and 25% of the current frame,\nthen the value of the current rate-limit counter is a sum of 75% of the previous frame counter and 25% of the current\nframe counter. The results are put into a hashmap with users as keys and counters as values, which acts as a cache.\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-11-09-oauth-rate-limiting/sliding-window-algorithm.png\" alt=\"Sliding window algorithm\" /\u003e\nIn the picture above the current counter value would be:\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003evalue = previousCounter * partOfPreviousFrame + currentCounter * partOfCurrentFrame\nvalue = 12 * 0.75 + 5 * 0.25 = 10.25\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThe time complexity of the sliding window algorithm is O(1) since it’s a simple hashmap get operation, while its space\ncomplexity is O(n) where n is the number of user counters held by an instance. It works well in distributed systems\nbecause it’s based on simple counters that are relatively easy to synchronize. Its cost is low since we only need to\nstore simple counters and can easily minimize database queries, as well as improve performance with caching in a\nstraightforward manner. Thanks to the fact that the sliding window takes into account the time relative to the current\ntimestamp, we can flatten the token creation spikes. Its main disadvantage is that it indirectly relies on the even\ndistribution of requests in time, which makes it less sensitive to spike traffic within one time window.\u003c/p\u003e\n\n\u003ch2 id=\"following-the-plan\"\u003eFollowing the plan\u003c/h2\u003e\n\n\u003ch3 id=\"remote-state-synchronization\"\u003eRemote state synchronization\u003c/h3\u003e\n\n\u003cp\u003eThere are two kinds of states that need to be tracked for the rate-limiting to work. The first one is the global state.\nIt’s basically a global counter of all requests made by a client to rate-limited OAuth endpoints within a certain\nperiod. This state is persisted in the database and from its perspective represents the most recent rate-limit status.\u003c/p\u003e\n\n\u003cp\u003eThe second type is the local state of each instance, one part of which is the local counter of incoming requests for a\nclient within a time window. Since instances are not directly connected to the client and every one of them can make\nrequests to different instances concurrently, the local counter of each instance for that client will most probably have\na different value. Rate-limiting is a global functionality in the sense that we are interested in the value of global\ncounters and not of individual counters. Consider the following scenario: we would like to set a rate limit of 50 RPS\nfor a client while having 10 instances. If we relied only on local counters to do the rate-limiting, it would be\npossible for the traffic of 500 RPS to be split evenly between instances and not trigger rate-limiting - and that’s not\nthe result we are aiming for.\u003c/p\u003e\n\n\u003cp\u003eTo decide whether to reject an incoming request or not, the local instance needs a second part of the state - a global\ncounter. When making a decision, it sums both the local and the global ones to check whether new requests would go\nbeyond the rate-limit boundaries.\u003c/p\u003e\n\n\u003cp\u003eConsequently, the instances need to be aware of the requests made to the others and for that to work, the global counter\nneeds to be updated regularly. Each instance will periodically try to flush the sum of global and local counters from\ntheir state to the database. Here is where things get tricky. If several instances are trying to save different global\ncounters, there is a risk that one of them will attempt to overwrite the changes that were just saved by the other. To\ncounter that, we use a mechanism called optimistic locking that is\ndescribed \u003ca href=\"#resolving-the-conflicts\"\u003elater in this post\u003c/a\u003e. Once the state is persisted successfully, the local state is\ncleared. At this point, it consists of the incoming requests counter that is equal to 0 and the global snapshot counter\nthat is equal to the value persisted in the database for that client.\u003c/p\u003e\n\n\u003ch3 id=\"caching-clients-global-state\"\u003eCaching clients’ global state\u003c/h3\u003e\n\n\u003cp\u003eAny instance should be aware of the rate limit state for the whole cluster. It represents the global number of requests\nmade by a particular client and its users. We keep a mapping between a pair (client_id, username) and the number of\nrequests made in memory, which makes our algorithm efficient. There is one caveat: keeping all the clients and their\nusers would take too much space, so we only keep those clients and users who are actively making requests to the OAuth\nserver. As soon as they stop calling our servers we delete them from the instance’s cache.\u003c/p\u003e\n\n\u003ch3 id=\"sharing-the-state\"\u003eSharing the state\u003c/h3\u003e\n\n\u003cp\u003eOur internal OAuth service works in a distributed manner. There are many instances of the OAuth servers and we should\nhave mechanisms to coordinate rate-limiting between them. In practice, it means that if a client is making a request to\nserver instance A, the server instance B should consider it when calculating the allowed number of requests in the\ncurrent time window. Below are the key points that sum up this description:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eWe have a global request counter per each client/user.\u003c/li\u003e\n  \u003cli\u003eThe counter is stored in the Mongo database.\u003c/li\u003e\n  \u003cli\u003eEach instance shares the counter - it reads and writes its current value.\u003c/li\u003e\n  \u003cli\u003eThe counter depicts the window in the current timestamp.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"_id\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"clientId\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"some-client\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"username\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"some-user\"\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"version\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003eNumberLong(\u003c/span\u003e\u003cspan class=\"mi\"\u003e405\u003c/span\u003e\u003cspan class=\"err\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"expire\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003eISODate(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\"2021-05-29T14:24:01.376Z\"\u003c/span\u003e\u003cspan class=\"err\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"requestCounters\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"1622211780\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"1622211840\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThe counter consists of a few fields:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e_id\u003c/code\u003e - to uniquely identify the client and the user connected with the request.\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eversion\u003c/code\u003e - for the optimistic locking purposes.\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eexpire\u003c/code\u003e - used to remove the counter if it has no updates, which means that the client is not currently creating new\ntokens.\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003erequestCounters\u003c/code\u003e - mapping of the number of requests at consecutive points in time.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eThe counter is cached so we don’t have to fetch it each time the request from the client is made, since it would kill\nperformance. Each instance refreshes the counter asynchronously - reads and writes to the Mongo database are made in a\ndedicated thread. Each one also holds the counters only for the clients they have to handle. A particular instance\nremoves the client’s state after it stops sending requests.\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-11-09-oauth-rate-limiting/sharing-the-state.png\" alt=\"Sharing the state example\" /\u003e\n\u003cimg src=\"/img/articles/2021-11-09-oauth-rate-limiting/sharing-the-state-table.png\" alt=\"Sharing the state example table\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eThis table depicts an example flow of counters on two instances (A, B) of our OAuth service. Each of them has its own\ncounter\n(accordingly \u003cstrong\u003ecnt1\u003c/strong\u003e and \u003cstrong\u003ecnt2\u003c/strong\u003e), \u003cstrong\u003emng\u003c/strong\u003e is a state in the sharded Mongo database and \u003cstrong\u003etotal req\u003c/strong\u003e is the sum of\nall requests made to all instances.\u003c/p\u003e\n\n\u003cp\u003eThe state of each instance consists of two counters (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eg\u003c/code\u003e / \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ei\u003c/code\u003e). The first one (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eg\u003c/code\u003e for “global”) describes how many\nrequests have been globally made and are persisted in the database. The second one tracks how many requests have come to\nthat instance since the last flush (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ei\u003c/code\u003e for “in-flight”). The total number of requests from its perspective is the sum\nof \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eg\u003c/code\u003e and \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ei\u003c/code\u003e and it is the value that is going to be persisted.\u003c/p\u003e\n\n\u003cp\u003eBelow is the description of what happens in this scenario, step by step:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eThere is an initial state with no requests made to either instance.\u003c/li\u003e\n  \u003cli\u003eOne request is made to instance A and its i\u003csub\u003eA\u003c/sub\u003e counter is increased to 1.\u003c/li\u003e\n  \u003cli\u003eNext, instance A pushes its total counter to the database, setting its \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eg\u003c/code\u003e counter to 1 and its \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ei\u003c/code\u003e counter to 0.\u003c/li\u003e\n  \u003cli\u003eInstance B periodically pulls the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eg\u003c/code\u003e counter from the database. Now, the new counter is pulled and the instance’s\ncurrent state is \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eg\u003c/code\u003e = 1, i\u003csub\u003eB\u003c/sub\u003e = 0.\u003c/li\u003e\n  \u003cli\u003eNext, instance A receives one request, and at the same time, instance B receives three requests. At this time\ninstance A knows of 2 requests, 1 of which came since the last flush. Instance B knows of 4 requests, 3 of them came\nsince the last flush.\u003c/li\u003e\n  \u003cli\u003eInstance B pushes its total counter (3+1=4) to Mongo. As a consequence, its state is set to (4 / 0). Instance A has\nnot yet flushed its counter to persistent storage. Remember that both instances do it independently whenever a fixed\ninterval passes.\u003c/li\u003e\n  \u003cli\u003eNow, Instance A tries to push its state (1+1=2) to the database. If the push was successful, it would overwrite the\nstate previously written by the instance B (in step 5), resulting in data loss. We want our counters to be precise so\nwe need to use optimistic locking here. It causes the push to fail, if the version of its state differs from the\nversion persisted in the database. If that scenario occurs, the instance knows that it should refresh its global\ncounter before trying to save it again.\u003c/li\u003e\n  \u003cli\u003eInstance A refreshed its state. It is now equal to (4/1), which means 4 requests are persisted in the database and 1\nthat has not been flushed yet. Now it can safely push its total counter (4+1=5) to the database and set its state\nto (5/0).\u003c/li\u003e\n  \u003cli\u003eAt this point both instances have pushed their state to the database. Notice, however, that instance B has not yet\npulled the counter written by instance B in the previous step.\u003c/li\u003e\n  \u003cli\u003eAfter the last pull, the counter states on both instances are consistent with the database state and reflect the\nglobal number of requests made by a client.\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch3 id=\"persisting-the-state\"\u003ePersisting the state\u003c/h3\u003e\n\n\u003cp\u003eTo properly persist the state in a distributed environment with minimal impact on application performance, we needed to\ntake several strategies into consideration.\u003c/p\u003e\n\n\u003ch4 id=\"resolving-the-conflicts\"\u003eResolving the conflicts\u003c/h4\u003e\n\n\u003cp\u003eAs we’ve already mentioned we use optimistic locking to prevent the state from being overwritten by the different\ninstances. It’s quite a common problem in a the world of distributed systems. It works by using version numbers kept in\nMongoDB, which designates how many updates have been made from the beginning of its creation. After each update the\nversion increases by one.\u003c/p\u003e\n\n\u003cp\u003eBefore save to the database:\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n   \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"_id\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"err\"\u003e...\u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\u003cspan class=\"w\"\u003e\n   \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"version\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n   \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"requestCount\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n   \u003c/span\u003e\u003cspan class=\"err\"\u003e...\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eAfter the save:\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n   \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"_id\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"err\"\u003e...\u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\u003cspan class=\"w\"\u003e\n   \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"version\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n   \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"requestCount\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n   \u003c/span\u003e\u003cspan class=\"err\"\u003e...\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eBut how does a particular instance save the document atomically? How does it know that there was an update made by\nanother instance in the meantime? For this purpose, we use a Mongo query to do\nthe \u003ca href=\"https://en.wikipedia.org/wiki/Compare-and-swap\"\u003eCAS\u003c/a\u003e update that looks like:\u003c/p\u003e\n\n\u003cdiv class=\"language-js highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\n\u003cspan class=\"nx\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eratelimits\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eupdate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nx\"\u003efilter\u003c/span\u003e \u003cspan class=\"nx\"\u003equery\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\n \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nx\"\u003eupdate\u003c/span\u003e \u003cspan class=\"nx\"\u003eoperation\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"nx\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eratelimits\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eupdate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n   \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003e_id\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{...},\u003c/span\u003e\n   \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eversion\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n   \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eversion\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n   \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003erequestCount\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"mi\"\u003e10\u003c/span\u003e\n \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eIf the query returns 0 elements updated we know there was a collision and there was a concurrent save which changed the\nstate. If this happens we need to:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eUpdate state from database to local instance,\u003c/li\u003e\n  \u003cli\u003eApply inflight recorded changes (the ones not yet persisted to the database),\u003c/li\u003e\n  \u003cli\u003eSave the state,\u003c/li\u003e\n  \u003cli\u003eIf the query returns 1 element updated, the save was successful without any collisions,\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch4 id=\"saving-in-batches\"\u003eSaving in batches\u003c/h4\u003e\n\n\u003cp\u003eAs we already mentioned, a single instance of the OAuth server handles many clients. So it has to synchronize the state\nfor each of them. Doing the above save operation for each client individually would cause a massive number of queries\nand would quickly saturate our resources. That’s why we\nuse \u003ca href=\"https://docs.mongodb.com/manual/core/bulk-write-operations/#bulk-write-operations\"\u003eMongo bulk operations\u003c/a\u003e. They\nallow defining many operations in a single query.\u003c/p\u003e\n\n\u003ch2 id=\"going-into-production\"\u003eGoing into production\u003c/h2\u003e\n\n\u003ch3 id=\"dry-run\"\u003eDry-run\u003c/h3\u003e\n\n\u003cp\u003eBefore actually blocking the clients we needed a way to check real outputs from our solution. We implemented the dry-run\nmode, which enabled us do this without affecting any clients, while also giving us metrics depicting which of them would\nbe blocked given a particular limit and time window. We took the following steps:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eSet high rate limit up to the point when no clients would be blocked (running in dry-run mode all the time).\u003c/li\u003e\n  \u003cli\u003eLowered the threshold to the point that showed us the outstanding clients, while not blocking the others.\u003c/li\u003e\n  \u003cli\u003eCommunicated with clients abusing our future rate limit policy and gave them a chance to optimize the way they use\nthe OAuth server.\u003c/li\u003e\n  \u003cli\u003eSwitched modes from dry-run to actively blocking the clients.\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch3 id=\"canary-deployment\"\u003eCanary deployment\u003c/h3\u003e\n\n\u003cp\u003eIt would be risky to deploy this kind of feature to the whole OAuth cluster without ensuring it’s properly working on a\nfew instances. We used canary deployment which allows deploying a version of a service to only a few production\ninstances. During this deployment, we monitored CPU usage and response time metrics. After ensuring there was meaningful\ndisparity we rolled out the full feature to all production instances.\u003c/p\u003e\n\n\u003ch3 id=\"observability\"\u003eObservability\u003c/h3\u003e\n\n\u003cp\u003eTo monitor and verify our solution we needed a bunch of metrics telling us how many clients were affected by rate limit\npolicy and which of them are getting closer to being blocked. In practice, two charts shown below were enough to monitor\ntheir behaviour:\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-11-09-oauth-rate-limiting/ratelimit-denied-rate.png\" alt=\"Ratelimit Denied Rate\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eThis chart shows clients and their blocked rate. Each color depicts a different blocked client.\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-11-09-oauth-rate-limiting/ratelimit-allowed-rate.png\" alt=\"Ratelimit Allowed Rate\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eThis one on the other hand depicts the allowed rate. The limit line is helpful to see if any client is getting closer to\nit and will be blocked soon. It’s worth mentioning that the default rate limit policy isn’t sufficient for all of the\nclients. Some of them require special treatment and for them we can configure different thresholds, which is why a few\nof them go beyond the actual default limit (the red line).\u003c/p\u003e\n\n\u003ch2 id=\"conclusion\"\u003eConclusion\u003c/h2\u003e\n\n\u003cp\u003eRate-limiting is a common problem, but surprisingly not so trivial to solve, especially in a high-scale, distributed\nenvironment. Plenty of popular solutions can be found, but most of them deal with it only from a perspective of a single\nmachine and were not well-suited for our system. Coming up with the above approach took quite a bit of research and\nplanning, but in the end, its deployment allowed us to effectively achieve our goal. We are pretty content with the\nfinal product, as it is both effective and fast, but are constantly tweaking it and looking for new ways to optimize\nthat process.\u003c/p\u003e\n","contentSnippet":"Every e-commerce platform needs some kind of central authorization system. At Allegro we use\nOAuth and have our own implementation that stays true to the\nRFC. Allegro has millions of users. There are also a lot of requests\nthat go through OAuth services. At some point there comes a need to have better control over how much traffic we want to\nallow in a certain time window, while maintaining full performance of the platform. Here is where the idea of\nrate-limiting comes in handy.\nPrologue\nAccording to OAuth RFC, to use OAuth you need to be a registered client. Some clients are very small external\nintegrators (simple shops), while others are in a different league and can produce millions of requests per day (Allegro\nmobile and other large partner apps). Every user can create their own OAuth client and use it to integrate with\nDevelopers API. Unfortunately, not all of them do that correctly as per RFC.\nNormally such clients are not a big issue, but in certain cases they can generate a lot of unwanted and unneeded\ntraffic. This traffic includes, but is not limited to, creating huge numbers of new access tokens that are then thrown\naway instead of being reused.\nAccording to the RFC, the access tokens generated with most grant types (e.g. authorization code grant) should be reused\nup until their expiration period. When they expire, the\nprovided refresh token should be used to receive a new\naccess token via refresh token grant.\nSome of the clients rarely refresh tokens or even don’t reuse them at all. This causes a lot of unnecessary traffic (\noften in the form of sudden spikes)\nthat can lead to potential issues on both sides. We had pretty good monitoring of this issue, but we needed better tools\nto deal with that problem as well as to educate the clients to make proper use of OAuth.\nPlanning the solution\nBefore tackling the problem directly we needed a little more information and careful planning. Firstly, we wanted to\nmake sure that our solution would solve the problem. Secondly, blocking too many clients could end up in disaster. To be\ncertain that our solution was error-free, we started by making sure that we knew what we want to achieve. Here are the\nproperties we expected from our solution:\nIt cannot block trusted clients such as Allegro apps.\nIt should not negatively affect performance.\nIt should be configurable per client since different clients have different traffic characteristics.\nIt should be able to distinguish between user and non-user use of OAuth. Client credentials grant used without context\nof a user, for example should be treated differently than user-based authorization code grant. In effect, the limiting\n“per user” should be introduced in the second case.\nIt should directly cause an improvement in traffic spikes.\nIt should work well in a highly distributed environment with dozens of service instances and database nodes.\nIt cannot be too costly or require too much additional infrastructure like additional databases, external systems,\netc.\nTackling the problem\nTo meet those needs we needed a robust solution. Since RFC leaves a lot of room for implementation by end-users, it does\nnot specify how such rate-limiting should work.\nAs with every problem of such kind, it’s worth starting with in-depth research of existing solutions. There are various\nstrategies and approaches to this problem in many different scenarios, but only a few of them were applicable to our\ncase and enabled us to fulfill our goals.\nAs usual, we also explored the existing implementations of such solutions in the form of enterprise or open-source\nlibraries and frameworks. Unfortunately, we did not find any that would meet all of our needs and at the same time be\nflexible enough to easily integrate into our ecosystem. It’s also worth noting that we were limited by certain\nconstraints such as long-term costs of additional resources.\nIn the end, we decided to go with implementing our own solution. There were several algorithms to choose from that could\nserve as its base:\nPrecise query-based per-user counter — query the database for a token count for each request. Not suitable, because\nit would cause way too much database traffic.\nFixed window based on TTL documents — uses a rate-limit counter that is cleared every fixed period. While less\nchallenging for the database, it shares a common vulnerability with the first algorithm: sudden TTL-caused spikes in\nallowed requests that consequently cause all of the following requests to be blocked (rate-limit exhaustion).\nSliding window log — stores all requests as a timestamped log entry in a database, that are later aggregated when\nneeded. Too costly, because again it would cause too heavy a load on the database.\nSliding window — uses a rate-limit counter that is a time-based weighted moving window. It has the advantage of\nrelatively low database load of the fixed window algorithm without its spike-related flaws.\nWe carefully weighed the pros and cons of each of those options and finally decided to make a PoC of the fourth option:\nthe sliding window algorithm.\nThe algorithm is based on counters that each hold a count of requests in their respective time frames. At each point of\ntime, an abstract window is calculated from two neighboring frames: current and previous. The further away the window is\nfrom the previous frame, the more important the counter from the current frame is. The weight is based strictly on\nproportions. If, for example, the span of the current window is 75% of the previous frame and 25% of the current frame,\nthen the value of the current rate-limit counter is a sum of 75% of the previous frame counter and 25% of the current\nframe counter. The results are put into a hashmap with users as keys and counters as values, which acts as a cache.\n\nIn the picture above the current counter value would be:\n\nvalue = previousCounter * partOfPreviousFrame + currentCounter * partOfCurrentFrame\nvalue = 12 * 0.75 + 5 * 0.25 = 10.25\n\n\nThe time complexity of the sliding window algorithm is O(1) since it’s a simple hashmap get operation, while its space\ncomplexity is O(n) where n is the number of user counters held by an instance. It works well in distributed systems\nbecause it’s based on simple counters that are relatively easy to synchronize. Its cost is low since we only need to\nstore simple counters and can easily minimize database queries, as well as improve performance with caching in a\nstraightforward manner. Thanks to the fact that the sliding window takes into account the time relative to the current\ntimestamp, we can flatten the token creation spikes. Its main disadvantage is that it indirectly relies on the even\ndistribution of requests in time, which makes it less sensitive to spike traffic within one time window.\nFollowing the plan\nRemote state synchronization\nThere are two kinds of states that need to be tracked for the rate-limiting to work. The first one is the global state.\nIt’s basically a global counter of all requests made by a client to rate-limited OAuth endpoints within a certain\nperiod. This state is persisted in the database and from its perspective represents the most recent rate-limit status.\nThe second type is the local state of each instance, one part of which is the local counter of incoming requests for a\nclient within a time window. Since instances are not directly connected to the client and every one of them can make\nrequests to different instances concurrently, the local counter of each instance for that client will most probably have\na different value. Rate-limiting is a global functionality in the sense that we are interested in the value of global\ncounters and not of individual counters. Consider the following scenario: we would like to set a rate limit of 50 RPS\nfor a client while having 10 instances. If we relied only on local counters to do the rate-limiting, it would be\npossible for the traffic of 500 RPS to be split evenly between instances and not trigger rate-limiting - and that’s not\nthe result we are aiming for.\nTo decide whether to reject an incoming request or not, the local instance needs a second part of the state - a global\ncounter. When making a decision, it sums both the local and the global ones to check whether new requests would go\nbeyond the rate-limit boundaries.\nConsequently, the instances need to be aware of the requests made to the others and for that to work, the global counter\nneeds to be updated regularly. Each instance will periodically try to flush the sum of global and local counters from\ntheir state to the database. Here is where things get tricky. If several instances are trying to save different global\ncounters, there is a risk that one of them will attempt to overwrite the changes that were just saved by the other. To\ncounter that, we use a mechanism called optimistic locking that is\ndescribed later in this post. Once the state is persisted successfully, the local state is\ncleared. At this point, it consists of the incoming requests counter that is equal to 0 and the global snapshot counter\nthat is equal to the value persisted in the database for that client.\nCaching clients’ global state\nAny instance should be aware of the rate limit state for the whole cluster. It represents the global number of requests\nmade by a particular client and its users. We keep a mapping between a pair (client_id, username) and the number of\nrequests made in memory, which makes our algorithm efficient. There is one caveat: keeping all the clients and their\nusers would take too much space, so we only keep those clients and users who are actively making requests to the OAuth\nserver. As soon as they stop calling our servers we delete them from the instance’s cache.\nSharing the state\nOur internal OAuth service works in a distributed manner. There are many instances of the OAuth servers and we should\nhave mechanisms to coordinate rate-limiting between them. In practice, it means that if a client is making a request to\nserver instance A, the server instance B should consider it when calculating the allowed number of requests in the\ncurrent time window. Below are the key points that sum up this description:\nWe have a global request counter per each client/user.\nThe counter is stored in the Mongo database.\nEach instance shares the counter - it reads and writes its current value.\nThe counter depicts the window in the current timestamp.\n\n{\n  \"_id\" : {\n    \"clientId\" : \"some-client\",\n    \"username\" : \"some-user\"\n  },\n  \"version\" : NumberLong(405),\n  \"expire\" : ISODate(\"2021-05-29T14:24:01.376Z\"),\n  \"requestCounters\" : {\n    \"1622211780\" : 1,\n    \"1622211840\" : 1\n  }\n}\n\n\nThe counter consists of a few fields:\n_id - to uniquely identify the client and the user connected with the request.\nversion - for the optimistic locking purposes.\nexpire - used to remove the counter if it has no updates, which means that the client is not currently creating new\ntokens.\nrequestCounters - mapping of the number of requests at consecutive points in time.\nThe counter is cached so we don’t have to fetch it each time the request from the client is made, since it would kill\nperformance. Each instance refreshes the counter asynchronously - reads and writes to the Mongo database are made in a\ndedicated thread. Each one also holds the counters only for the clients they have to handle. A particular instance\nremoves the client’s state after it stops sending requests.\n\n\nThis table depicts an example flow of counters on two instances (A, B) of our OAuth service. Each of them has its own\ncounter\n(accordingly cnt1 and cnt2), mng is a state in the sharded Mongo database and total req is the sum of\nall requests made to all instances.\nThe state of each instance consists of two counters (g / i). The first one (g for “global”) describes how many\nrequests have been globally made and are persisted in the database. The second one tracks how many requests have come to\nthat instance since the last flush (i for “in-flight”). The total number of requests from its perspective is the sum\nof g and i and it is the value that is going to be persisted.\nBelow is the description of what happens in this scenario, step by step:\nThere is an initial state with no requests made to either instance.\nOne request is made to instance A and its iA counter is increased to 1.\nNext, instance A pushes its total counter to the database, setting its g counter to 1 and its i counter to 0.\nInstance B periodically pulls the g counter from the database. Now, the new counter is pulled and the instance’s\ncurrent state is g = 1, iB = 0.\nNext, instance A receives one request, and at the same time, instance B receives three requests. At this time\ninstance A knows of 2 requests, 1 of which came since the last flush. Instance B knows of 4 requests, 3 of them came\nsince the last flush.\nInstance B pushes its total counter (3+1=4) to Mongo. As a consequence, its state is set to (4 / 0). Instance A has\nnot yet flushed its counter to persistent storage. Remember that both instances do it independently whenever a fixed\ninterval passes.\nNow, Instance A tries to push its state (1+1=2) to the database. If the push was successful, it would overwrite the\nstate previously written by the instance B (in step 5), resulting in data loss. We want our counters to be precise so\nwe need to use optimistic locking here. It causes the push to fail, if the version of its state differs from the\nversion persisted in the database. If that scenario occurs, the instance knows that it should refresh its global\ncounter before trying to save it again.\nInstance A refreshed its state. It is now equal to (4/1), which means 4 requests are persisted in the database and 1\nthat has not been flushed yet. Now it can safely push its total counter (4+1=5) to the database and set its state\nto (5/0).\nAt this point both instances have pushed their state to the database. Notice, however, that instance B has not yet\npulled the counter written by instance B in the previous step.\nAfter the last pull, the counter states on both instances are consistent with the database state and reflect the\nglobal number of requests made by a client.\nPersisting the state\nTo properly persist the state in a distributed environment with minimal impact on application performance, we needed to\ntake several strategies into consideration.\nResolving the conflicts\nAs we’ve already mentioned we use optimistic locking to prevent the state from being overwritten by the different\ninstances. It’s quite a common problem in a the world of distributed systems. It works by using version numbers kept in\nMongoDB, which designates how many updates have been made from the beginning of its creation. After each update the\nversion increases by one.\nBefore save to the database:\n\n{\n   \"_id\" : {...},\n   \"version\" : 0,\n   \"requestCount\": 0,\n   ...\n}\n\n\nAfter the save:\n\n{\n   \"_id\" : {...},\n   \"version\" : 1,\n   \"requestCount\": 5,\n   ...\n}\n\n\nBut how does a particular instance save the document atomically? How does it know that there was an update made by\nanother instance in the meantime? For this purpose, we use a Mongo query to do\nthe CAS update that looks like:\n\n\ndb.ratelimits.update(\n \u003cfilter query\u003e\n \u003cupdate operation\u003e\n)\n\ndb.ratelimits.update(\n {\n   \"_id\": {...},\n   \"version\": 1\n },\n {\n   \"version\": 2,\n   \"requestCount\": 10\n }\n)\n\n\nIf the query returns 0 elements updated we know there was a collision and there was a concurrent save which changed the\nstate. If this happens we need to:\nUpdate state from database to local instance,\nApply inflight recorded changes (the ones not yet persisted to the database),\nSave the state,\nIf the query returns 1 element updated, the save was successful without any collisions,\nSaving in batches\nAs we already mentioned, a single instance of the OAuth server handles many clients. So it has to synchronize the state\nfor each of them. Doing the above save operation for each client individually would cause a massive number of queries\nand would quickly saturate our resources. That’s why we\nuse Mongo bulk operations. They\nallow defining many operations in a single query.\nGoing into production\nDry-run\nBefore actually blocking the clients we needed a way to check real outputs from our solution. We implemented the dry-run\nmode, which enabled us do this without affecting any clients, while also giving us metrics depicting which of them would\nbe blocked given a particular limit and time window. We took the following steps:\nSet high rate limit up to the point when no clients would be blocked (running in dry-run mode all the time).\nLowered the threshold to the point that showed us the outstanding clients, while not blocking the others.\nCommunicated with clients abusing our future rate limit policy and gave them a chance to optimize the way they use\nthe OAuth server.\nSwitched modes from dry-run to actively blocking the clients.\nCanary deployment\nIt would be risky to deploy this kind of feature to the whole OAuth cluster without ensuring it’s properly working on a\nfew instances. We used canary deployment which allows deploying a version of a service to only a few production\ninstances. During this deployment, we monitored CPU usage and response time metrics. After ensuring there was meaningful\ndisparity we rolled out the full feature to all production instances.\nObservability\nTo monitor and verify our solution we needed a bunch of metrics telling us how many clients were affected by rate limit\npolicy and which of them are getting closer to being blocked. In practice, two charts shown below were enough to monitor\ntheir behaviour:\n\nThis chart shows clients and their blocked rate. Each color depicts a different blocked client.\n\nThis one on the other hand depicts the allowed rate. The limit line is helpful to see if any client is getting closer to\nit and will be blocked soon. It’s worth mentioning that the default rate limit policy isn’t sufficient for all of the\nclients. Some of them require special treatment and for them we can configure different thresholds, which is why a few\nof them go beyond the actual default limit (the red line).\nConclusion\nRate-limiting is a common problem, but surprisingly not so trivial to solve, especially in a high-scale, distributed\nenvironment. Plenty of popular solutions can be found, but most of them deal with it only from a perspective of a single\nmachine and were not well-suited for our system. Coming up with the above approach took quite a bit of research and\nplanning, but in the end, its deployment allowed us to effectively achieve our goal. We are pretty content with the\nfinal product, as it is both effective and fast, but are constantly tweaking it and looking for new ways to optimize\nthat process.","guid":"https://blog.allegro.tech/2021/11/oauth-rate-limiting.html","categories":["tech","architecture","oauth","microservices"],"isoDate":"2021-11-08T23:00:00.000Z","thumbnail":"images/post-headers/default.jpg"},{"title":"How we refactored the search form UI component","link":"https://blog.allegro.tech/2021/10/refactoring-opbox-search.html","pubDate":"Tue, 26 Oct 2021 00:00:00 +0200","authors":{"author":[{"name":["Volodymyr Khytskyi"],"photo":["https://blog.allegro.tech/img/authors/volodymyr.khytskyi.jpg"],"url":["https://blog.allegro.tech/authors/volodymyr.khytskyi"]}]},"content":"\u003cp\u003eThis article describes a classic case of refactoring a search form UI component, a critical part of every e-commerce\nplatform. In it I’ll explain the precursor of change, analysis process, as well as aspects to pay attention to and\nprinciples to apply while designing a new solution. If you are planning to conduct refactoring of a codebase or just\ncurious to learn more about frontend internals at \u003ca href=\"https://allegro.tech\"\u003eAllegro\u003c/a\u003e, you might learn a thing or two from\nthis article. Sounds interesting? Hop on!\u003c/p\u003e\n\n\u003ch2 id=\"how-does-the-search-form-function-at-allegro\"\u003eHow does the search form function at Allegro?\u003c/h2\u003e\n\n\u003cp\u003eFor starters, so that we all are on the same page, let me briefly explain how the search form at Allegro works and what\nfunctionality it is responsible for. Under the hood, it is one of our many\n\u003ca href=\"/2016/03/Managing-Frontend-in-the-microservices-architecture.html\"\u003eOpBox\u003c/a\u003e components and its\ntechnical name is opbox-search.\u003c/p\u003e\n\n\u003cp\u003eFrom UI standpoint it consists of four parts:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003ean input field\u003c/li\u003e\n  \u003cli\u003ea scope selector\u003c/li\u003e\n  \u003cli\u003ea submit button\u003c/li\u003e\n  \u003cli\u003ea dropdown with a list of suggestions\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-10-26-refactoring-opbox-search/component-breakdown.png\" alt=\"Component Breakdown\" title=\"Component Breakdown\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eFunctionality-wise, whenever a user clicks/taps into the input or types a search phrase, a dropdown with a list of\nsuggestions shows up and the user can navigate through by using keyboard/mouse/touchscreen. The suggestion list\nitself, at most, consists of two sections: phrases searched in the past and popular/matching suggestions. Those are\nfetched in real time as the user interacts with the form. Additionally, there is also a preconfigured option to search\nthe phrase in products’ descriptions.\u003c/p\u003e\n\n\u003cp\u003eThe form also provides a possibility to narrow down the search scope to a particular department, a certain\nuser, a charity organization, etc. Depending on the selected scope, when user click the submission button, they are\nredirected to an appropriate product/user/charity listing page and the search phrase is sent as a URL query parameter.\u003c/p\u003e\n\n\u003cp\u003eAt this point you might be wondering: this sounds quite easy, how come you messed up such a simple component?\u003c/p\u003e\n\n\u003ch2 id=\"a-bit-of-history-and-the-precursor-of-refactoring\"\u003eA bit of history and the precursor of refactoring\u003c/h2\u003e\n\n\u003cp\u003eThe initial commit took place back in 2017 and up until the point of refactoring the project, there were 2292 commits\nspread across 189 pull requests merged to the main branch. All those contributions were made by different independent\nteams. Over time the component evolved, some external APIs changed, some features became deprecated and new ones were\nadded. At one point it also changed its ownership to another development team. As expected, all those factors left some\nmarks on the codebase.\u003c/p\u003e\n\n\u003cp\u003eOne of ample examples of troublesome conditions was the store entity that is responsible for handling the runtime state.\nIn reality, besides performing its primary function it also handled network calls and contained pieces of business logic\nnon-relevant for search scoping and suggestions listing.\u003c/p\u003e\n\n\u003cp\u003eTo make matters worse, the internals of the entity were publicly exposed and therefore any dependent, e.g. the search\ninput or the scope selector, was free to manipulate the store arbitrarily. Not hard to imagine, using such “shortcuts”\nhas lead to degradation of codebase readability and maintainability.\u003c/p\u003e\n\n\u003cp\u003eAt one point in time it reached its critical mass and we started considering the cost of maintaining the existing\ncodebase vs. the cost of redeveloping it from scratch.\u003c/p\u003e\n\n\u003ch2 id=\"refactoring-expectations\"\u003eRefactoring expectations\u003c/h2\u003e\n\n\u003cp\u003eRefactoring itself doesn’t provide any business value. Instead it is an investment that should save engineers’ time and\neffort. That is why the primary goal was to gain back the confidence in further development of the component by:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003estreamlining the maintenance of existing features\u003c/li\u003e\n  \u003cli\u003estreamlining and simplifying the development of new business features\u003c/li\u003e\n  \u003cli\u003eusing tools, design patterns and principles to help engineers develop stable and correctly functioning features\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eSubsequently, achieving the goal would:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eshorten the delivery time\u003c/li\u003e\n  \u003cli\u003ecreate, from an architectural standpoint, a new solution resilient to multiple future contributions from different teams\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"into-the-technical-analysis\"\u003eInto the technical analysis\u003c/h2\u003e\n\n\u003cp\u003eSo by this point we learned what the functional requirements are and identified the issues we have with the current\nsolution. We also outlined refactoring expectations, hence we could start laying down the conceptual foundation of a new\nsolution. We began by asking ourselves a few questions that could help us formalize our technical end goals.\u003c/p\u003e\n\n\u003ch3 id=\"what-issues-did-we-want-to-avoid-this-time-what-did-we-want-the-new-solution-to-improve-upon\"\u003eWhat issues did we want to avoid this time? What did we want the new solution to improve upon?\u003c/h3\u003e\n\n\u003cp\u003eGoing back to the store example, we clearly didn’t want to allow any dependent to mutate its data in any abritrary way\nnor did we want the store to contain pieces of logic that are not of its concern, e.g. networking. Instead we wanted to\nmove these irrelevant pieces into more suitable locations, decrease entanglement of different parts of the codebase,\nstructure it into logical entities that are more human readable, draw boundaries between those entities, define rules\nof communication and make sure we expose to the public API only what we intended to.\u003c/p\u003e\n\n\u003ch3 id=\"what-development-principles-and-design-patterns-could-we-have-incorporated\"\u003eWhat development principles and design patterns could we have incorporated?\u003c/h3\u003e\n\n\u003ch4 id=\"the-single-responsibility-principle-srp\"\u003eThe single-responsibility principle (SRP)\u003c/h4\u003e\n\n\u003cp\u003eThe “S” of the “SOLID” acronym. As the name hints, a class (or a unit of code) should be responsible only for a single\npiece of functionality. A simple and powerful principle, yet quite often overlooked. Say, if we build a piece of logic\nassociated with an input HTML element, its only responsibility should be to tightly interact with the element, e.g.\nlisten to its DOM events and update its value if needed. At the same time, you don’t want this logic to affect the\nsubmission behavior of a form element inside of which the input element is placed.\u003c/p\u003e\n\n\u003ch4 id=\"the-separation-of-concerns-principle-soc\"\u003eThe separation of concerns principle (SoC)\u003c/h4\u003e\n\n\u003cp\u003eSoC goes well in pair with SRP and states that one should not place functionalities of different domains under the same\nlogical entity (say, an object, a class or a module). For example, we need to render a piece of information on the\nscreen but beforehand the information needs to be fetched over the network. Since the view and network layers have\ndifferent concerns we don’t want to place both of them under a single logical entity. Let these two be separate ones\nwith established dependency relation to one another via a public API.\u003c/p\u003e\n\n\u003ch4 id=\"the-loose-coupling-principle\"\u003eThe loose coupling principle\u003c/h4\u003e\n\n\u003cp\u003eLoose coupling means that a single logical entity knows as little as possible about other entities and communication\nbetween them follows strict rules. One important characteristic we wanted to achieve here is to minimize negative\neffects on application’s runtime in case an entity malfunctions. As an analogy, we could imagine a graph of airports\nthat are connected to each other via a set of flight routes. Say, there are direct routes from airport A to B, C and D.\nIf the airport C gets closed due to renovation of a runway, the routes to B and D are not affected in any way. Moreover,\nsome passengers might not even know that C is not operating at that moment.\u003c/p\u003e\n\n\u003ch4 id=\"event-driven-dataflow\"\u003eEvent-driven dataflow\u003c/h4\u003e\n\n\u003cp\u003eSince we are dealing with a UI component that has several moving parts, applying event-driven techniques come in handy\nbecause of their asynchronous nature and because messaging channels are subscription-based. Here is another analogy: you\nare at your place waiting for a hand-to-hand package delivery. Instead of opening the door every now and then to check\nif there is a courier behind it you would probably wait first for a doorbell to ring, right? Only once it rings (an\nevent occurs), you would open the door to obtain the package.\u003c/p\u003e\n\n\u003ch3 id=\"which-development-constraints-if-any-did-we-want-to-introduce-intentionally\"\u003eWhich development constraints (if any) did we want to introduce intentionally?\u003c/h3\u003e\n\n\u003cp\u003eWe wanted the architecture of the new solution to follow a certain set of rules in order to maintain its structure. We\nalso wanted to make it harder for engineers to break those rules. In the short term it might be a drawback, but we are\ninterested in keeping the codebase well-maintained in the long run. By carefully designing the APIs and applying static\ntype analysis we were not only able to meet the requirement but also lifted some complexity from engineers’ shoulders,\nand this is where TypeScript shines brightly.\u003c/p\u003e\n\n\u003ch2 id=\"applying-all-of-the-above-in-a-new-store-solution\"\u003eApplying all of the above in a new store solution\u003c/h2\u003e\n\n\u003cp\u003eBased on the conclusions reached above we were ready to start the actual work and started it from the core, that is the\nstore entity. As with any store solutions, let us list functional characteristics that one should provide.\u003c/p\u003e\n\n\u003cp\u003eThe store should:\u003c/p\u003e\n\u003cul\u003e\n  \u003cli\u003ehold current runtime state\u003c/li\u003e\n  \u003cli\u003ebe initialized with a default state\u003c/li\u003e\n  \u003cli\u003eprovide a public API that allows dependents to update its state during runtime in a \u003cem\u003econtrolled way\u003c/em\u003e\u003c/li\u003e\n  \u003cli\u003eexpose information channels to propagate the state change to every subscriber\u003c/li\u003e\n  \u003cli\u003enot expose any implementation details\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eDefining the structure of the store’s data is as simple as declaring a TypeScript interface, but we need to be able to\nexpose information that the state has mutated in a particular way. That is, we need to build event-driven communication\nbetween the store and its dependents. For this purpose we could use an event emitter and define as many topics as needed.\nIn our case, having a dedicated topic per state property turned out to work perfectly as we didn’t have that many\nproperties in the first place. And since we wanted to have the state and event emitter under the same umbrella, we\nencapsulated them into the following class declaration:\u003c/p\u003e\n\n\u003cdiv class=\"language-ts highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"kr\"\u003einterface\u003c/span\u003e \u003cspan class=\"nx\"\u003eState\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"nl\"\u003efoo\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003eboolean\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"nl\"\u003ebar\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kr\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// ...\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003etype\u003c/span\u003e \u003cspan class=\"nx\"\u003eTopic\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003eK\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"nx\"\u003eCapitalize\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kr\"\u003ekeyof\u003c/span\u003e \u003cspan class=\"nx\"\u003eState\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e]:\u003c/span\u003e \u003cspan class=\"nx\"\u003eUncapitalize\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nx\"\u003eK\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nx\"\u003eStore\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"kd\"\u003econstructor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"nx\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"nx\"\u003eemitter\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003eEmitter\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nb\"\u003eRecord\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\n       \u003cspan class=\"kr\"\u003ekeyof\u003c/span\u003e \u003cspan class=\"nx\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n       \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n\n  \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nx\"\u003eon\u003c/span\u003e\u003cspan class=\"p\"\u003e(...\u003c/span\u003e\u003cspan class=\"nx\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eemitter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eon\u003c/span\u003e\u003cspan class=\"p\"\u003e(...\u003c/span\u003e\u003cspan class=\"nx\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThe last piece of the puzzle is that we needed to automate event emission triggering. At the same time, we aimed to\nminimize the size of the boilerplate code needed to set up this behavior for each state property. Since every property\nhas a corresponding topic, that is where we were able to leverage the power of JavaScript’s accessor descriptor and\nwithin a setter we could trigger the emission:\u003c/p\u003e\n\n\u003cdiv class=\"language-ts highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nb\"\u003eObject\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003evalues\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eTopic\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eforEach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ekey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nb\"\u003eObject\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003edefineProperty\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eStore\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eprototype\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kd\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n    \u003cspan class=\"kd\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estate\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"p\"\u003e...\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e]:\u003c/span\u003e \u003cspan class=\"nx\"\u003evalue\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n      \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eemitter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eemit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}));\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eAfter putting it all together, not only did we achieve the above-mentioned characteristics but also a simple way to\nwork with the store:\u003c/p\u003e\n\n\u003cdiv class=\"language-ts highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nx\"\u003estore\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003efoo\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"nx\"\u003estore\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eon\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eTopic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eFoo\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e...);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eAt this point the store is ready and we would like to test how well the solution performs in reality.\u003c/p\u003e\n\n\u003ch2 id=\"event-driven-communication-between-the-store-and-ui-parts\"\u003eEvent-driven communication between the store and UI parts\u003c/h2\u003e\n\n\u003cp\u003eNow we could focus on developing the UI parts of our component. Luckily, business requirements provide enough hints where\nto place each piece of functionality. Let’s take a look at how we shaped the search input and the suggestion list, and\nhow these UI parts cooperate with each other and the store.\u003c/p\u003e\n\n\u003cp\u003eRecall that functionality-wise the suggestion list is a dropdown that should be rendered whenever a user types a search\nphrase or clicks/taps into the input element. We also need to fetch best matching suggestions whenever the input value\nchanges.\u003c/p\u003e\n\n\u003cp\u003eWe started with the search input as it doesn’t have any dependencies besides the store. With functional requirements in\nmind, we aimed it to be good at doing just two things:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eProxying DOM events such as focus, blur, click, keydown, etc.\u003c/li\u003e\n  \u003cli\u003eNotifying the store whenever the input value changes\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eSince updating the store is pretty much straightforward, let’s take a look at how we handled DOM events. Events such as\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eclick\u003c/code\u003e, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efocus\u003c/code\u003e, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eblur\u003c/code\u003e convey the fact that there was some sort of interaction with the input HTML element. Unlike\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003einput\u003c/code\u003e event, where one is interested in knowing what the current value is, the above-mentioned ones don’t include any\nrelated information. We only need to be able to communicate to the dependents the fact that such an event took place\nand that is why, similarly to the store, the search input has an event emitter of its own. Now, you might be thinking:\nwhy would you want to have multiple sources of information given you already have the event-driven store solution? There\nare a couple of reasons:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eSince those DOM events don’t contain additional information, there is nothing we need to put into our store. It\naligns well with the single-responsibility principle, according to which the store only fulfills its primary function\nand has no hint of existence of the search input.\u003c/li\u003e\n  \u003cli\u003eBy bypassing the store we shortened an event message travel distance from the source to a subscriber.\u003c/li\u003e\n  \u003cli\u003eIt also aligns well with a mental model, where if one wants to react to an event that happened in the search input,\none subscribes to its publicly available communication channels.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eThe gist of this approach and binding with the store can be achieved in just a few lines of code. Here we add several\nDOM event listeners and, depending on the event type, decide whether we need to proxy them into the event emitter or\nupdate the store’s state:\u003c/p\u003e\n\n\u003cdiv class=\"language-ts highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nx\"\u003eSearchInput\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"kd\"\u003econstructor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"nx\"\u003einputNode\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003eHTMLInputElement\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"nx\"\u003estore\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003eStore\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"nx\"\u003eemitter\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003eEmitter\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"nb\"\u003eRecord\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\n      \u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003eclick\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003efocus\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003eblur\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003einputNode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eaddEventListener\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003eclick\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nx\"\u003eemitter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eemit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003eclick\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003einputNode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eaddEventListener\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003efocus\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nx\"\u003eemitter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eemit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003efocus\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003einputNode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eaddEventListener\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003eblur\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nx\"\u003eemitter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eemit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003eblur\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003einputNode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eaddEventListener\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003einput\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e({\u003c/span\u003e \u003cspan class=\"na\"\u003ecurrentTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nx\"\u003evalue\u003c/span\u003e \u003cspan class=\"p\"\u003e}})\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nx\"\u003estore\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003einput\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// ...\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eNow, we can focus our attention on the suggestions list. Communication-wise, all it needs to do is to subscribe to\nseveral topics provided by the store and the search input:\u003c/p\u003e\n\n\u003cdiv class=\"language-ts highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eimport\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nx\"\u003efetchSuggestions\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003efrom\u003c/span\u003e \u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003e./network\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nx\"\u003eSuggestionsList\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"kd\"\u003econstructor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"nx\"\u003estore\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003eStore\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"nx\"\u003esearchInput\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003eSearchInput\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// ...\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003esearchInput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eemitter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eon\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003eclick\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003erenderVisible\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003esearchInput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eemitter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eon\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003efocus\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003erenderVisible\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003esearchInput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eemitter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eon\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003eblur\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003erenderHidden\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003estore\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eon\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003einput\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003efetchItemsList\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003estore\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eon\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003esuggestionsListData\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003erenderItemsList\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n      \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003erenderVisible\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"nx\"\u003efetchItemsList\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estore\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esuggesiontsListData\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nx\"\u003efetchSuggestions\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estore\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// ...\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eWhen a \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eclick\u003c/code\u003e or \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efocus\u003c/code\u003e event message arrives from the search input, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eSuggestionsList\u003c/code\u003e renders a dropdown UI element.\nOn the other hand, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eblur\u003c/code\u003e event occurrence hides it. A change of input value in the store leads to fetching suggestions\nover the network and lastly, whenever suggestions data is available, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eSuggestionsList\u003c/code\u003e renders the item list and makes\nthe dropdown visible.\u003c/p\u003e\n\n\u003cp\u003eNote that because we apply the separation of concerns principle, the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efetchItemsList\u003c/code\u003e method only delegates a job to an\nexternal dependency responsible for network communication. Upon successful response, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eSuggestionsList\u003c/code\u003e doesn’t\nimmediately start rendering the data, instead the data is put into the store and \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eSuggestionList\u003c/code\u003e listens to that data\nchange. With such data circulation we ensure that:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eThe store is a single source of truth (and data)\u003c/li\u003e\n  \u003cli\u003eSuggestions’ data is propagated to every dependent\u003c/li\u003e\n  \u003cli\u003eWe avoid possible redundant rendering cycles\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eWith that, our functional requirement is implemented.\u003c/p\u003e\n\n\u003ch2 id=\"the-final-solution\"\u003eThe final solution\u003c/h2\u003e\n\n\u003cp\u003eReapplying the above principles and techniques to develop the remaining functional requirements, we ended up with a\nsolution that can be illustrated as follows:\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-10-26-refactoring-opbox-search/architecture-diagram.png\" alt=\"Architecture Diagram\" title=\"Architecture Diagram\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eWere we able to meet our expectations? At the end of the day, after careful problem analysis, testing out POCs and\ndevelopment preparations, the implementation process itself went quite smoothly. Multiple people participated and\nwe are quite satisfied with the end result. Will it withstand future challenges? Only time will tell.\u003c/p\u003e\n\n\u003ch2 id=\"summary\"\u003eSummary\u003c/h2\u003e\n\n\u003cp\u003eAt Allegro we value our customer experience and that is why we pay a lot of attention to performance of our frontend\nsolutions. At the same time, as software engineers, we want to stay productive and, therefore, we also care about our\ndevelopment experience. Achieving good results in both worlds is where the real challenge lies.\u003c/p\u003e\n","contentSnippet":"This article describes a classic case of refactoring a search form UI component, a critical part of every e-commerce\nplatform. In it I’ll explain the precursor of change, analysis process, as well as aspects to pay attention to and\nprinciples to apply while designing a new solution. If you are planning to conduct refactoring of a codebase or just\ncurious to learn more about frontend internals at Allegro, you might learn a thing or two from\nthis article. Sounds interesting? Hop on!\nHow does the search form function at Allegro?\nFor starters, so that we all are on the same page, let me briefly explain how the search form at Allegro works and what\nfunctionality it is responsible for. Under the hood, it is one of our many\nOpBox components and its\ntechnical name is opbox-search.\nFrom UI standpoint it consists of four parts:\nan input field\na scope selector\na submit button\na dropdown with a list of suggestions\n\nFunctionality-wise, whenever a user clicks/taps into the input or types a search phrase, a dropdown with a list of\nsuggestions shows up and the user can navigate through by using keyboard/mouse/touchscreen. The suggestion list\nitself, at most, consists of two sections: phrases searched in the past and popular/matching suggestions. Those are\nfetched in real time as the user interacts with the form. Additionally, there is also a preconfigured option to search\nthe phrase in products’ descriptions.\nThe form also provides a possibility to narrow down the search scope to a particular department, a certain\nuser, a charity organization, etc. Depending on the selected scope, when user click the submission button, they are\nredirected to an appropriate product/user/charity listing page and the search phrase is sent as a URL query parameter.\nAt this point you might be wondering: this sounds quite easy, how come you messed up such a simple component?\nA bit of history and the precursor of refactoring\nThe initial commit took place back in 2017 and up until the point of refactoring the project, there were 2292 commits\nspread across 189 pull requests merged to the main branch. All those contributions were made by different independent\nteams. Over time the component evolved, some external APIs changed, some features became deprecated and new ones were\nadded. At one point it also changed its ownership to another development team. As expected, all those factors left some\nmarks on the codebase.\nOne of ample examples of troublesome conditions was the store entity that is responsible for handling the runtime state.\nIn reality, besides performing its primary function it also handled network calls and contained pieces of business logic\nnon-relevant for search scoping and suggestions listing.\nTo make matters worse, the internals of the entity were publicly exposed and therefore any dependent, e.g. the search\ninput or the scope selector, was free to manipulate the store arbitrarily. Not hard to imagine, using such “shortcuts”\nhas lead to degradation of codebase readability and maintainability.\nAt one point in time it reached its critical mass and we started considering the cost of maintaining the existing\ncodebase vs. the cost of redeveloping it from scratch.\nRefactoring expectations\nRefactoring itself doesn’t provide any business value. Instead it is an investment that should save engineers’ time and\neffort. That is why the primary goal was to gain back the confidence in further development of the component by:\nstreamlining the maintenance of existing features\nstreamlining and simplifying the development of new business features\nusing tools, design patterns and principles to help engineers develop stable and correctly functioning features\nSubsequently, achieving the goal would:\nshorten the delivery time\ncreate, from an architectural standpoint, a new solution resilient to multiple future contributions from different teams\nInto the technical analysis\nSo by this point we learned what the functional requirements are and identified the issues we have with the current\nsolution. We also outlined refactoring expectations, hence we could start laying down the conceptual foundation of a new\nsolution. We began by asking ourselves a few questions that could help us formalize our technical end goals.\nWhat issues did we want to avoid this time? What did we want the new solution to improve upon?\nGoing back to the store example, we clearly didn’t want to allow any dependent to mutate its data in any abritrary way\nnor did we want the store to contain pieces of logic that are not of its concern, e.g. networking. Instead we wanted to\nmove these irrelevant pieces into more suitable locations, decrease entanglement of different parts of the codebase,\nstructure it into logical entities that are more human readable, draw boundaries between those entities, define rules\nof communication and make sure we expose to the public API only what we intended to.\nWhat development principles and design patterns could we have incorporated?\nThe single-responsibility principle (SRP)\nThe “S” of the “SOLID” acronym. As the name hints, a class (or a unit of code) should be responsible only for a single\npiece of functionality. A simple and powerful principle, yet quite often overlooked. Say, if we build a piece of logic\nassociated with an input HTML element, its only responsibility should be to tightly interact with the element, e.g.\nlisten to its DOM events and update its value if needed. At the same time, you don’t want this logic to affect the\nsubmission behavior of a form element inside of which the input element is placed.\nThe separation of concerns principle (SoC)\nSoC goes well in pair with SRP and states that one should not place functionalities of different domains under the same\nlogical entity (say, an object, a class or a module). For example, we need to render a piece of information on the\nscreen but beforehand the information needs to be fetched over the network. Since the view and network layers have\ndifferent concerns we don’t want to place both of them under a single logical entity. Let these two be separate ones\nwith established dependency relation to one another via a public API.\nThe loose coupling principle\nLoose coupling means that a single logical entity knows as little as possible about other entities and communication\nbetween them follows strict rules. One important characteristic we wanted to achieve here is to minimize negative\neffects on application’s runtime in case an entity malfunctions. As an analogy, we could imagine a graph of airports\nthat are connected to each other via a set of flight routes. Say, there are direct routes from airport A to B, C and D.\nIf the airport C gets closed due to renovation of a runway, the routes to B and D are not affected in any way. Moreover,\nsome passengers might not even know that C is not operating at that moment.\nEvent-driven dataflow\nSince we are dealing with a UI component that has several moving parts, applying event-driven techniques come in handy\nbecause of their asynchronous nature and because messaging channels are subscription-based. Here is another analogy: you\nare at your place waiting for a hand-to-hand package delivery. Instead of opening the door every now and then to check\nif there is a courier behind it you would probably wait first for a doorbell to ring, right? Only once it rings (an\nevent occurs), you would open the door to obtain the package.\nWhich development constraints (if any) did we want to introduce intentionally?\nWe wanted the architecture of the new solution to follow a certain set of rules in order to maintain its structure. We\nalso wanted to make it harder for engineers to break those rules. In the short term it might be a drawback, but we are\ninterested in keeping the codebase well-maintained in the long run. By carefully designing the APIs and applying static\ntype analysis we were not only able to meet the requirement but also lifted some complexity from engineers’ shoulders,\nand this is where TypeScript shines brightly.\nApplying all of the above in a new store solution\nBased on the conclusions reached above we were ready to start the actual work and started it from the core, that is the\nstore entity. As with any store solutions, let us list functional characteristics that one should provide.\nThe store should:\nhold current runtime state\nbe initialized with a default state\nprovide a public API that allows dependents to update its state during runtime in a controlled way\nexpose information channels to propagate the state change to every subscriber\nnot expose any implementation details\nDefining the structure of the store’s data is as simple as declaring a TypeScript interface, but we need to be able to\nexpose information that the state has mutated in a particular way. That is, we need to build event-driven communication\nbetween the store and its dependents. For this purpose we could use an event emitter and define as many topics as needed.\nIn our case, having a dedicated topic per state property turned out to work perfectly as we didn’t have that many\nproperties in the first place. And since we wanted to have the state and event emitter under the same umbrella, we\nencapsulated them into the following class declaration:\n\ninterface State {\n  foo: boolean;\n  bar: string;\n  // ...\n}\n\ntype Topic = {\n  [K in Capitalize\u003ckeyof State\u003e]: Uncapitalize\u003cK\u003e;\n}\n\nclass Store {\n  constructor(\n    private state: State,\n    private readonly emitter: Emitter\u003cRecord\u003c\n       keyof State,\n       (state: State) =\u003e void\n    \u003e\u003e,\n  ) {}\n\n  public on(...args) { return this.emitter.on(...args);\n}\n\n\nThe last piece of the puzzle is that we needed to automate event emission triggering. At the same time, we aimed to\nminimize the size of the boilerplate code needed to set up this behavior for each state property. Since every property\nhas a corresponding topic, that is where we were able to leverage the power of JavaScript’s accessor descriptor and\nwithin a setter we could trigger the emission:\n\nObject\n  .values(Topic)\n  .forEach(key =\u003e Object.defineProperty(Store.prototype, key, {\n    get() {\n      return this.state[key];\n    },\n    set(value) {\n      this.state = { ...this.state, [key]: value };\n      this.emitter.emit(key, this.state);\n    }\n  }));\n\n\nAfter putting it all together, not only did we achieve the above-mentioned characteristics but also a simple way to\nwork with the store:\n\nstore.foo = true;\nstore.on(Topic.Foo, (state: State) =\u003e ...);\n\n\nAt this point the store is ready and we would like to test how well the solution performs in reality.\nEvent-driven communication between the store and UI parts\nNow we could focus on developing the UI parts of our component. Luckily, business requirements provide enough hints where\nto place each piece of functionality. Let’s take a look at how we shaped the search input and the suggestion list, and\nhow these UI parts cooperate with each other and the store.\nRecall that functionality-wise the suggestion list is a dropdown that should be rendered whenever a user types a search\nphrase or clicks/taps into the input element. We also need to fetch best matching suggestions whenever the input value\nchanges.\nWe started with the search input as it doesn’t have any dependencies besides the store. With functional requirements in\nmind, we aimed it to be good at doing just two things:\nProxying DOM events such as focus, blur, click, keydown, etc.\nNotifying the store whenever the input value changes\nSince updating the store is pretty much straightforward, let’s take a look at how we handled DOM events. Events such as\nclick, focus, blur convey the fact that there was some sort of interaction with the input HTML element. Unlike\ninput event, where one is interested in knowing what the current value is, the above-mentioned ones don’t include any\nrelated information. We only need to be able to communicate to the dependents the fact that such an event took place\nand that is why, similarly to the store, the search input has an event emitter of its own. Now, you might be thinking:\nwhy would you want to have multiple sources of information given you already have the event-driven store solution? There\nare a couple of reasons:\nSince those DOM events don’t contain additional information, there is nothing we need to put into our store. It\naligns well with the single-responsibility principle, according to which the store only fulfills its primary function\nand has no hint of existence of the search input.\nBy bypassing the store we shortened an event message travel distance from the source to a subscriber.\nIt also aligns well with a mental model, where if one wants to react to an event that happened in the search input,\none subscribes to its publicly available communication channels.\nThe gist of this approach and binding with the store can be achieved in just a few lines of code. Here we add several\nDOM event listeners and, depending on the event type, decide whether we need to proxy them into the event emitter or\nupdate the store’s state:\n\nclass SearchInput {\n  constructor(\n    private readonly inputNode: HTMLInputElement,\n    private store: Store,\n    public readonly emitter: Emitter\u003cRecord\u003c\n      'click' | 'focus' | 'blur',\n      () =\u003e void,\n    \u003e\u003e,\n  ) {\n    inputNode.addEventListener('click', () =\u003e emitter.emit('click'));\n    inputNode.addEventListener('focus', () =\u003e emitter.emit('focus'));\n    inputNode.addEventListener('blur', () =\u003e emitter.emit('blur'));\n    inputNode.addEventListener('input', ({ currentTarget: { value }}) =\u003e store.input = value);\n  }\n  // ...\n}\n\n\nNow, we can focus our attention on the suggestions list. Communication-wise, all it needs to do is to subscribe to\nseveral topics provided by the store and the search input:\n\nimport { fetchSuggestions } from './network';\n\nclass SuggestionsList {\n  constructor(\n    private store: Store,\n    private readonly searchInput: SearchInput,\n    // ...\n  ) {\n    searchInput.emitter.on('click', () =\u003e this.renderVisible());\n    searchInput.emitter.on('focus', () =\u003e this.renderVisible());\n    searchInput.emitter.on('blur', () =\u003e this.renderHidden());\n    store.on('input', () =\u003e this.fetchItemsList());\n    store.on('suggestionsListData', () =\u003e {\n      this.renderItemsList();\n      this.renderVisible();\n    });\n  }\n\n  private async fetchItemsList() {\n    this.store.suggesiontsListData = await fetchSuggestions(this.store.input);\n  }\n  // ...\n}\n\n\nWhen a click or focus event message arrives from the search input, SuggestionsList renders a dropdown UI element.\nOn the other hand, blur event occurrence hides it. A change of input value in the store leads to fetching suggestions\nover the network and lastly, whenever suggestions data is available, SuggestionsList renders the item list and makes\nthe dropdown visible.\nNote that because we apply the separation of concerns principle, the fetchItemsList method only delegates a job to an\nexternal dependency responsible for network communication. Upon successful response, SuggestionsList doesn’t\nimmediately start rendering the data, instead the data is put into the store and SuggestionList listens to that data\nchange. With such data circulation we ensure that:\nThe store is a single source of truth (and data)\nSuggestions’ data is propagated to every dependent\nWe avoid possible redundant rendering cycles\nWith that, our functional requirement is implemented.\nThe final solution\nReapplying the above principles and techniques to develop the remaining functional requirements, we ended up with a\nsolution that can be illustrated as follows:\n\nWere we able to meet our expectations? At the end of the day, after careful problem analysis, testing out POCs and\ndevelopment preparations, the implementation process itself went quite smoothly. Multiple people participated and\nwe are quite satisfied with the end result. Will it withstand future challenges? Only time will tell.\nSummary\nAt Allegro we value our customer experience and that is why we pay a lot of attention to performance of our frontend\nsolutions. At the same time, as software engineers, we want to stay productive and, therefore, we also care about our\ndevelopment experience. Achieving good results in both worlds is where the real challenge lies.","guid":"https://blog.allegro.tech/2021/10/refactoring-opbox-search.html","categories":["tech","frontend","architecture","refactoring","developmentexperience","typescript"],"isoDate":"2021-10-25T22:00:00.000Z","thumbnail":"images/post-headers/default.jpg"},{"title":"Comparing MongoDB composite indexes","link":"https://blog.allegro.tech/2021/10/comparing-mongodb-composite-indexes.html","pubDate":"Mon, 18 Oct 2021 00:00:00 +0200","authors":{"author":[{"name":["Michał Knasiecki"],"photo":["https://blog.allegro.tech/img/authors/michal.knasiecki.jpg"],"url":["https://blog.allegro.tech/authors/michal.knasiecki"]}]},"content":"\u003cp\u003eOne of the key elements ensuring efficient operation of the services we work on every day at\n\u003ca href=\"https://allegro.tech/\"\u003eAllegro\u003c/a\u003e is fast responses from the database.\nWe spend a lot of time to properly model the data so that storing and querying take as little time as possible.\nYou can read more about why good schema design is important in one of my earlier\n\u003ca href=\"/2021/01/impact-of-the-data-model-on-the-MongoDB-database-size.html\"\u003eposts\u003c/a\u003e.\nIt’s also equally important to make sure that all queries are covered with indexes of the correct type whenever\npossible. Indexes are used to quickly search the database and under certain conditions even allow results to be\nreturned directly from the index, without the need to access the data itself. However, indexes are not\nall the same and it’s important to learn more about their different types in order to make the right choices later on.\u003c/p\u003e\n\n\u003ch2 id=\"whats-the-difference\"\u003eWhat’s the difference?\u003c/h2\u003e\n\u003cp\u003eI’ve had a conversation with a colleague of mine the other day, about the point of using composite keys in a MongoDB\ndatabase. I’ve always been a firm believer that it’s a good idea to use a composite key wherever possible because\nsearching this way is very fast. My colleague, on the other hand, advocates using artificial keys and creating\nseparate \u003ca href=\"https://docs.mongodb.com/manual/core/index-compound/\"\u003ecomposite indexes\u003c/a\u003e on fields for\nwhich I would use a composite key.\nAfter a brief disagreement, I realized that other than my intuition, I had no arguments to defend my beliefs.\nI decided to see how indexes on composite keys differ from composite indexes created on regular fields in practice.\u003c/p\u003e\n\n\u003cp\u003eAs an example for our considerations, we will use an entity describing a person by first and last name, let’s also\nassume that this pair is unique.\u003c/p\u003e\n\n\u003cp\u003eSuch data can be stored in a collection (let’s call it \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecomposite\u003c/code\u003e) with a composite key that contains both fields.\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"_id\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"name\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"John\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"surname\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"Doe\"\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eA unique index will be automatically created on pair of both fields along with the collection.\u003c/p\u003e\n\n\u003cp\u003eMany developers would most likely prefer to use an artificial key, and index the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ename\u003c/code\u003e and \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esurname\u003c/code\u003e fields\nseparately, as shown in collection \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eartificial\u003c/code\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"_id\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003eObjectId(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\"615eb18b76e172647f7462e2\"\u003c/span\u003e\u003cspan class=\"err\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"name\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"John\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"surname\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"Doe\"\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eWhen it comes to the second model, only the artificial key will be automatically covered by the index. To be\nable to efficiently search the collection by first and last name, we need to manually create a composite index on both\nfields. To maintain consistency with the first collection, of course, uniqueness also needs to be enforced:\u003c/p\u003e\n\n\u003cdiv class=\"language-javascript highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nx\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eartificial\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ecreateIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e({\u003c/span\u003e\u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"na\"\u003esurname\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"na\"\u003eunique\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e})\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eAt first glance, we can clearly see that the first way of storing data is more compact, since we only store two fields\nof interest, and only one index is required in addition to the data. For the second collection, in addition to the data\nitself, we need to store an artificial key, moreover two indexes are required here: on the artificial key and on\nthe \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ename\u003c/code\u003e and \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esurname\u003c/code\u003e fields.\u003c/p\u003e\n\n\u003cp\u003eWe can now move on to comparing the execution plans of queries to two collections, so let’s take a look at the result\nof the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eexplain\u003c/code\u003e commands:\u003c/p\u003e\n\n\u003cdiv class=\"language-javascript highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nx\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ecomposite\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003efind\u003c/span\u003e\u003cspan class=\"p\"\u003e({\u003c/span\u003e\n    \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003e_id\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003ename\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eJohn\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003esurname\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eDoe\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}).\u003c/span\u003e\u003cspan class=\"nx\"\u003eexplain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eexecutionStats\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eand:\u003c/p\u003e\n\n\u003cdiv class=\"language-javascript highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nx\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eartificial\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003efind\u003c/span\u003e\u003cspan class=\"p\"\u003e({\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003ename\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eJohn\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003esurname\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eDoe\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e}).\u003c/span\u003e\u003cspan class=\"nx\"\u003eexplain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eexecutionStats\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eLet’s start with the second result first. We can see that the optimiser chose to use the index we manually created.\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"winningPlan\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"stage\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"FETCH\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"inputStage\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n      \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"stage\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"IXSCAN\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n      \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"keyPattern\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"name\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mf\"\u003e1.0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"surname\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mf\"\u003e1.0\u003c/span\u003e\u003cspan class=\"w\"\u003e\n      \u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\u003cspan class=\"w\"\u003e\n      \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"indexName\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"name_1_surname_1\"\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e[…]\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"executionStats\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"executionSuccess\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"nReturned\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eIn the case of a collection with a composite key, however, the plan is different; it contains the word \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eIDHACK\u003c/code\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"winningPlan\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"stage\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"IDHACK\"\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e[…]\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"executionStats\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"executionSuccess\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"nReturned\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eIt means that the optimiser skipped the index selection phase (although in our case there were no other indexes, but\nit doesn’t matter) and decided to use the key index. This operation is considered to be the fastest one possible.\nWhenever there is a key in the query, its index will be used (while ignoring conditions on other fields).\u003c/p\u003e\n\n\u003cp\u003eLet’s also take a look at the notation \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e\"nReturned\" : 1\u003c/code\u003e, which means that both queries returned a single document.\u003c/p\u003e\n\n\u003cp\u003eWe already know that queries to both collections will be handled with an index. However, I’ve been wondering if there\nare any differences between these indexes?\u003c/p\u003e\n\n\u003cp\u003eThe first should be search time: since whenever there is a key in the condition list, its index will be used,\ntheoretically, key’s index should be the fastest. We’ll get to that topic in a moment. For now, let’s see what happens\nif we only want to search one field at a time:\u003c/p\u003e\n\n\u003cdiv class=\"language-javascript highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nx\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003egetCollection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003ecomposite\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nx\"\u003efind\u003c/span\u003e\u003cspan class=\"p\"\u003e({\u003c/span\u003e\n    \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003e_id\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003ename\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eJohn\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}).\u003c/span\u003e\u003cspan class=\"nx\"\u003eexplain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eexecutionStats\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"language-javascript highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nx\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003egetCollection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003eartificial\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nx\"\u003efind\u003c/span\u003e\u003cspan class=\"p\"\u003e({\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003ename\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eJohn\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e}).\u003c/span\u003e\u003cspan class=\"nx\"\u003eexplain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eexecutionStats\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eIn the case of the first query, the index was admittedly used, but we got no results, as evidenced by the notation:\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"executionStages\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"stage\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"IDHACK\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"nReturned\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThis happens because a composite key requires all its components to be used by the query, so it is impossible to search\nby a single field.\u003c/p\u003e\n\n\u003cp\u003eThe situation is different when querying the second collection, here the index was also used, however this time the\ndocument was found:\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"winningPlan\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"stage\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"FETCH\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"inputStage\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n      \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"stage\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"IXSCAN\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n      \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"keyPattern\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"name\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mf\"\u003e1.0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"surname\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mf\"\u003e1.0\u003c/span\u003e\u003cspan class=\"w\"\u003e\n      \u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\u003cspan class=\"w\"\u003e\n      \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"indexName\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"name_1_surname_1\"\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e[…]\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"executionStats\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"executionSuccess\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"nReturned\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eWhat if we decide to search by \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esurname\u003c/code\u003e only?\u003c/p\u003e\n\n\u003cdiv class=\"language-javascript highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nx\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003egetCollection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003ecomposite\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nx\"\u003efind\u003c/span\u003e\u003cspan class=\"p\"\u003e({\u003c/span\u003e\n    \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003e_id\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003esurname\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eDoe\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}).\u003c/span\u003e\u003cspan class=\"nx\"\u003eexplain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eexecutionStats\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"language-javascript highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nx\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003egetCollection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003eartificial\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nx\"\u003efind\u003c/span\u003e\u003cspan class=\"p\"\u003e({\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003esurname\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eDoe\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e}).\u003c/span\u003e\u003cspan class=\"nx\"\u003eexplain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eexecutionStats\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eIn a collection with a composite key, we have a situation similar to the previous one - the index was used, but we\ndidn’t receive any document. The reason, of course, is the same: we didn’t use all the key fields.\u003c/p\u003e\n\n\u003cp\u003eBy querying the collection with a separate composite index, we got the document we were looking for, but it turns out\nthat this time the index was not used, and instead the database had to search through the entire collection:\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"winningPlan\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"stage\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"COLLSCAN\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"filter\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n            \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"surname\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n                \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"$eq\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"Doe\"\u003c/span\u003e\u003cspan class=\"w\"\u003e\n            \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"direction\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"forward\"\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThis is because with composite indexes, while it is possible not to use all indexed\nfields, it is only permissible to skip values in the reverse order, that is, reading indexed fields from the right.\nOur index was created on the fields in the following order:\u003c/p\u003e\n\n\u003cdiv class=\"language-javascript highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nx\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eartificial\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ecreateIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e({\u003c/span\u003e\u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"na\"\u003esurname\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"na\"\u003eunique\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e})\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eIt is therefore possible to omit the condition on the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esurname\u003c/code\u003e field and search only by \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ename\u003c/code\u003e, but it’s not possible\nthe other way around.\u003c/p\u003e\n\n\u003cp\u003eWe managed to find out the first difference between two types of indexes: composite key indexes are less flexible,\nrequire all values to be specified, while in regular composite indexes we can omit values from the right.\u003c/p\u003e\n\n\u003cp\u003eLet’s also check if the order of conditions matter?\u003c/p\u003e\n\n\u003cdiv class=\"language-javascript highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nx\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003egetCollection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003ecomposite\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nx\"\u003efind\u003c/span\u003e\u003cspan class=\"p\"\u003e({\u003c/span\u003e\n    \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003e_id\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003esurname\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eDoe\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003ename\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eJohn\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}).\u003c/span\u003e\u003cspan class=\"nx\"\u003eexplain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eexecutionStats\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"language-javascript highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nx\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003egetCollection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003eartificial\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nx\"\u003efind\u003c/span\u003e\u003cspan class=\"p\"\u003e({\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003esurname\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eDoe\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003ename\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eJohn\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e}).\u003c/span\u003e\u003cspan class=\"nx\"\u003eexplain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eexecutionStats\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eAnd here’s another surprise: even though all the components of the key were provided, but in reverse order, the\nfirst query did not find the document.\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"executionStages\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n      \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"stage\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"IDHACK\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n      \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"nReturned\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eWith a regular composite index, the optimiser was able to reverse the field order itself and use the appropriate\nindex to find the document: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e\"nReturned\" : 1\u003c/code\u003e\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"winningPlan\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"stage\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"FETCH\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"inputStage\"\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n          \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"stage\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"IXSCAN\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n          \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"keyPattern\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n            \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"name\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mf\"\u003e1.0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n            \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"surname\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mf\"\u003e1.0\u003c/span\u003e\u003cspan class=\"w\"\u003e\n          \u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\u003cspan class=\"w\"\u003e\n          \u003c/span\u003e\u003cspan class=\"nl\"\u003e\"indexName\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\"name_1_surname_1\"\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eFor the time being, indexes on composite keys are losing against regular ones. This is a good time to get back to the\nquestion about the search time of the two indexes. Now that we’ve established that indexes on composite keys are less\nflexible, it’s a good idea to figure out what we gain in return for such limitations. We already know that \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eIDHACK\u003c/code\u003e\nskips all indexes and always uses a key, so one might think that this is the fastest available way to get to the\ndocument. I decided to check this on my own.\u003c/p\u003e\n\n\u003ch2 id=\"its-time-to-experiment\"\u003eIt’s time to experiment\u003c/h2\u003e\n\n\u003cp\u003eI filled both previously used collections with 10 million documents. I used the following scripts for this purpose:\u003c/p\u003e\n\n\u003cdiv class=\"language-javascript highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003ebulk\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ecomposite\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003einitializeUnorderedBulkOp\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003elet\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e10000000\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ebulk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003einsert\u003c/span\u003e\u003cspan class=\"p\"\u003e({\u003c/span\u003e\u003cspan class=\"na\"\u003e_id\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003ename_\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003eNumberInt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"na\"\u003esurname\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003esurname_\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003eNumberInt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)}})\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"nx\"\u003ebulk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eexecute\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"language-javascript highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003ebulk\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eartificial\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003einitializeUnorderedBulkOp\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003elet\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e10000000\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ebulk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003einsert\u003c/span\u003e\u003cspan class=\"p\"\u003e({\u003c/span\u003e\u003cspan class=\"na\"\u003e_id\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nx\"\u003eObjectId\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003ename_\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003eNumberInt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"na\"\u003esurname\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003esurname_\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003eNumberInt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)})\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"nx\"\u003ebulk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eexecute\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eIt is worth noting here that I’m adding documents in batches. This is definitely faster than a list of single inserts\nand is useful when we need to generate a large amount of data quickly. Also note that I am using existing collections\nso my index on \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ename\u003c/code\u003e and \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esurname\u003c/code\u003e fields already exists.\u003c/p\u003e\n\n\u003cp\u003eI measured the execution time of both scripts using following commands (to avoid network latency I performed the\nmeasurements on my laptop, with a local instance of MongoDB version 4.4.0 running):\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nb\"\u003etime \u003c/span\u003emongo \u003cspan class=\"nb\"\u003etest \u003c/span\u003efill1.js\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nb\"\u003etime \u003c/span\u003emongo \u003cspan class=\"nb\"\u003etest \u003c/span\u003efill2.js\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eFilling collections with documents took \u003cstrong\u003e58,95s\u003c/strong\u003e and \u003cstrong\u003e76,48s\u003c/strong\u003e respectively. So when it comes to \u003ccode class=\"language-plaintext highlighter-rouge\"\u003einsert\u003c/code\u003e operation time,\nthe composite key collection clearly wins. The reason for this, of course, is a simpler document structure and only one\nindex, instead of two.\u003c/p\u003e\n\n\u003cp\u003eI was more interested in read times, because in a typical case, data is usually read more often than written. For each collection,\nI prepared a script containing a list of \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efind\u003c/code\u003e commands for 1 million documents in random order. Of course, the order of\nqueries in both scripts is the same:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e#!/bin/bash\u003c/span\u003e\n\u003cspan class=\"nv\"\u003eRANDOM\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e42\n\u003cspan class=\"k\"\u003efor \u003c/span\u003ei \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e1..1000000\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003cspan class=\"k\"\u003edo\n  \u003c/span\u003e\u003cspan class=\"nv\"\u003ex\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$((\u003c/span\u003e \u003cspan class=\"nv\"\u003e$RANDOM\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"m\"\u003e10000000\u003c/span\u003e\u003cspan class=\"k\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\"db.composite.find({_id: {name: 'name_\u003c/span\u003e\u003cspan class=\"nv\"\u003e$x\u003c/span\u003e\u003cspan class=\"s2\"\u003e', surname: 'surname_\u003c/span\u003e\u003cspan class=\"nv\"\u003e$x\u003c/span\u003e\u003cspan class=\"s2\"\u003e'}})\"\u003c/span\u003e\n\u003cspan class=\"k\"\u003edone\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e find1.js\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e#!/bin/bash\u003c/span\u003e\n\u003cspan class=\"nv\"\u003eRANDOM\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e42\n\u003cspan class=\"k\"\u003efor \u003c/span\u003ei \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e1..1000000\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003cspan class=\"k\"\u003edo\n  \u003c/span\u003e\u003cspan class=\"nv\"\u003ex\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$((\u003c/span\u003e \u003cspan class=\"nv\"\u003e$RANDOM\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"m\"\u003e10000000\u003c/span\u003e\u003cspan class=\"k\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\"db.artificial.find({name: 'name_\u003c/span\u003e\u003cspan class=\"nv\"\u003e$x\u003c/span\u003e\u003cspan class=\"s2\"\u003e', surname: 'surname_\u003c/span\u003e\u003cspan class=\"nv\"\u003e$x\u003c/span\u003e\u003cspan class=\"s2\"\u003e'})\"\u003c/span\u003e\n\u003cspan class=\"k\"\u003edone\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e find2.js\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eFinally, I measured the execution time of both scripts using the commands:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nb\"\u003etime \u003c/span\u003emongo \u003cspan class=\"nb\"\u003etest \u003c/span\u003efind1.js\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nb\"\u003etime \u003c/span\u003emongo \u003cspan class=\"nb\"\u003etest \u003c/span\u003efind2.js\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThe results surprised me. The script running on the first collection took \u003cstrong\u003e11.19s\u003c/strong\u003e and the second took \u003cstrong\u003e10.15s\u003c/strong\u003e.\nAlthough the differences are small, I was sure that using a composite key would be much faster than searching\nthrough regular fields and would make up for all the inconvenience of less flexible keys. Meanwhile, it turns\nout that a collection built with an artificial key and a separate index on two fields wins in terms of search speed.\u003c/p\u003e\n\n\u003cp\u003eI had one more idea. Maybe searching a document by a key that doesn’t exist would be faster?\nTo test this, I generated another two scripts, this time searching for non-existent documents:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e#!/bin/bash\u003c/span\u003e\n\u003cspan class=\"nv\"\u003eRANDOM\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e42\n\u003cspan class=\"k\"\u003efor \u003c/span\u003ei \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e1..1000000\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003cspan class=\"k\"\u003edo\n  \u003c/span\u003e\u003cspan class=\"nv\"\u003ex\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$((\u003c/span\u003e \u003cspan class=\"nv\"\u003e$RANDOM\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"m\"\u003e10000000\u003c/span\u003e\u003cspan class=\"k\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\"db.composite.find({_id: {name: 'missing_name_\u003c/span\u003e\u003cspan class=\"nv\"\u003e$x\u003c/span\u003e\u003cspan class=\"s2\"\u003e', surname: 'missing_surname_\u003c/span\u003e\u003cspan class=\"nv\"\u003e$x\u003c/span\u003e\u003cspan class=\"s2\"\u003e'}})\"\u003c/span\u003e\n\u003cspan class=\"k\"\u003edone\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e find-missing1.js\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e#!/bin/bash\u003c/span\u003e\n\u003cspan class=\"nv\"\u003eRANDOM\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e42\n\u003cspan class=\"k\"\u003efor \u003c/span\u003ei \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e1..1000000\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003cspan class=\"k\"\u003edo\n  \u003c/span\u003e\u003cspan class=\"nv\"\u003ex\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$((\u003c/span\u003e \u003cspan class=\"nv\"\u003e$RANDOM\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"m\"\u003e10000000\u003c/span\u003e\u003cspan class=\"k\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\"db.artificial.find({name: 'missing_name_\u003c/span\u003e\u003cspan class=\"nv\"\u003e$x\u003c/span\u003e\u003cspan class=\"s2\"\u003e', surname: 'missing_surname_\u003c/span\u003e\u003cspan class=\"nv\"\u003e$x\u003c/span\u003e\u003cspan class=\"s2\"\u003e'})\"\u003c/span\u003e\n\u003cspan class=\"k\"\u003edone\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e find-missing2.js\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eUnfortunately, the composite key collection also lost in this case: \u003cstrong\u003e12.44s\u003c/strong\u003e vs. \u003cstrong\u003e10.26s\u003c/strong\u003e.\u003c/p\u003e\n\n\u003cp\u003eFinally, I decided to run one more test. Since when using composite key we have to pass the entire key to the query\nand cannot search by its fragment, I decided to create a third collection, this time its key being the concatenation of\nfirst and last name:\u003c/p\u003e\n\n\u003cdiv class=\"language-javascript highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003ebulk\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003econcatenation\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003einitializeUnorderedBulkOp\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003elet\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e10000000\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ebulk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003einsert\u003c/span\u003e\u003cspan class=\"p\"\u003e({\u003c/span\u003e\u003cspan class=\"na\"\u003e_id\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003ename_\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003eNumberInt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003e-\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"dl\"\u003e'\u003c/span\u003e\u003cspan class=\"s1\"\u003esurname_\u003c/span\u003e\u003cspan class=\"dl\"\u003e'\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003eNumberInt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)})\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"nx\"\u003ebulk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eexecute\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eI then prepared another script containing 1 million search operations (in the same order as the previous attempts,\nof course):\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e#!/bin/bash\u003c/span\u003e\n\u003cspan class=\"nv\"\u003eRANDOM\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e42\n\u003cspan class=\"k\"\u003efor \u003c/span\u003ei \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e1..1000000\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003cspan class=\"k\"\u003edo\n  \u003c/span\u003e\u003cspan class=\"nv\"\u003ex\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$((\u003c/span\u003e \u003cspan class=\"nv\"\u003e$RANDOM\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"m\"\u003e10000000\u003c/span\u003e\u003cspan class=\"k\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\"db.concatenation.find({_id: 'name_\u003c/span\u003e\u003cspan class=\"nv\"\u003e$x\u003c/span\u003e\u003cspan class=\"s2\"\u003e-surname_\u003c/span\u003e\u003cspan class=\"nv\"\u003e$x\u003c/span\u003e\u003cspan class=\"s2\"\u003e'})\"\u003c/span\u003e\n\u003cspan class=\"k\"\u003edone\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e find3.js\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThis time I was finally able to get a result better than the one achieved with the artificial key approach: \u003cstrong\u003e9.71s\u003c/strong\u003e.\nAll results are summarized in the chart below:\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"/img/articles/2021-10-18-comparing-mongodb-composite-indexes/final-results.png\" alt=\"Collection stats\" /\u003e\u003c/p\u003e\n\n\u003ch2 id=\"conclusion\"\u003eConclusion\u003c/h2\u003e\n\n\u003cp\u003eIt appears that the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eIDHACK\u003c/code\u003e operation is indeed the fastest possible way to access a document, but only for a simple\nkey. As soon as we add an additional field into the key, the benefits of the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eIDHACK\u003c/code\u003e operation disappear and the\nregular index works better.\u003c/p\u003e\n\n\u003cp\u003eIn general, my experiments did not confirm the advantages of using a composite key. The artificial key model is more\nflexible in querying and returns results faster. However, if you want to search even faster, you may consider using a\nsimple key created by concatenating selected fields.\u003c/p\u003e\n\n\u003cp\u003eI realize, of course, that I did not use the latest available version of the mongo server. For this reason, I am\nposting all the scripts I used in my attempts and encourage you to experiment on your own. Perhaps composite keys\nperform better in newer versions of the database?\u003c/p\u003e\n","contentSnippet":"One of the key elements ensuring efficient operation of the services we work on every day at\nAllegro is fast responses from the database.\nWe spend a lot of time to properly model the data so that storing and querying take as little time as possible.\nYou can read more about why good schema design is important in one of my earlier\nposts.\nIt’s also equally important to make sure that all queries are covered with indexes of the correct type whenever\npossible. Indexes are used to quickly search the database and under certain conditions even allow results to be\nreturned directly from the index, without the need to access the data itself. However, indexes are not\nall the same and it’s important to learn more about their different types in order to make the right choices later on.\nWhat’s the difference?\nI’ve had a conversation with a colleague of mine the other day, about the point of using composite keys in a MongoDB\ndatabase. I’ve always been a firm believer that it’s a good idea to use a composite key wherever possible because\nsearching this way is very fast. My colleague, on the other hand, advocates using artificial keys and creating\nseparate composite indexes on fields for\nwhich I would use a composite key.\nAfter a brief disagreement, I realized that other than my intuition, I had no arguments to defend my beliefs.\nI decided to see how indexes on composite keys differ from composite indexes created on regular fields in practice.\nAs an example for our considerations, we will use an entity describing a person by first and last name, let’s also\nassume that this pair is unique.\nSuch data can be stored in a collection (let’s call it composite) with a composite key that contains both fields.\n\n{\n    \"_id\" : {\n        \"name\" : \"John\",\n        \"surname\" : \"Doe\"\n    }\n}\n\n\nA unique index will be automatically created on pair of both fields along with the collection.\nMany developers would most likely prefer to use an artificial key, and index the name and surname fields\nseparately, as shown in collection artificial:\n\n{\n    \"_id\" : ObjectId(\"615eb18b76e172647f7462e2\"),\n    \"name\" : \"John\",\n    \"surname\" : \"Doe\"\n}\n\n\nWhen it comes to the second model, only the artificial key will be automatically covered by the index. To be\nable to efficiently search the collection by first and last name, we need to manually create a composite index on both\nfields. To maintain consistency with the first collection, of course, uniqueness also needs to be enforced:\n\ndb.artificial.createIndex({name: 1, surname: 1}, {unique: true})\n\n\nAt first glance, we can clearly see that the first way of storing data is more compact, since we only store two fields\nof interest, and only one index is required in addition to the data. For the second collection, in addition to the data\nitself, we need to store an artificial key, moreover two indexes are required here: on the artificial key and on\nthe name and surname fields.\nWe can now move on to comparing the execution plans of queries to two collections, so let’s take a look at the result\nof the explain commands:\n\ndb.composite.find({\n    \"_id\" : {\n        \"name\" : \"John\",\n        \"surname\" : \"Doe\"\n    }\n}).explain(\"executionStats\")\n\n\nand:\n\ndb.artificial.find({\"name\" : \"John\", \"surname\" : \"Doe\"}).explain(\"executionStats\")\n\n\nLet’s start with the second result first. We can see that the optimiser chose to use the index we manually created.\n\n{\n  \"winningPlan\": {\n    \"stage\": \"FETCH\",\n    \"inputStage\": {\n      \"stage\": \"IXSCAN\",\n      \"keyPattern\": {\n        \"name\": 1.0,\n        \"surname\": 1.0\n      },\n      \"indexName\": \"name_1_surname_1\"\n    }\n  }\n}\n\n\n[…]\n\n{\n  \"executionStats\" : {\n    \"executionSuccess\": true,\n    \"nReturned\": 1\n  }\n}\n\n\nIn the case of a collection with a composite key, however, the plan is different; it contains the word IDHACK:\n\n{\n  \"winningPlan\": {\n    \"stage\": \"IDHACK\"\n  }\n}\n\n\n[…]\n\n{\n  \"executionStats\" : {\n    \"executionSuccess\": true,\n    \"nReturned\": 1\n  }\n}\n\n\nIt means that the optimiser skipped the index selection phase (although in our case there were no other indexes, but\nit doesn’t matter) and decided to use the key index. This operation is considered to be the fastest one possible.\nWhenever there is a key in the query, its index will be used (while ignoring conditions on other fields).\nLet’s also take a look at the notation \"nReturned\" : 1, which means that both queries returned a single document.\nWe already know that queries to both collections will be handled with an index. However, I’ve been wondering if there\nare any differences between these indexes?\nThe first should be search time: since whenever there is a key in the condition list, its index will be used,\ntheoretically, key’s index should be the fastest. We’ll get to that topic in a moment. For now, let’s see what happens\nif we only want to search one field at a time:\n\ndb.getCollection('composite').find({\n    \"_id\" : {\n        \"name\" : \"John\"\n    }\n}).explain(\"executionStats\")\n\n\n\ndb.getCollection('artificial').find({\"name\" : \"John\"}).explain(\"executionStats\")\n\n\nIn the case of the first query, the index was admittedly used, but we got no results, as evidenced by the notation:\n\n{\n    \"executionStages\": {\n        \"stage\": \"IDHACK\",\n        \"nReturned\": 0\n    }\n}\n\n\nThis happens because a composite key requires all its components to be used by the query, so it is impossible to search\nby a single field.\nThe situation is different when querying the second collection, here the index was also used, however this time the\ndocument was found:\n\n{\n  \"winningPlan\": {\n    \"stage\": \"FETCH\",\n    \"inputStage\": {\n      \"stage\": \"IXSCAN\",\n      \"keyPattern\": {\n        \"name\": 1.0,\n        \"surname\": 1.0\n      },\n      \"indexName\": \"name_1_surname_1\"\n    }\n  }\n}\n\n\n[…]\n\n{\n  \"executionStats\" : {\n    \"executionSuccess\": true,\n    \"nReturned\": 1\n  }\n}\n\n\nWhat if we decide to search by surname only?\n\ndb.getCollection('composite').find({\n    \"_id\" : {\n        \"surname\" : \"Doe\"\n    }\n}).explain(\"executionStats\")\n\n\n\ndb.getCollection('artificial').find({\"surname\" : \"Doe\"}).explain(\"executionStats\")\n\n\nIn a collection with a composite key, we have a situation similar to the previous one - the index was used, but we\ndidn’t receive any document. The reason, of course, is the same: we didn’t use all the key fields.\nBy querying the collection with a separate composite index, we got the document we were looking for, but it turns out\nthat this time the index was not used, and instead the database had to search through the entire collection:\n\n{\n    \"winningPlan\" : {\n        \"stage\" : \"COLLSCAN\",\n        \"filter\" : {\n            \"surname\" : {\n                \"$eq\" : \"Doe\"\n            }\n        },\n        \"direction\" : \"forward\"\n    }\n}\n\n\nThis is because with composite indexes, while it is possible not to use all indexed\nfields, it is only permissible to skip values in the reverse order, that is, reading indexed fields from the right.\nOur index was created on the fields in the following order:\n\ndb.artificial.createIndex({name: 1, surname: 1}, {unique: true})\n\n\nIt is therefore possible to omit the condition on the surname field and search only by name, but it’s not possible\nthe other way around.\nWe managed to find out the first difference between two types of indexes: composite key indexes are less flexible,\nrequire all values to be specified, while in regular composite indexes we can omit values from the right.\nLet’s also check if the order of conditions matter?\n\ndb.getCollection('composite').find({\n    \"_id\" : {\n        \"surname\" : \"Doe\",\n        \"name\" : \"John\"\n    }\n}).explain(\"executionStats\")\n\n\n\ndb.getCollection('artificial').find({\"surname\" : \"Doe\", \"name\" : \"John\"}).explain(\"executionStats\")\n\n\nAnd here’s another surprise: even though all the components of the key were provided, but in reverse order, the\nfirst query did not find the document.\n\n{\n    \"executionStages\" : {\n      \"stage\": \"IDHACK\",\n      \"nReturned\": 0\n    }\n}\n\n\nWith a regular composite index, the optimiser was able to reverse the field order itself and use the appropriate\nindex to find the document: \"nReturned\" : 1\n\n{\n    \"winningPlan\" : {\n        \"stage\" : \"FETCH\",\n        \"inputStage\" : {\n          \"stage\": \"IXSCAN\",\n          \"keyPattern\": {\n            \"name\": 1.0,\n            \"surname\": 1.0\n          },\n          \"indexName\": \"name_1_surname_1\"\n        }\n    }\n}\n\n\nFor the time being, indexes on composite keys are losing against regular ones. This is a good time to get back to the\nquestion about the search time of the two indexes. Now that we’ve established that indexes on composite keys are less\nflexible, it’s a good idea to figure out what we gain in return for such limitations. We already know that IDHACK\nskips all indexes and always uses a key, so one might think that this is the fastest available way to get to the\ndocument. I decided to check this on my own.\nIt’s time to experiment\nI filled both previously used collections with 10 million documents. I used the following scripts for this purpose:\n\nvar bulk = db.composite.initializeUnorderedBulkOp();\nfor (let i = 0; i \u003c 10000000; i++) {\n    bulk.insert({_id: {name: 'name_' + NumberInt(i), surname: 'surname_' + NumberInt(i)}})\n}\nbulk.execute();\n\n\n\nvar bulk = db.artificial.initializeUnorderedBulkOp();\nfor (let i = 0; i \u003c 10000000; i++) {\n    bulk.insert({_id: new ObjectId(), name: 'name_' + NumberInt(i), surname: 'surname_' + NumberInt(i)})\n}\nbulk.execute();\n\n\nIt is worth noting here that I’m adding documents in batches. This is definitely faster than a list of single inserts\nand is useful when we need to generate a large amount of data quickly. Also note that I am using existing collections\nso my index on name and surname fields already exists.\nI measured the execution time of both scripts using following commands (to avoid network latency I performed the\nmeasurements on my laptop, with a local instance of MongoDB version 4.4.0 running):\n\ntime mongo test fill1.js\n\n\n\ntime mongo test fill2.js\n\n\nFilling collections with documents took 58,95s and 76,48s respectively. So when it comes to insert operation time,\nthe composite key collection clearly wins. The reason for this, of course, is a simpler document structure and only one\nindex, instead of two.\nI was more interested in read times, because in a typical case, data is usually read more often than written. For each collection,\nI prepared a script containing a list of find commands for 1 million documents in random order. Of course, the order of\nqueries in both scripts is the same:\n\n#!/bin/bash\nRANDOM=42\nfor i in {1..1000000}\ndo\n  x=$(( $RANDOM % 10000000))\n    echo \"db.composite.find({_id: {name: 'name_$x', surname: 'surname_$x'}})\"\ndone \u003e\u003e find1.js\n\n\n\n#!/bin/bash\nRANDOM=42\nfor i in {1..1000000}\ndo\n  x=$(( $RANDOM % 10000000))\n    echo \"db.artificial.find({name: 'name_$x', surname: 'surname_$x'})\"\ndone \u003e\u003e find2.js\n\n\nFinally, I measured the execution time of both scripts using the commands:\n\ntime mongo test find1.js\n\n\n\ntime mongo test find2.js\n\n\nThe results surprised me. The script running on the first collection took 11.19s and the second took 10.15s.\nAlthough the differences are small, I was sure that using a composite key would be much faster than searching\nthrough regular fields and would make up for all the inconvenience of less flexible keys. Meanwhile, it turns\nout that a collection built with an artificial key and a separate index on two fields wins in terms of search speed.\nI had one more idea. Maybe searching a document by a key that doesn’t exist would be faster?\nTo test this, I generated another two scripts, this time searching for non-existent documents:\n\n#!/bin/bash\nRANDOM=42\nfor i in {1..1000000}\ndo\n  x=$(( $RANDOM % 10000000))\n    echo \"db.composite.find({_id: {name: 'missing_name_$x', surname: 'missing_surname_$x'}})\"\ndone \u003e\u003e find-missing1.js\n\n\n\n#!/bin/bash\nRANDOM=42\nfor i in {1..1000000}\ndo\n  x=$(( $RANDOM % 10000000))\n    echo \"db.artificial.find({name: 'missing_name_$x', surname: 'missing_surname_$x'})\"\ndone \u003e\u003e find-missing2.js\n\n\nUnfortunately, the composite key collection also lost in this case: 12.44s vs. 10.26s.\nFinally, I decided to run one more test. Since when using composite key we have to pass the entire key to the query\nand cannot search by its fragment, I decided to create a third collection, this time its key being the concatenation of\nfirst and last name:\n\nvar bulk = db.concatenation.initializeUnorderedBulkOp();\nfor (let i = 0; i \u003c 10000000; i++) {\n    bulk.insert({_id: 'name_' + NumberInt(i) + '-' + 'surname_' + NumberInt(i)})\n}\nbulk.execute();\n\n\nI then prepared another script containing 1 million search operations (in the same order as the previous attempts,\nof course):\n\n#!/bin/bash\nRANDOM=42\nfor i in {1..1000000}\ndo\n  x=$(( $RANDOM % 10000000))\n    echo \"db.concatenation.find({_id: 'name_$x-surname_$x'})\"\ndone \u003e\u003e find3.js\n\n\nThis time I was finally able to get a result better than the one achieved with the artificial key approach: 9.71s.\nAll results are summarized in the chart below:\n\nConclusion\nIt appears that the IDHACK operation is indeed the fastest possible way to access a document, but only for a simple\nkey. As soon as we add an additional field into the key, the benefits of the IDHACK operation disappear and the\nregular index works better.\nIn general, my experiments did not confirm the advantages of using a composite key. The artificial key model is more\nflexible in querying and returns results faster. However, if you want to search even faster, you may consider using a\nsimple key created by concatenating selected fields.\nI realize, of course, that I did not use the latest available version of the mongo server. For this reason, I am\nposting all the scripts I used in my attempts and encourage you to experiment on your own. Perhaps composite keys\nperform better in newer versions of the database?","guid":"https://blog.allegro.tech/2021/10/comparing-mongodb-composite-indexes.html","categories":["tech","mongodb","index","performance","query tuning"],"isoDate":"2021-10-17T22:00:00.000Z","thumbnail":"images/post-headers/mongodb.png"},{"title":"How to ruin your Elasticsearch performance — Part II: Breaking things, one at a time","link":"https://blog.allegro.tech/2021/10/how-to-ruin-elasticsearch-performance-part-ii.html","pubDate":"Thu, 07 Oct 2021 00:00:00 +0200","authors":{"author":[{"name":["Michał Kosmulski"],"photo":["https://blog.allegro.tech/img/authors/michal.kosmulski.jpg"],"url":["https://blog.allegro.tech/authors/michal.kosmulski"]}]},"content":"\u003cp\u003eIt’s easy to find resources about \u003cem\u003eimproving\u003c/em\u003e \u003ca href=\"https://www.elastic.co/elastic-stack\"\u003eElasticsearch\u003c/a\u003e performance, but what if you wanted to \u003cem\u003ereduce\u003c/em\u003e it?\nIn \u003ca href=\"/2021/09/how-to-ruin-elasticsearch-performance-part-i.html\"\u003ePart I\u003c/a\u003e of this two-part series we looked under the hood in order to learn how\nES works internally. Now, in Part II, is the time to apply this knowledge in practice and ruin our ES performance. Most tips should also be applicable to\n\u003ca href=\"https://solr.apache.org/\"\u003eSolr\u003c/a\u003e, raw \u003ca href=\"https://lucene.apache.org/\"\u003eLucene\u003c/a\u003e, or, for that matter, to any other full-text search engine as well.\u003c/p\u003e\n\n\u003ch2 id=\"using-complex-boolean-queries\"\u003eUsing complex boolean queries\u003c/h2\u003e\n\n\u003cp\u003eA consequence of the algorithms outlined in \u003ca href=\"/2021/09/how-to-ruin-elasticsearch-performance-part-i.html\"\u003ePart I\u003c/a\u003e is that simple queries, such as finding\na document containing two or three specific words, are relatively cheap to compute. We can easily increase the cost by making the queries more complex. This\ncomplexity is easily achieved by using \u003ca href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.8/query-dsl-bool-query.html\"\u003eboolean queries\u003c/a\u003e which allow\narbitrary boolean expressions, including nested subexpressions.\u003c/p\u003e\n\n\u003cp\u003eA “flat” query, even with many words, boils down to a single AND/OR operation (though potentially with many lists). Since a search engine is usually\nsmart enough to sort these lists by length, it can execute such queries really fast. But what happens if we use a complex boolean expression? Let’s compare\ntwo example queries:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eQ1: find books which contain all of the words: “I like apples”\u003c/li\u003e\n  \u003cli\u003eQ2: find books which contain all of the words: “I like apples” or “I like oranges” and were published in 2020 or 2021 and are at least 100 pages long\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eLet us now look at the boolean expressions which correspond to these queries:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eQ1: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eI AND like AND apples\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003eQ2: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e((I AND like AND apples) OR (I AND like AND oranges)) AND (2020 OR 2021) AND (pages \u0026gt;= 100)\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eClearly, there is much more stuff to compute in the case of Q2, and the query will take more time, accordingly. Even though from the end user’s perspective,\nwe only added a few filters, the complexity of the query rose dramatically. For Q1, we need to perform 2 AND operations. For Q2, we end up with\n6 AND operations and 2 OR operations. However, this query is probably still much worse for performance than it may seem.\u003c/p\u003e\n\n\u003cp\u003eLet’s start analyzing this query from the bottom up.\u003c/p\u003e\n\n\u003cp\u003eThe expression \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2020 OR 2021\u003c/code\u003e is a little gem that looks innocent, but is actually quite expensive. As you remember, the cost of an OR operation is proportional\nto the sum of the sizes of input lists. The lists of books published in a year are probably quite long, so the cost of merging two will be quite high.\nAs a bonus, we get an even longer list as a result and this long list will take part in any computations that follow. So here are the takeaways:\u003c/p\u003e\n\u003cul\u003e\n  \u003cli\u003eOR operations are costly,\u003c/li\u003e\n  \u003cli\u003eeven more so when inputs are large document sets;\u003c/li\u003e\n  \u003cli\u003esubqueries (parentheses in the logical expression) cause temporary postings lists to be created, which then take part in further calculations and so their\nsizes affect query performance.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eLooking further at our query, we see that even more temporary document ID lists will have to be created: one for each pair of parentheses. These results have\nto be computed, and since they are temporary partial results, they will have to be stored in memory since they cannot be retrieved from the index directly.\u003c/p\u003e\n\n\u003cp\u003eAlso note that subqueries can hinder many optimizations search engines employ. I mentioned earlier that Lucene sorts postings lists by length when AND-ing\nthem together. This can only work reliably if list lengths are known. For a postings list of a single word, its length is stored in the index and known exactly\nup-front. For a nested subexpression, however, the number of matches is not known before the subexpression is evaluated. But, Lucene needs the number of matches\nin order to prepare the optimal query plan. This leads to a chicken-and-egg problem which Lucene solves by estimating the size of subquery results list based\non the sizes of its constituents. For example, it estimates the result size of a subquery with OR-s as the sum of its input sizes. Being just an estimate, this\nnumber may differ from the actual value, and thus cause suboptimal query performance further up the stack. Takeaway:\u003c/p\u003e\n\u003cul\u003e\n  \u003cli\u003esubqueries are great at hindering global query optimizations.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eAnother reason why subqueries may negatively affect performance becomes apparent with queries such as \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e(a AND b) AND (c AND d)\u003c/code\u003e. Since AND is an associative\noperation, the expression above gives the same result as \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ea AND b AND c AND d\u003c/code\u003e. In the\nversion without parentheses, the optimization of sorting lists by size works globally since all inputs are at the same nesting level, potentially achieving\nbetter performance than the version with nested subexpressions which can only sort the lists within each pair of parentheses separately.\u003c/p\u003e\n\n\u003cp\u003eYou may wonder why anyone would add these parentheses, but such constructs may arise naturally due to the way your code is structured if individual subqueries\nare built by separate methods or classes because they serve different business needs.\u003c/p\u003e\n\n\u003cp\u003eLooking at how long postings lists affect query performance, especially with OR operator, you can see one of the reasons for introducing\n\u003ca href=\"https://en.wikipedia.org/wiki/Stop_word\"\u003estopwords\u003c/a\u003e into search configuration. Words such as \u003cem\u003ethe\u003c/em\u003e are very common and on one hand they introduce practically\nno meaning at all to the query (with rare exceptions), matching almost all documents anyway, and on the other, they could add immense computational cost.\u003c/p\u003e\n\n\u003cp\u003eObviously, the longest postings list possible is the one containing all documents in the index. And indeed, pure negative queries such as\n“all documents but those with the word x” tend to be very expensive. Surprisingly, AND-ing the full set of documents (the result of a\n\u003ca href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.8/query-dsl-match-all-query.html\"\u003ematch_all query\u003c/a\u003e) with results of another query is very fast.\nThis is because of a \u003ca href=\"https://github.com/apache/lucene/blob/5e0e7a5479bca798ccfe385629a0ca2ba5870bc0/lucene/core/src/java/org/apache/lucene/search/BooleanQuery.java#L449\"\u003especial optimization\u003c/a\u003e\nwhich uses the identity \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eALL AND a = a\u003c/code\u003e to simplify those queries so that the expensive computation can be completely avoided.\nThis kind of query rewriting can transform a number of query patterns to queries with the same result but better performance characteristics.\nHowever, this only works for a set of rather simple cases: for example if you do not use \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ematch_all\u003c/code\u003e query, but create some other query which also happens\nto match all documents, this optimization will not be triggered. Complex query structure with subqueries can effectively disable such optimizations as well.\u003c/p\u003e\n\n\u003cp\u003eThinking about indexing and index segments, you have to notice that merging partial results from each segment is an operation similar to OR-ing (though it\nadditionally has to account for document removal and updates). This leads to the conclusion that having many segments hurts search performance, especially\nfor popular keywords whose postings lists are large to start with. Indeed, this actually happens. Performance may vary significantly depending on the number\nof segments, and the optimum is having just a single segment in your index. In Elastic, you can use the\n\u003ca href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.8/indices-forcemerge.html\"\u003eforce merge\u003c/a\u003e API to reduce the number of segments after indexing.\nI have actually worked with a product in which data was never indexed incrementally, but instead the whole index was rebuilt from scratch and force-merged to a single\nsegment after each update. This was a relatively small index with high search traffic, so big gains in search performance (on the order of two times shorter response\ntimes) were a justifiable reason for this seemingly wasteful indexation process.\u003c/p\u003e\n\n\u003ch2 id=\"complex-queries-in-disguise\"\u003eComplex queries in disguise\u003c/h2\u003e\n\n\u003cp\u003eSome queries seem simple, but are actually very complex for the search engine to handle. One example is prefix queries such as \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecat*\u003c/code\u003e (which matches documents\ncontaining any words starting with \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecat\u003c/code\u003e). It turns out that unless you do something special, such a query is likely to be handled as an OR-query with all words\nmatching the prefix: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e(cat OR catamaran OR catapult OR category OR ...)\u003c/code\u003e. Keeping in mind that queries with the OR operator can be expensive, you see the risk:\nthere may be lots and lots of words in the resulting expression, increasing the cost of merging their corresponding postings lists. In most datasets, a query such as \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ea*\u003c/code\u003e,\nwith probably thousands of individual postings lists, each containing millions of documents, can take ages to finish and even bring down the whole cluster.\u003c/p\u003e\n\n\u003cp\u003eAnother type of query that looks simple at first glance but can (or rather, used to) be very costly is range searches in numeric and date fields. Let’s say you want to limit\nyour query to only documents modified between 2020-01-01 and 2020-12-31. How costly could that be? The inverted index maps individual values to lists of\ndocument IDs. If each value in the index corresponds to a single day, and the documents are evenly spread throughout the year, there will be 366 lists to join\nwith the OR operator. If the data is indexed with millisecond resolution, there will be many more, with performance becoming even worse.\u003c/p\u003e\n\n\u003cp\u003eFortunately, these issues have been known for a long time, and there are a number of solutions in place. For text fields, you can enable\n\u003ca href=\"https://www.elastic.co/guide/en/elasticsearch/reference/6.8/index-prefixes.html\"\u003eprefix indexing\u003c/a\u003e which creates special structures in the index which\ncontain merged postings lists so that they don’t have to be computed at query time. Range queries on numeric and date fields are now optimized by default\nin Elasticsearch by creating \u003ca href=\"https://lucene.apache.org/core/2_9_4/api/core/org/apache/lucene/search/NumericRangeQuery.html#precisionStepDesc\"\u003eadditional structures in the index\u003c/a\u003e\nas well, though with a particularly nasty data set, you might still be able to trigger some issues. Note that these solutions are space-time tradeoffs\n(speeding up searches at the cost of larger index), and as with any tradeoff, there is always some risk of shooting yourself in the foot. Also, new versions\nintroduce new optimizations, so \u003ca href=\"https://www.elastic.co/blog/apache-lucene-numeric-filters\"\u003ebehavior may well change between ES versions\u003c/a\u003e.\nInterestingly, some preconceptions related to performance are very persistent (not only in the full-text search field), and you may run into people\nrecommending optimizations which made sense ten years ago, but may be counterproductive now. For example,\n\u003ca href=\"https://discuss.elastic.co/t/efficient-date-range-handling/3465\"\u003erange searches have been efficient for ten years\u003c/a\u003e, and apart from extreme cases, you should\nnot need to worry about them too much now.\u003c/p\u003e\n\n\u003cp\u003eAs a side note, ES tries to protect you from yourself and by default disables some types of queries that are likely to be costly: you have to\n\u003ca href=\"https://www.elastic.co/guide/en/elasticsearch/reference/7.x/query-dsl.html#query-dsl-allow-expensive-queries\"\u003eexplicitly enable them\u003c/a\u003e if you know what\nyou’re doing and want to use them.\u003c/p\u003e\n\n\u003ch2 id=\"returning-lots-of-search-results\"\u003eReturning lots of search results\u003c/h2\u003e\n\n\u003cp\u003eElasticsearch indexes may be huge, often searching millions and billions of documents, but usually only a tiny fraction of these documents match each query’s\ncriteria, and out of those, only a handful (10 or so) are returned to the end user. Increasing the number of documents returned is detrimental to search performance\nin many ways:\u003c/p\u003e\n\u003cul\u003e\n  \u003cli\u003eSome algorithms, such as \u003ca href=\"https://en.wikipedia.org/wiki/Partial_sorting\"\u003efinding the top N results\u003c/a\u003e when sorting, have complexity which depends on N:\nthey are faster if N is much smaller than the total number of matches, and become slower as N grows.\u003c/li\u003e\n  \u003cli\u003eSome operations a full-text search engine performs are proportional to the number of documents returned (linear complexity). As you remember, just finding matches is very fast since it\nuses inverted indices, but in order to actually return the documents’ contents, they have to be fetched from document store, and this operation scales linearly\nwith the number of documents returned. So, if you fetch 100 documents instead of 10, this part takes around ten times longer. Same goes for highlighting\nquery terms. The amount of data transferred over the network scales similarly.\u003c/li\u003e\n  \u003cli\u003eAggregations such as grouping documents by a field’s value may also have linear complexity (the number of documents returned being the input size).\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eAlso note that paging the results (e.g. retrieving 100 pages of 10 documents each instead of a single request asking for 1000 documents) helps only a little.\nThe problem is that in order to find documents on positions 991-1000, Elastic has to find the complete list of results 1-1000 first, and only then take the last\n10 items. This means the cost of fetching documents from storage is indeed proportional to 10, but the cost of performing set operations on postings lists\nand aggregations as well as memory usage is still proportional to 1000.\u003c/p\u003e\n\n\u003cp\u003eSo, if you think you can have millions of documents in ES and can just retrieve them all (or some large subset) using a simple query, you may be in for a surprise.\nThere are \u003ca href=\"https://www.elastic.co/guide/en/elasticsearch/reference/7.x/paginate-search-results.html\"\u003especialized APIs for such a use case\u003c/a\u003e, but they all have\ntheir limitations.\u003c/p\u003e\n\n\u003ch2 id=\"assuming-elastic-knows-as-much-about-your-data-as-you-do\"\u003eAssuming Elastic knows as much about your data as you do\u003c/h2\u003e\n\n\u003cp\u003eMuch of the discussion up to this point revolved around replacing boolean expressions with their equivalents that have different performance characteristics.\nSome of these transformations are always correct since both expressions can be proven equal by means of boolean algebra.\nHowever, sometimes two forms of a query are equivalent only within a specific data set. Despite many smart optimizations used by modern full-text search\nengines, by using knowledge about your dataset you can often achieve more in terms of increasing or decreasing search performance than by relying on\nmathematics alone.\u003c/p\u003e\n\n\u003cp\u003eA simple example of using this knowledge in practice is improving performance by removing subqueries which are redundant due to the nature of the data.\nSuppose your index contains both printed and online publications. Only online publications have a URL. By following the simplest logic, if you wanted to find\nan online publication by URL, you would issue a query such as \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etype:online AND url:value\u003c/code\u003e. This will work, although you could query just \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eurl:value\u003c/code\u003e as well.\nHowever, it requires that you know something about your data, namely that only online publications have any value set in the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eurl\u003c/code\u003e field.\nObviously, this simplified query will be faster than the original.\u003c/p\u003e\n\n\u003cp\u003eWhere you can’t avoid complex queries, you can still use your domain knowledge to improve or reduce performance. For example, since the cost of merge operations\ndepends on sizes of inputs, knowing that a particular subquery is likely to return many or few results (query selectivity) and modifying the query in a way\nin which the sizes of consecutive intermediate results diminish faster may boost performance, while relying only on Elastic’s optimizations may result in\nsub-par performance.\u003c/p\u003e\n\n\u003cp\u003eSuppose (a real-world example) there is an index with two types of documents whose counts differ wildly: documents of type 1 make up 99% of the index while\ntype 2 amounts to just 1% of all documents. Certain queries must be limited to just a single type. The obvious way to filter these results is to add a clause\nsuch as \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e... AND type:1\u003c/code\u003e and \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e... AND type:2\u003c/code\u003e, correspondingly, but replacing the first one with \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e... AND NOT type:2\u003c/code\u003e may be faster since the results list for\ntype 2 is much shorter than for type 1. If the filters can be combined (e.g. by the user checking checkboxes in a GUI), and the user selects both types,\nmeaning effectively no filtering by type, it is probably much more efficient to simply remove the filter from the query than to add a \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e... AND (type:1 OR type:2)\u003c/code\u003e\nclause.\u003c/p\u003e\n\n\u003cp\u003eAs you may have already realized, not only boolean queries’ but also range queries’ performance may depend a lot on your data, for example on a field’s\ncardinality (the number of unique values). One of the more spectacular ways of shooting yourself in the foot is applying a pattern which normally helps\nperformance, but in your particular case, due to a specific distribution of a field’s values, does just the opposite. Such situations may be very difficult\nto discover if you do not precisely track performance before and after each significant change. Sneakily placing such a pattern in your code can be a great way\nto end up with low performance difficult to explain.\u003c/p\u003e\n\n\u003cp\u003eFor a real life example, consider the rule of thumb that if you don’t care about a subquery’s score, using \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efilter\u003c/code\u003e subqueries within a \u003ca href=\"https://www.elastic.co/guide/en/elasticsearch/reference/7.x/query-dsl-bool-query.html\"\u003ebool query\u003c/a\u003e\nresults in faster response times than using \u003ccode class=\"language-plaintext highlighter-rouge\"\u003emust\u003c/code\u003e subqueries since the former \u003ca href=\"https://www.elastic.co/guide/en/elasticsearch/reference/7.x/query-filter-context.html\"\u003edo not need to update matching documents’ scores\u003c/a\u003e.\nIn our advertising system, we match ads in a way mostly consistent with the way we match organic results. We match ads by keywords, but we also take\ninto account criteria such as delivery methods selected by the user. In the latter case, the fact that a sponsored offer\nis available with some delivery method only affects which offers match, but does not affect their scores. This is a perfect use case for \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efilter\u003c/code\u003e queries.\nHowever, we also use \u003ca href=\"https://www.elastic.co/guide/en/elasticsearch/reference/7.x/query-dsl-function-score-query.html\"\u003efunction score query\u003c/a\u003e.\nFunction score query allows us to combine a document’s score resulting from how well it matches our keywords with additional factors.\nFunction score query accepts an embedded query — only documents matching this query have their scores modified. Symbolically, we could express it as our\ncomplete query being: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efunction_score_query(keyword_subquery AND filters_subquery)\u003c/code\u003e. At one point, I wanted to optimize the performance of this query, and\nfollowing the abovementioned rule of thumb, thought that it would make sense to move \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efilters_subquery\u003c/code\u003e outside of \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efunction_score_query\u003c/code\u003e since filters need\nnot participate in score calculations. This resulted in the query \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efilters_subquery AND function_score_query(keyword_subquery)\u003c/code\u003e and should have\nimproved search performance. However, upon running performance tests, to my surprise I realized these changes actually made performance worse. The reason was,\nwith the filters moved outside \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efunction_score_query\u003c/code\u003e, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efunction_score_query\u003c/code\u003e had to modify the scores of a larger number of documents and for the particular\ndata I had in my index, the added cost of rescoring more documents was greater than the savings achieved by not having to calculate the score for these\ndocuments in the first place. This just shows that with performance tuning, \u003ca href=\"https://en.wiktionary.org/wiki/your_mileage_may_vary\"\u003eYMMV\u003c/a\u003e, always.\u003c/p\u003e\n\n\u003ch2 id=\"treating-search-and-indexing-as-two-separate-problems\"\u003eTreating search and indexing as two separate problems\u003c/h2\u003e\n\n\u003cp\u003eYou might be tempted to think of Elasticsearch as yet another database. If you do, you are likely to run into many issues, including performance problems.\nOne of the main things that set ES apart from most databases, whether they be SQL or NoSQL, is the\n\u003ca href=\"https://www.elastic.co/guide/en/elasticsearch/reference/7.x/near-real-time.html\"\u003esearch-indexing asymmetry\u003c/a\u003e.\nIn contrast to a normal database, in Elasticsearch you can’t just insert a bunch of documents: this process triggers indexing, creates new segments, potentially\ntriggers segment merges, has to \u003ca href=\"https://www.alibabacloud.com/blog/elasticsearch-distributed-consistency-principles-analysis-3---data_594360\"\u003epropagate replicas and handle consistency within the cluster\u003c/a\u003e,\netc. This may all affect performance in interesting ways. While indices of some kind are used in pretty much all databases, in ES they play\na central role. Another important difference to databases is that Elastic data model favors, and often forces, very much denormalized data. This is\ncommon with NoSQL databases but in ES, it is even more extreme.\u003c/p\u003e\n\n\u003cp\u003eIn particular, since ES is — in most cases — more about search performance than anything else, it is a common optimization to move cost from search time to\nindexing time when possible, and many such optimizations result in an even more denormalized data model.\u003c/p\u003e\n\n\u003cp\u003eFor example, let’s consider an index of offers such as you may find in an online store. Each offer may be available with a free return option, but\nthere’s a catch: while the client only sees a single checkbox in the UI, internally there are several types of free returns, e.g. free return by package locker\nand free return by post. The natural way to handle this would be to index each of these two flags and then to search for offers having either of those flags.\nIt would also be a step towards our goal of ruining Elasticsearch search performance, especially if the number of values was 200 rather than 2.\u003c/p\u003e\n\n\u003cp\u003eThe reason it works this way is that there are lots and lots of offers matching any of these flags: probably around 90% match one and around 90% match the other\n(with, obviously, a large number matching both). Going back to the \u003ca href=\"/2021/09/how-to-ruin-elasticsearch-performance-part-i.html#or-operator\"\u003esection about OR operator\u003c/a\u003e, you will notice that having two very long\ninput lists is about the worst case for OR operator efficiency. A usually reasonable trade-off in such a case is to move the cost to indexing-time, and\nto index with the document just a single flag, “free return”, which will improve search performance (at the cost of reducing indexing performance by just a tiny amount).\nNote that this was a very simple case and sometimes indexing denormalized data may increase index size significantly, in which case the trade-off may become\nless obvious.\u003c/p\u003e\n\n\u003cp\u003eAnother quirk is the mutual interaction between indexing and search performance. Interaction between reads and writes happens in practically any database,\nbut with Elastic, it is easier for it to become an issue due to the relatively high CPU and I/O cost of indexing. Ignoring this fact and treating\nsearch and indexing performance as two independent issues is a recipe for poor performance in both areas.\u003c/p\u003e\n\n\u003ch2 id=\"jumping-right-into-optimization-without-checking-first\"\u003eJumping right into optimization without checking first\u003c/h2\u003e\n\n\u003cp\u003eOne effective method of achieving inferior performance, which works not only with Elasticsearch, is jumping\nright into optimization without first analyzing the problem, and, even better, not checking if there is a problem at all. It is a boring thing to repeat\nover and over, but the only way to improve performance is to:\u003c/p\u003e\n\u003cul\u003e\n  \u003cli\u003efirst, measure the baseline you are starting from (avoiding common pitfalls along the way),\u003c/li\u003e\n  \u003cli\u003edecide whether the values are satisfactory or not,\u003c/li\u003e\n  \u003cli\u003edefine target values if they are not, and\u003c/li\u003e\n  \u003cli\u003esystematically measure and improve until success or surrender.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eOptimizing without \u003ca href=\"https://esrally.readthedocs.io/en/stable/\"\u003emeasurement\u003c/a\u003e and without defining goals, on the other hand, is a good method of wasting your time, and consequently, achieving sub-par\nperformance. While there are some simple improvements which amount to “don’t do stupid things” and can be applied practically always without any risk,\nmost are trade-offs: you gain something at the expense of something else. If you apply them inappropriately, you may end up with expenses but without the gains.\nMany optimizations’ effectiveness varies a lot depending on the kind of data in the index or specific query patterns generated by your users, so, for example\nyou may introduce an optimization whose effect is negligible, but whose cost (e.g. in increased complexity and thus maintenance cost) is significant.\u003c/p\u003e\n\n\u003ch2 id=\"blindly-trusting-what-you-read-on-the-web\"\u003eBlindly trusting what you read on the web\u003c/h2\u003e\n\n\u003cp\u003eThis leads us to the last tip: if you really want to ruin your ES performance, always trust strangers on the internet and apply their advice\nduly and without hesitation. Obviously, this applies to this very post as well. Another good practice is to never check publication dates, or the ES versions\nthat particular tips apply to.\u003c/p\u003e\n\n\u003ch2 id=\"summary\"\u003eSummary\u003c/h2\u003e\n\n\u003cp\u003eI hope \u003ca href=\"/2021/09/how-to-ruin-elasticsearch-performance-part-i.html\"\u003ePart I\u003c/a\u003e gave you some background on how Elastic works under the hood. In Part II, we discussed various techniques which can affect its performance in\nreal-world scenarios. Armed with this knowledge, you will be able to make or break Elasticsearch performance: the choice is yours.\u003c/p\u003e\n","contentSnippet":"It’s easy to find resources about improving Elasticsearch performance, but what if you wanted to reduce it?\nIn Part I of this two-part series we looked under the hood in order to learn how\nES works internally. Now, in Part II, is the time to apply this knowledge in practice and ruin our ES performance. Most tips should also be applicable to\nSolr, raw Lucene, or, for that matter, to any other full-text search engine as well.\nUsing complex boolean queries\nA consequence of the algorithms outlined in Part I is that simple queries, such as finding\na document containing two or three specific words, are relatively cheap to compute. We can easily increase the cost by making the queries more complex. This\ncomplexity is easily achieved by using boolean queries which allow\narbitrary boolean expressions, including nested subexpressions.\nA “flat” query, even with many words, boils down to a single AND/OR operation (though potentially with many lists). Since a search engine is usually\nsmart enough to sort these lists by length, it can execute such queries really fast. But what happens if we use a complex boolean expression? Let’s compare\ntwo example queries:\nQ1: find books which contain all of the words: “I like apples”\nQ2: find books which contain all of the words: “I like apples” or “I like oranges” and were published in 2020 or 2021 and are at least 100 pages long\nLet us now look at the boolean expressions which correspond to these queries:\nQ1: I AND like AND apples\nQ2: ((I AND like AND apples) OR (I AND like AND oranges)) AND (2020 OR 2021) AND (pages \u003e= 100)\nClearly, there is much more stuff to compute in the case of Q2, and the query will take more time, accordingly. Even though from the end user’s perspective,\nwe only added a few filters, the complexity of the query rose dramatically. For Q1, we need to perform 2 AND operations. For Q2, we end up with\n6 AND operations and 2 OR operations. However, this query is probably still much worse for performance than it may seem.\nLet’s start analyzing this query from the bottom up.\nThe expression 2020 OR 2021 is a little gem that looks innocent, but is actually quite expensive. As you remember, the cost of an OR operation is proportional\nto the sum of the sizes of input lists. The lists of books published in a year are probably quite long, so the cost of merging two will be quite high.\nAs a bonus, we get an even longer list as a result and this long list will take part in any computations that follow. So here are the takeaways:\nOR operations are costly,\neven more so when inputs are large document sets;\nsubqueries (parentheses in the logical expression) cause temporary postings lists to be created, which then take part in further calculations and so their\nsizes affect query performance.\nLooking further at our query, we see that even more temporary document ID lists will have to be created: one for each pair of parentheses. These results have\nto be computed, and since they are temporary partial results, they will have to be stored in memory since they cannot be retrieved from the index directly.\nAlso note that subqueries can hinder many optimizations search engines employ. I mentioned earlier that Lucene sorts postings lists by length when AND-ing\nthem together. This can only work reliably if list lengths are known. For a postings list of a single word, its length is stored in the index and known exactly\nup-front. For a nested subexpression, however, the number of matches is not known before the subexpression is evaluated. But, Lucene needs the number of matches\nin order to prepare the optimal query plan. This leads to a chicken-and-egg problem which Lucene solves by estimating the size of subquery results list based\non the sizes of its constituents. For example, it estimates the result size of a subquery with OR-s as the sum of its input sizes. Being just an estimate, this\nnumber may differ from the actual value, and thus cause suboptimal query performance further up the stack. Takeaway:\nsubqueries are great at hindering global query optimizations.\nAnother reason why subqueries may negatively affect performance becomes apparent with queries such as (a AND b) AND (c AND d). Since AND is an associative\noperation, the expression above gives the same result as a AND b AND c AND d. In the\nversion without parentheses, the optimization of sorting lists by size works globally since all inputs are at the same nesting level, potentially achieving\nbetter performance than the version with nested subexpressions which can only sort the lists within each pair of parentheses separately.\nYou may wonder why anyone would add these parentheses, but such constructs may arise naturally due to the way your code is structured if individual subqueries\nare built by separate methods or classes because they serve different business needs.\nLooking at how long postings lists affect query performance, especially with OR operator, you can see one of the reasons for introducing\nstopwords into search configuration. Words such as the are very common and on one hand they introduce practically\nno meaning at all to the query (with rare exceptions), matching almost all documents anyway, and on the other, they could add immense computational cost.\nObviously, the longest postings list possible is the one containing all documents in the index. And indeed, pure negative queries such as\n“all documents but those with the word x” tend to be very expensive. Surprisingly, AND-ing the full set of documents (the result of a\nmatch_all query) with results of another query is very fast.\nThis is because of a special optimization\nwhich uses the identity ALL AND a = a to simplify those queries so that the expensive computation can be completely avoided.\nThis kind of query rewriting can transform a number of query patterns to queries with the same result but better performance characteristics.\nHowever, this only works for a set of rather simple cases: for example if you do not use match_all query, but create some other query which also happens\nto match all documents, this optimization will not be triggered. Complex query structure with subqueries can effectively disable such optimizations as well.\nThinking about indexing and index segments, you have to notice that merging partial results from each segment is an operation similar to OR-ing (though it\nadditionally has to account for document removal and updates). This leads to the conclusion that having many segments hurts search performance, especially\nfor popular keywords whose postings lists are large to start with. Indeed, this actually happens. Performance may vary significantly depending on the number\nof segments, and the optimum is having just a single segment in your index. In Elastic, you can use the\nforce merge API to reduce the number of segments after indexing.\nI have actually worked with a product in which data was never indexed incrementally, but instead the whole index was rebuilt from scratch and force-merged to a single\nsegment after each update. This was a relatively small index with high search traffic, so big gains in search performance (on the order of two times shorter response\ntimes) were a justifiable reason for this seemingly wasteful indexation process.\nComplex queries in disguise\nSome queries seem simple, but are actually very complex for the search engine to handle. One example is prefix queries such as cat* (which matches documents\ncontaining any words starting with cat). It turns out that unless you do something special, such a query is likely to be handled as an OR-query with all words\nmatching the prefix: (cat OR catamaran OR catapult OR category OR ...). Keeping in mind that queries with the OR operator can be expensive, you see the risk:\nthere may be lots and lots of words in the resulting expression, increasing the cost of merging their corresponding postings lists. In most datasets, a query such as a*,\nwith probably thousands of individual postings lists, each containing millions of documents, can take ages to finish and even bring down the whole cluster.\nAnother type of query that looks simple at first glance but can (or rather, used to) be very costly is range searches in numeric and date fields. Let’s say you want to limit\nyour query to only documents modified between 2020-01-01 and 2020-12-31. How costly could that be? The inverted index maps individual values to lists of\ndocument IDs. If each value in the index corresponds to a single day, and the documents are evenly spread throughout the year, there will be 366 lists to join\nwith the OR operator. If the data is indexed with millisecond resolution, there will be many more, with performance becoming even worse.\nFortunately, these issues have been known for a long time, and there are a number of solutions in place. For text fields, you can enable\nprefix indexing which creates special structures in the index which\ncontain merged postings lists so that they don’t have to be computed at query time. Range queries on numeric and date fields are now optimized by default\nin Elasticsearch by creating additional structures in the index\nas well, though with a particularly nasty data set, you might still be able to trigger some issues. Note that these solutions are space-time tradeoffs\n(speeding up searches at the cost of larger index), and as with any tradeoff, there is always some risk of shooting yourself in the foot. Also, new versions\nintroduce new optimizations, so behavior may well change between ES versions.\nInterestingly, some preconceptions related to performance are very persistent (not only in the full-text search field), and you may run into people\nrecommending optimizations which made sense ten years ago, but may be counterproductive now. For example,\nrange searches have been efficient for ten years, and apart from extreme cases, you should\nnot need to worry about them too much now.\nAs a side note, ES tries to protect you from yourself and by default disables some types of queries that are likely to be costly: you have to\nexplicitly enable them if you know what\nyou’re doing and want to use them.\nReturning lots of search results\nElasticsearch indexes may be huge, often searching millions and billions of documents, but usually only a tiny fraction of these documents match each query’s\ncriteria, and out of those, only a handful (10 or so) are returned to the end user. Increasing the number of documents returned is detrimental to search performance\nin many ways:\nSome algorithms, such as finding the top N results when sorting, have complexity which depends on N:\nthey are faster if N is much smaller than the total number of matches, and become slower as N grows.\nSome operations a full-text search engine performs are proportional to the number of documents returned (linear complexity). As you remember, just finding matches is very fast since it\nuses inverted indices, but in order to actually return the documents’ contents, they have to be fetched from document store, and this operation scales linearly\nwith the number of documents returned. So, if you fetch 100 documents instead of 10, this part takes around ten times longer. Same goes for highlighting\nquery terms. The amount of data transferred over the network scales similarly.\nAggregations such as grouping documents by a field’s value may also have linear complexity (the number of documents returned being the input size).\nAlso note that paging the results (e.g. retrieving 100 pages of 10 documents each instead of a single request asking for 1000 documents) helps only a little.\nThe problem is that in order to find documents on positions 991-1000, Elastic has to find the complete list of results 1-1000 first, and only then take the last\n10 items. This means the cost of fetching documents from storage is indeed proportional to 10, but the cost of performing set operations on postings lists\nand aggregations as well as memory usage is still proportional to 1000.\nSo, if you think you can have millions of documents in ES and can just retrieve them all (or some large subset) using a simple query, you may be in for a surprise.\nThere are specialized APIs for such a use case, but they all have\ntheir limitations.\nAssuming Elastic knows as much about your data as you do\nMuch of the discussion up to this point revolved around replacing boolean expressions with their equivalents that have different performance characteristics.\nSome of these transformations are always correct since both expressions can be proven equal by means of boolean algebra.\nHowever, sometimes two forms of a query are equivalent only within a specific data set. Despite many smart optimizations used by modern full-text search\nengines, by using knowledge about your dataset you can often achieve more in terms of increasing or decreasing search performance than by relying on\nmathematics alone.\nA simple example of using this knowledge in practice is improving performance by removing subqueries which are redundant due to the nature of the data.\nSuppose your index contains both printed and online publications. Only online publications have a URL. By following the simplest logic, if you wanted to find\nan online publication by URL, you would issue a query such as type:online AND url:value. This will work, although you could query just url:value as well.\nHowever, it requires that you know something about your data, namely that only online publications have any value set in the url field.\nObviously, this simplified query will be faster than the original.\nWhere you can’t avoid complex queries, you can still use your domain knowledge to improve or reduce performance. For example, since the cost of merge operations\ndepends on sizes of inputs, knowing that a particular subquery is likely to return many or few results (query selectivity) and modifying the query in a way\nin which the sizes of consecutive intermediate results diminish faster may boost performance, while relying only on Elastic’s optimizations may result in\nsub-par performance.\nSuppose (a real-world example) there is an index with two types of documents whose counts differ wildly: documents of type 1 make up 99% of the index while\ntype 2 amounts to just 1% of all documents. Certain queries must be limited to just a single type. The obvious way to filter these results is to add a clause\nsuch as ... AND type:1 and ... AND type:2, correspondingly, but replacing the first one with ... AND NOT type:2 may be faster since the results list for\ntype 2 is much shorter than for type 1. If the filters can be combined (e.g. by the user checking checkboxes in a GUI), and the user selects both types,\nmeaning effectively no filtering by type, it is probably much more efficient to simply remove the filter from the query than to add a ... AND (type:1 OR type:2)\nclause.\nAs you may have already realized, not only boolean queries’ but also range queries’ performance may depend a lot on your data, for example on a field’s\ncardinality (the number of unique values). One of the more spectacular ways of shooting yourself in the foot is applying a pattern which normally helps\nperformance, but in your particular case, due to a specific distribution of a field’s values, does just the opposite. Such situations may be very difficult\nto discover if you do not precisely track performance before and after each significant change. Sneakily placing such a pattern in your code can be a great way\nto end up with low performance difficult to explain.\nFor a real life example, consider the rule of thumb that if you don’t care about a subquery’s score, using filter subqueries within a bool query\nresults in faster response times than using must subqueries since the former do not need to update matching documents’ scores.\nIn our advertising system, we match ads in a way mostly consistent with the way we match organic results. We match ads by keywords, but we also take\ninto account criteria such as delivery methods selected by the user. In the latter case, the fact that a sponsored offer\nis available with some delivery method only affects which offers match, but does not affect their scores. This is a perfect use case for filter queries.\nHowever, we also use function score query.\nFunction score query allows us to combine a document’s score resulting from how well it matches our keywords with additional factors.\nFunction score query accepts an embedded query — only documents matching this query have their scores modified. Symbolically, we could express it as our\ncomplete query being: function_score_query(keyword_subquery AND filters_subquery). At one point, I wanted to optimize the performance of this query, and\nfollowing the abovementioned rule of thumb, thought that it would make sense to move filters_subquery outside of function_score_query since filters need\nnot participate in score calculations. This resulted in the query filters_subquery AND function_score_query(keyword_subquery) and should have\nimproved search performance. However, upon running performance tests, to my surprise I realized these changes actually made performance worse. The reason was,\nwith the filters moved outside function_score_query, function_score_query had to modify the scores of a larger number of documents and for the particular\ndata I had in my index, the added cost of rescoring more documents was greater than the savings achieved by not having to calculate the score for these\ndocuments in the first place. This just shows that with performance tuning, YMMV, always.\nTreating search and indexing as two separate problems\nYou might be tempted to think of Elasticsearch as yet another database. If you do, you are likely to run into many issues, including performance problems.\nOne of the main things that set ES apart from most databases, whether they be SQL or NoSQL, is the\nsearch-indexing asymmetry.\nIn contrast to a normal database, in Elasticsearch you can’t just insert a bunch of documents: this process triggers indexing, creates new segments, potentially\ntriggers segment merges, has to propagate replicas and handle consistency within the cluster,\netc. This may all affect performance in interesting ways. While indices of some kind are used in pretty much all databases, in ES they play\na central role. Another important difference to databases is that Elastic data model favors, and often forces, very much denormalized data. This is\ncommon with NoSQL databases but in ES, it is even more extreme.\nIn particular, since ES is — in most cases — more about search performance than anything else, it is a common optimization to move cost from search time to\nindexing time when possible, and many such optimizations result in an even more denormalized data model.\nFor example, let’s consider an index of offers such as you may find in an online store. Each offer may be available with a free return option, but\nthere’s a catch: while the client only sees a single checkbox in the UI, internally there are several types of free returns, e.g. free return by package locker\nand free return by post. The natural way to handle this would be to index each of these two flags and then to search for offers having either of those flags.\nIt would also be a step towards our goal of ruining Elasticsearch search performance, especially if the number of values was 200 rather than 2.\nThe reason it works this way is that there are lots and lots of offers matching any of these flags: probably around 90% match one and around 90% match the other\n(with, obviously, a large number matching both). Going back to the section about OR operator, you will notice that having two very long\ninput lists is about the worst case for OR operator efficiency. A usually reasonable trade-off in such a case is to move the cost to indexing-time, and\nto index with the document just a single flag, “free return”, which will improve search performance (at the cost of reducing indexing performance by just a tiny amount).\nNote that this was a very simple case and sometimes indexing denormalized data may increase index size significantly, in which case the trade-off may become\nless obvious.\nAnother quirk is the mutual interaction between indexing and search performance. Interaction between reads and writes happens in practically any database,\nbut with Elastic, it is easier for it to become an issue due to the relatively high CPU and I/O cost of indexing. Ignoring this fact and treating\nsearch and indexing performance as two independent issues is a recipe for poor performance in both areas.\nJumping right into optimization without checking first\nOne effective method of achieving inferior performance, which works not only with Elasticsearch, is jumping\nright into optimization without first analyzing the problem, and, even better, not checking if there is a problem at all. It is a boring thing to repeat\nover and over, but the only way to improve performance is to:\nfirst, measure the baseline you are starting from (avoiding common pitfalls along the way),\ndecide whether the values are satisfactory or not,\ndefine target values if they are not, and\nsystematically measure and improve until success or surrender.\nOptimizing without measurement and without defining goals, on the other hand, is a good method of wasting your time, and consequently, achieving sub-par\nperformance. While there are some simple improvements which amount to “don’t do stupid things” and can be applied practically always without any risk,\nmost are trade-offs: you gain something at the expense of something else. If you apply them inappropriately, you may end up with expenses but without the gains.\nMany optimizations’ effectiveness varies a lot depending on the kind of data in the index or specific query patterns generated by your users, so, for example\nyou may introduce an optimization whose effect is negligible, but whose cost (e.g. in increased complexity and thus maintenance cost) is significant.\nBlindly trusting what you read on the web\nThis leads us to the last tip: if you really want to ruin your ES performance, always trust strangers on the internet and apply their advice\nduly and without hesitation. Obviously, this applies to this very post as well. Another good practice is to never check publication dates, or the ES versions\nthat particular tips apply to.\nSummary\nI hope Part I gave you some background on how Elastic works under the hood. In Part II, we discussed various techniques which can affect its performance in\nreal-world scenarios. Armed with this knowledge, you will be able to make or break Elasticsearch performance: the choice is yours.","guid":"https://blog.allegro.tech/2021/10/how-to-ruin-elasticsearch-performance-part-ii.html","categories":["tech","full-text search","elasticsearch","elastic","es","performance"],"isoDate":"2021-10-06T22:00:00.000Z","thumbnail":"images/post-headers/default.jpg"}],"jobs":[{"id":"743999785422127","name":"Research Engineer - Machine Learning (Reinforcement Learning)","uuid":"229d607a-333b-431b-9abe-78137730f5fd","refNumber":"REF2881V","company":{"identifier":"Allegro","name":"Allegro"},"releasedDate":"2021-11-08T09:56:17.000Z","location":{"city":"Warszawa, Kraków, Poznań, Toruń, Wrocław, Gdańsk, Katowice, Łódź, Lublin","country":"pl","remote":false},"industry":{"id":"internet","label":"Internet"},"department":{"id":"2572821","label":"IT - Machine Learning"},"function":{"id":"information_technology","label":"Information Technology"},"typeOfEmployment":{"label":"Full-time"},"experienceLevel":{"id":"mid_senior_level","label":"Mid-Senior Level"},"customField":[{"fieldId":"606235fe248e6f5bea0815ed","fieldLabel":"Katowice","valueId":"185eb5a9-b884-4ee8-8ebc-0e5f3e852b27","valueLabel":"Tak"},{"fieldId":"58c1575ee4b01d4b19ddf797","fieldLabel":"Kraków","valueId":"2cfcfcc1-da44-43f7-8eaa-3907faf2797c","valueLabel":"Tak"},{"fieldId":"606235bcefbac7156d6a470a","fieldLabel":"Łódź","valueId":"7d33e23d-3fa7-4d7d-86ae-7d7caff54fa9","valueLabel":"Tak"},{"fieldId":"58c158e9e4b0614667d5973e","fieldLabel":"Więcej lokalizacji","valueId":"3a186e8d-a82c-4955-af81-fcef9a63928a","valueLabel":"Tak"},{"fieldId":"58c1576ee4b0614667d59732","fieldLabel":"Toruń","valueId":"987e8884-bad1-4a8f-b149-99e4184cc221","valueLabel":"Tak"},{"fieldId":"6165609ee6b46b6506c66b63","fieldLabel":"Gdańsk","valueId":"cde0f8e7-5c9d-4d78-9f5c-e1c17ee499a8","valueLabel":"Tak"},{"fieldId":"58c156e6e4b01d4b19ddf793","fieldLabel":"Warszawa","valueId":"6a428533-1586-4372-89ec-65fb45366363","valueLabel":"Tak"},{"fieldId":"58c15608e4b01d4b19ddf790","fieldLabel":"Proces rekrutacji","valueId":"c807eec2-8a53-4b55-b7c5-c03180f2059b","valueLabel":"(Archive) IT Allegro"},{"fieldId":"COUNTRY","fieldLabel":"Country","valueId":"pl","valueLabel":"Poland"},{"fieldId":"58c15788e4b0614667d59733","fieldLabel":"Błonie","valueId":"25f6cb8c-81b3-434a-93ec-6dc851d5808d","valueLabel":"Nie"},{"fieldId":"58c15798e4b01d4b19ddf79b","fieldLabel":"Wrocław","valueId":"64818201-cdba-422e-8e8c-8ec633b0d327","valueLabel":"Tak"},{"fieldId":"58c13159e4b01d4b19ddf729","fieldLabel":"Department","valueId":"2572821","valueLabel":"IT - Machine Learning"},{"fieldId":"58c13159e4b01d4b19ddf728","fieldLabel":"Brands","valueId":"4ccb4fab-6c3f-4ed0-9140-8533fe17447f","valueLabel":"Allegro.pl sp. z o.o."},{"fieldId":"61656102a169ed164d546c31","fieldLabel":"Lublin","valueId":"02d54f00-48b9-4669-b7b3-10c16ac4bada","valueLabel":"Tak"},{"fieldId":"58c156b9e4b01d4b19ddf792","fieldLabel":"Poznań","valueId":"ac20917b-cb6a-4280-aff3-4fae2532a33e","valueLabel":"Tak"},{"fieldId":"5cdab2c84cedfd0006e7758c","fieldLabel":"Key words","valueLabel":"ML, Machine Learning, Python, Deep Learning, AI, Artificial Intelligence"}],"ref":"https://api.smartrecruiters.com/v1/companies/allegro/postings/743999785422127","creator":{"name":"Maciej Matwiejczyk"},"language":{"code":"en","label":"English","labelNative":"English (US)"}},{"id":"743999785421861","name":"Research Engineer - Machine Learning (Ranking and Recommendations)","uuid":"a6b2b59e-28e3-4bfa-89ab-b13ab97f06c8","refNumber":"REF2990T","company":{"identifier":"Allegro","name":"Allegro"},"releasedDate":"2021-11-08T09:54:52.000Z","location":{"city":"Warszawa, Poznań, Kraków, Toruń, Wrocław, Gdańsk, Katowice, Łódź, Lublin","country":"pl","remote":false},"industry":{"id":"internet","label":"Internet"},"department":{"id":"2572821","label":"IT - Machine Learning"},"function":{"id":"information_technology","label":"Information Technology"},"typeOfEmployment":{"label":"Full-time"},"experienceLevel":{"id":"mid_senior_level","label":"Mid-Senior Level"},"customField":[{"fieldId":"58c1575ee4b01d4b19ddf797","fieldLabel":"Kraków","valueId":"2cfcfcc1-da44-43f7-8eaa-3907faf2797c","valueLabel":"Tak"},{"fieldId":"58c158e9e4b0614667d5973e","fieldLabel":"Więcej lokalizacji","valueId":"3a186e8d-a82c-4955-af81-fcef9a63928a","valueLabel":"Tak"},{"fieldId":"58c1576ee4b0614667d59732","fieldLabel":"Toruń","valueId":"987e8884-bad1-4a8f-b149-99e4184cc221","valueLabel":"Tak"},{"fieldId":"58c156e6e4b01d4b19ddf793","fieldLabel":"Warszawa","valueId":"6a428533-1586-4372-89ec-65fb45366363","valueLabel":"Tak"},{"fieldId":"60cb31a9c87e511299a3a050","fieldLabel":"Department II","valueId":"b8a4596e-d9ce-42bb-8de5-10995e9ccf99","valueLabel":"IT - Machine Learning"},{"fieldId":"58c15608e4b01d4b19ddf790","fieldLabel":"Proces rekrutacji","valueId":"c807eec2-8a53-4b55-b7c5-c03180f2059b","valueLabel":"(Archive) IT Allegro"},{"fieldId":"COUNTRY","fieldLabel":"Country","valueId":"pl","valueLabel":"Poland"},{"fieldId":"58c15788e4b0614667d59733","fieldLabel":"Błonie","valueId":"25f6cb8c-81b3-434a-93ec-6dc851d5808d","valueLabel":"Nie"},{"fieldId":"58c15798e4b01d4b19ddf79b","fieldLabel":"Wrocław","valueId":"64818201-cdba-422e-8e8c-8ec633b0d327","valueLabel":"Tak"},{"fieldId":"58c13159e4b01d4b19ddf729","fieldLabel":"Department","valueId":"2572821","valueLabel":"IT - Machine Learning"},{"fieldId":"58c13159e4b01d4b19ddf728","fieldLabel":"Brands","valueId":"4ccb4fab-6c3f-4ed0-9140-8533fe17447f","valueLabel":"Allegro.pl sp. z o.o."},{"fieldId":"58c156b9e4b01d4b19ddf792","fieldLabel":"Poznań","valueId":"ac20917b-cb6a-4280-aff3-4fae2532a33e","valueLabel":"Tak"},{"fieldId":"5cdab2c84cedfd0006e7758c","fieldLabel":"Key words","valueLabel":"ML, AI, Ranking, Research, Machine Learning"}],"ref":"https://api.smartrecruiters.com/v1/companies/allegro/postings/743999785421861","creator":{"name":"Maciej Matwiejczyk"},"language":{"code":"en","label":"English","labelNative":"English (US)"}},{"id":"743999782019147","name":"IT Security Specialist","uuid":"3c61af42-98a1-4b48-ae1f-dc9b2c60a0fa","refNumber":"REF2548W","company":{"identifier":"Allegro","name":"Allegro"},"releasedDate":"2021-10-27T10:32:45.000Z","location":{"city":"Warszawa, Poznań, Kraków, Wrocław, Toruń, Gdańsk, Lublin, Łódź, Katowice","country":"pl","remote":false},"industry":{"id":"internet","label":"Internet"},"department":{"id":"2572787","label":"IT - Technical Platform"},"function":{"id":"information_technology","label":"Information Technology"},"typeOfEmployment":{"label":"Full-time"},"experienceLevel":{"id":"mid_senior_level","label":"Mid-Senior Level"},"customField":[{"fieldId":"606235fe248e6f5bea0815ed","fieldLabel":"Katowice","valueId":"185eb5a9-b884-4ee8-8ebc-0e5f3e852b27","valueLabel":"Tak"},{"fieldId":"58c1575ee4b01d4b19ddf797","fieldLabel":"Kraków","valueId":"2cfcfcc1-da44-43f7-8eaa-3907faf2797c","valueLabel":"Tak"},{"fieldId":"606235bcefbac7156d6a470a","fieldLabel":"Łódź","valueId":"7d33e23d-3fa7-4d7d-86ae-7d7caff54fa9","valueLabel":"Tak"},{"fieldId":"58c158e9e4b0614667d5973e","fieldLabel":"Więcej lokalizacji","valueId":"3a186e8d-a82c-4955-af81-fcef9a63928a","valueLabel":"Tak"},{"fieldId":"58c1576ee4b0614667d59732","fieldLabel":"Toruń","valueId":"987e8884-bad1-4a8f-b149-99e4184cc221","valueLabel":"Tak"},{"fieldId":"612f4406198fc8471029176c","fieldLabel":"Initiative","valueId":"3a0d7379-96c9-4a23-95fe-db3c6653e44b","valueLabel":"not  appilcable"},{"fieldId":"58c156e6e4b01d4b19ddf793","fieldLabel":"Warszawa","valueId":"6a428533-1586-4372-89ec-65fb45366363","valueLabel":"Tak"},{"fieldId":"60cb31a9c87e511299a3a050","fieldLabel":"Department II","valueId":"faf591d7-af03-4d05-b67e-dba247924756","valueLabel":"IT - Other"},{"fieldId":"58c15608e4b01d4b19ddf790","fieldLabel":"Proces rekrutacji","valueId":"c807eec2-8a53-4b55-b7c5-c03180f2059b","valueLabel":"(Archive) IT Allegro"},{"fieldId":"COUNTRY","fieldLabel":"Country","valueId":"pl","valueLabel":"Poland"},{"fieldId":"58c15798e4b01d4b19ddf79b","fieldLabel":"Wrocław","valueId":"64818201-cdba-422e-8e8c-8ec633b0d327","valueLabel":"Tak"},{"fieldId":"58c13159e4b01d4b19ddf729","fieldLabel":"Department","valueId":"2572787","valueLabel":"IT - Technical Platform"},{"fieldId":"58c13159e4b01d4b19ddf728","fieldLabel":"Brands","valueId":"4ccb4fab-6c3f-4ed0-9140-8533fe17447f","valueLabel":"Allegro.pl sp. z o.o."},{"fieldId":"58c156b9e4b01d4b19ddf792","fieldLabel":"Poznań","valueId":"ac20917b-cb6a-4280-aff3-4fae2532a33e","valueLabel":"Tak"},{"fieldId":"5cdab2c84cedfd0006e7758c","fieldLabel":"Key words","valueLabel":"SEC, RED, BLUE, Security"}],"ref":"https://api.smartrecruiters.com/v1/companies/allegro/postings/743999782019147","creator":{"name":"Adriana Gesiarz"},"language":{"code":"pl","label":"Polish","labelNative":"polski"}},{"id":"743999779485268","name":"Chief Architect","uuid":"5ea8adaa-e9ae-4cb2-a1dc-b27600247ffb","refNumber":"REF2835R","company":{"identifier":"Allegro","name":"Allegro"},"releasedDate":"2021-10-14T13:53:22.000Z","location":{"city":"Warszawa, Kraków, Poznań, Toruń, Gdańsk, Łódź, Katowice, Lublin","region":"Masovian Voivodeship","country":"pl","remote":false},"industry":{"id":"internet","label":"Internet"},"department":{"id":"2572787","label":"IT - Technical Platform"},"function":{"id":"information_technology","label":"Information Technology"},"typeOfEmployment":{"label":"Full-time"},"experienceLevel":{"id":"mid_senior_level","label":"Mid-Senior Level"},"customField":[{"fieldId":"58c1575ee4b01d4b19ddf797","fieldLabel":"Kraków","valueId":"2cfcfcc1-da44-43f7-8eaa-3907faf2797c","valueLabel":"Tak"},{"fieldId":"58c158e9e4b0614667d5973e","fieldLabel":"Więcej lokalizacji","valueId":"3a186e8d-a82c-4955-af81-fcef9a63928a","valueLabel":"Tak"},{"fieldId":"58c1576ee4b0614667d59732","fieldLabel":"Toruń","valueId":"987e8884-bad1-4a8f-b149-99e4184cc221","valueLabel":"Tak"},{"fieldId":"58c156e6e4b01d4b19ddf793","fieldLabel":"Warszawa","valueId":"6a428533-1586-4372-89ec-65fb45366363","valueLabel":"Tak"},{"fieldId":"58c15608e4b01d4b19ddf790","fieldLabel":"Proces rekrutacji","valueId":"c807eec2-8a53-4b55-b7c5-c03180f2059b","valueLabel":"(Archive) IT Allegro"},{"fieldId":"COUNTRY","fieldLabel":"Country","valueId":"pl","valueLabel":"Poland"},{"fieldId":"58c15798e4b01d4b19ddf79b","fieldLabel":"Wrocław","valueId":"64818201-cdba-422e-8e8c-8ec633b0d327","valueLabel":"Tak"},{"fieldId":"58c13159e4b01d4b19ddf729","fieldLabel":"Department","valueId":"2572787","valueLabel":"IT - Technical Platform"},{"fieldId":"58c13159e4b01d4b19ddf728","fieldLabel":"Brands","valueId":"4ccb4fab-6c3f-4ed0-9140-8533fe17447f","valueLabel":"Allegro.pl sp. z o.o."},{"fieldId":"58c156b9e4b01d4b19ddf792","fieldLabel":"Poznań","valueId":"ac20917b-cb6a-4280-aff3-4fae2532a33e","valueLabel":"Tak"},{"fieldId":"5cdab2c84cedfd0006e7758c","fieldLabel":"Key words","valueLabel":"chief architect, architekt, architect, platform, architektura"}],"ref":"https://api.smartrecruiters.com/v1/companies/allegro/postings/743999779485268","creator":{"name":"Angelika Szymkiewicz"},"language":{"code":"pl","label":"Polish","labelNative":"polski"}},{"id":"743999779448775","name":"Research Engineer - Machine Learning (Reinforcement Learning)","uuid":"c8e577cc-c93a-43e7-8e73-e430989798d7","refNumber":"REF2881V","company":{"identifier":"Allegro","name":"Allegro"},"releasedDate":"2021-10-14T10:29:36.000Z","location":{"city":"Warszawa, Kraków, Poznań, Toruń, Wrocław, Gdańsk, Katowice, Łódź, Lublin","country":"pl","remote":false},"industry":{"id":"internet","label":"Internet"},"department":{"id":"2572821","label":"IT - Machine Learning"},"function":{"id":"information_technology","label":"Information Technology"},"typeOfEmployment":{"label":"Full-time"},"experienceLevel":{"id":"mid_senior_level","label":"Mid-Senior Level"},"customField":[{"fieldId":"606235fe248e6f5bea0815ed","fieldLabel":"Katowice","valueId":"185eb5a9-b884-4ee8-8ebc-0e5f3e852b27","valueLabel":"Tak"},{"fieldId":"58c1575ee4b01d4b19ddf797","fieldLabel":"Kraków","valueId":"2cfcfcc1-da44-43f7-8eaa-3907faf2797c","valueLabel":"Tak"},{"fieldId":"606235bcefbac7156d6a470a","fieldLabel":"Łódź","valueId":"7d33e23d-3fa7-4d7d-86ae-7d7caff54fa9","valueLabel":"Tak"},{"fieldId":"58c158e9e4b0614667d5973e","fieldLabel":"Więcej lokalizacji","valueId":"3a186e8d-a82c-4955-af81-fcef9a63928a","valueLabel":"Tak"},{"fieldId":"58c1576ee4b0614667d59732","fieldLabel":"Toruń","valueId":"987e8884-bad1-4a8f-b149-99e4184cc221","valueLabel":"Tak"},{"fieldId":"6165609ee6b46b6506c66b63","fieldLabel":"Gdańsk","valueId":"cde0f8e7-5c9d-4d78-9f5c-e1c17ee499a8","valueLabel":"Tak"},{"fieldId":"58c156e6e4b01d4b19ddf793","fieldLabel":"Warszawa","valueId":"6a428533-1586-4372-89ec-65fb45366363","valueLabel":"Tak"},{"fieldId":"58c15608e4b01d4b19ddf790","fieldLabel":"Proces rekrutacji","valueId":"c807eec2-8a53-4b55-b7c5-c03180f2059b","valueLabel":"(Archive) IT Allegro"},{"fieldId":"COUNTRY","fieldLabel":"Country","valueId":"pl","valueLabel":"Poland"},{"fieldId":"58c15788e4b0614667d59733","fieldLabel":"Błonie","valueId":"25f6cb8c-81b3-434a-93ec-6dc851d5808d","valueLabel":"Nie"},{"fieldId":"58c15798e4b01d4b19ddf79b","fieldLabel":"Wrocław","valueId":"64818201-cdba-422e-8e8c-8ec633b0d327","valueLabel":"Tak"},{"fieldId":"58c13159e4b01d4b19ddf729","fieldLabel":"Department","valueId":"2572821","valueLabel":"IT - Machine Learning"},{"fieldId":"58c13159e4b01d4b19ddf728","fieldLabel":"Brands","valueId":"4ccb4fab-6c3f-4ed0-9140-8533fe17447f","valueLabel":"Allegro.pl sp. z o.o."},{"fieldId":"61656102a169ed164d546c31","fieldLabel":"Lublin","valueId":"02d54f00-48b9-4669-b7b3-10c16ac4bada","valueLabel":"Tak"},{"fieldId":"58c156b9e4b01d4b19ddf792","fieldLabel":"Poznań","valueId":"ac20917b-cb6a-4280-aff3-4fae2532a33e","valueLabel":"Tak"},{"fieldId":"5cdab2c84cedfd0006e7758c","fieldLabel":"Key words","valueLabel":"ML, Machine Learning, Python, Deep Learning, AI, Artificial Intelligence"}],"ref":"https://api.smartrecruiters.com/v1/companies/allegro/postings/743999779448775","creator":{"name":"Maciej Matwiejczyk"},"language":{"code":"pl","label":"Polish","labelNative":"polski"}}],"events":[{"created":1635344914000,"duration":7200000,"id":"281692274","name":"Allegro Tech Live #23 - Przygody backendowców w C#","date_in_series_pattern":false,"status":"past","time":1636045200000,"local_date":"2021-11-04","local_time":"18:00","updated":1636056125000,"utc_offset":3600000,"waitlist_count":0,"yes_rsvp_count":29,"is_online_event":false,"group":{"created":1425052059000,"name":"allegro Tech","id":18465254,"join_mode":"open","lat":52.2599983215332,"lon":21.020000457763672,"urlname":"allegrotech","who":"Techs","localized_location":"Warsaw, Poland","state":"","country":"pl","region":"en_US","timezone":"Europe/Warsaw"},"link":"https://www.meetup.com/allegrotech/events/281692274/","description":"------ Rejestracja: https://app.evenea.pl/event/allegro-tech-live-23/------- Allegro Tech Live to w 100% zdalna odsłona naszych stacjonarnych meetupów Allegro Tech Talks. Kiedyś spotykaliśmy się w naszych biurach, a teraz…","visibility":"public","member_pay_fee":false},{"created":1634290537000,"duration":5400000,"id":"281441586","name":"Allegro Tech Live #22 - Jak wygląda codzienność lidera w Allegro?","date_in_series_pattern":false,"status":"past","time":1634832000000,"local_date":"2021-10-21","local_time":"18:00","updated":1634841007000,"utc_offset":7200000,"waitlist_count":0,"yes_rsvp_count":67,"venue":{"id":26906060,"name":"Online event","repinned":false,"country":"","localized_country_name":""},"is_online_event":true,"group":{"created":1425052059000,"name":"allegro Tech","id":18465254,"join_mode":"open","lat":52.2599983215332,"lon":21.020000457763672,"urlname":"allegrotech","who":"Techs","localized_location":"Warsaw, Poland","state":"","country":"pl","region":"en_US","timezone":"Europe/Warsaw"},"link":"https://www.meetup.com/allegrotech/events/281441586/","description":"!!!! Rejestracja: https://app.evenea.pl/event/allegro-tech-live-22/ !!!! Allegro Tech Live to w 100% zdalna odsłona naszych stacjonarnych meetupów Allegro Tech Talks. Zazwyczaj spotykaliśmy się w naszych biurach, ale…","visibility":"public","member_pay_fee":false},{"created":1633336352000,"duration":7200000,"id":"281199452","name":"Allegro Tech Live #21 - Jak zautomatyzować bezpieczeństwo IT?","date_in_series_pattern":false,"status":"past","time":1633622400000,"local_date":"2021-10-07","local_time":"18:00","updated":1633634017000,"utc_offset":7200000,"waitlist_count":0,"yes_rsvp_count":48,"is_online_event":false,"group":{"created":1425052059000,"name":"allegro Tech","id":18465254,"join_mode":"open","lat":52.2599983215332,"lon":21.020000457763672,"urlname":"allegrotech","who":"Techs","localized_location":"Warsaw, Poland","state":"","country":"pl","region":"en_US","timezone":"Europe/Warsaw"},"link":"https://www.meetup.com/allegrotech/events/281199452/","description":"Allegro Tech Live to w 100% zdalna odsłona naszych stacjonarnych meetupów Allegro Tech Talks. Zazwyczaj spotykaliśmy się w naszych biurach, ale tym razem to my…","visibility":"public","member_pay_fee":false},{"created":1629120828000,"duration":93600000,"id":"280149404","name":"Allegro Tech Meeting 2021","date_in_series_pattern":false,"status":"past","time":1632927600000,"local_date":"2021-09-29","local_time":"17:00","updated":1633024970000,"utc_offset":7200000,"waitlist_count":0,"yes_rsvp_count":144,"venue":{"id":26906060,"name":"Online event","repinned":false,"country":"","localized_country_name":""},"is_online_event":true,"group":{"created":1425052059000,"name":"allegro Tech","id":18465254,"join_mode":"open","lat":52.2599983215332,"lon":21.020000457763672,"urlname":"allegrotech","who":"Techs","localized_location":"Warsaw, Poland","state":"","country":"pl","region":"en_US","timezone":"Europe/Warsaw"},"link":"https://www.meetup.com/allegrotech/events/280149404/","description":"❗Uwaga, aby wziąć udział w wydarzeniu zarejestruj się tutaj: https://app.evenea.pl/event/atm-2021/ ❗ Allegro to jedna z najbardziej zaawansowanych technologicznie firm w naszej części Europy. Allegro to…","how_to_find_us":"https://www.youtube.com/c/AllegroTechBlog","visibility":"public","member_pay_fee":false}],"podcasts":[{"creator":{"name":["Piotr Betkier"]},"title":"Rola architekta w Allegro","link":"https://podcast.allegro.tech/rola_architekta_w_allegro","pubDate":"Wed, 16 Jun 2021 00:00:00 GMT","author":{"name":["Piotr Betkier"]},"enclosure":{"url":"https://www.buzzsprout.com/887914/8712218.mp3","type":"audio/mpeg"},"content":"Od kodowania do tworzenia strategii technicznej... Jak wygląda rola architekta w Allegro? Ile takich osób pracuje w naszej firmie i dlaczego ta rola jest tak różnorodna? Czym jest Andamio i jak rozwijamy naszą platformę – o tym wszystkim opowie Piotr Betkier – Inżynier, Architekt Platformy Technicznej w Allegro oraz twórca piosenek o IT :)","contentSnippet":"Od kodowania do tworzenia strategii technicznej... Jak wygląda rola architekta w Allegro? Ile takich osób pracuje w naszej firmie i dlaczego ta rola jest tak różnorodna? Czym jest Andamio i jak rozwijamy naszą platformę – o tym wszystkim opowie Piotr Betkier – Inżynier, Architekt Platformy Technicznej w Allegro oraz twórca piosenek o IT :)","guid":"https://podcast.allegro.tech/rola_architekta_w_allegro","isoDate":"2021-06-16T00:00:00.000Z","itunes":{"author":"Piotr Betkier","summary":"Od kodowania do tworzenia strategii technicznej... Jak wygląda rola architekta w Allegro? Ile takich osób pracuje w naszej firmie i dlaczego ta rola jest tak różnorodna? Czym jest Andamio i jak rozwijamy naszą platformę – o tym wszystkim opowie Piotr Betkier – Inżynier, Architekt Platformy Technicznej w Allegro oraz twórca piosenek o IT :)","explicit":"false"}},{"creator":{"name":["Piotr Michoński"]},"title":"Infrastruktura Allegro","link":"https://podcast.allegro.tech/infrastruktura_Allegro","pubDate":"Tue, 01 Jun 2021 00:00:00 GMT","author":{"name":["Piotr Michoński"]},"enclosure":{"url":"https://www.buzzsprout.com/887914/8623783-sezon-ii-11-infrastruktura-allegro-piotr-michonski.mp3","type":"audio/mpeg"},"content":"Jak jest zbudowane środowisko uruchomienia aplikacji Allegro? Jak działają serwerownie firmy i ile ich potrzeba, a które elementy Allegro działają w chmurze publicznej? Jak przebiegała transformacja w Allegro i co zmieniało się przez lata? Jak wzrost biznesu wpływa na wielkość infrastruktury i jak infrastruktura Allegro odczuła przyjście pandemii? O tym, a także o rozwoju liderów technologii w Allegro oraz o historii powstania dżingla do naszych podcastów, opowie Piotr Michoński - menadżer Zespołów tworzących infrastrukturę Allegro.","contentSnippet":"Jak jest zbudowane środowisko uruchomienia aplikacji Allegro? Jak działają serwerownie firmy i ile ich potrzeba, a które elementy Allegro działają w chmurze publicznej? Jak przebiegała transformacja w Allegro i co zmieniało się przez lata? Jak wzrost biznesu wpływa na wielkość infrastruktury i jak infrastruktura Allegro odczuła przyjście pandemii? O tym, a także o rozwoju liderów technologii w Allegro oraz o historii powstania dżingla do naszych podcastów, opowie Piotr Michoński - menadżer Zespołów tworzących infrastrukturę Allegro.","guid":"https://podcast.allegro.tech/infrastruktura_Allegro","isoDate":"2021-06-01T00:00:00.000Z","itunes":{"author":"Piotr Michoński","summary":"Jak jest zbudowane środowisko uruchomienia aplikacji Allegro? Jak działają serwerownie firmy i ile ich potrzeba, a które elementy Allegro działają w chmurze publicznej? Jak przebiegała transformacja w Allegro i co zmieniało się przez lata? Jak wzrost biznesu wpływa na wielkość infrastruktury i jak infrastruktura Allegro odczuła przyjście pandemii? O tym, a także o rozwoju liderów technologii w Allegro oraz o historii powstania dżingla do naszych podcastów, opowie Piotr Michoński - menadżer Zespołów tworzących infrastrukturę Allegro.","explicit":"false"}},{"creator":{"name":["Dariusz Eliasz"]},"title":"Praca architekta ekosystemu big data w Allegro","link":"https://podcast.allegro.tech/praca_architekta_ekosystemu_big_data_w_Allegro","pubDate":"Thu, 20 May 2021 00:00:00 GMT","author":{"name":["Dariusz Eliasz"]},"enclosure":{"url":"https://www.buzzsprout.com/887914/8554742-sezon-ii-10-przetwarzanie-danych-w-allegro-dariusz-eliasz.mp3","type":"audio/mpeg"},"content":"Jak wygląda praca architekta ekosystemu big data w Allegro? Jakie zadania realizuje nasz zespół odpowiedzialny za narzędzia i infrastrukturę dla przetwarzania danych? Kiedy możemy mówić o dużych danych i ile petabajtów przetwarza Allegro? Skąd pochodzą dane Allegro i dlaczego jest ich tak dużo oraz z jakiego powodu dopiero teraz przenosimy się do chmury? O tym wszystkim opowie zdobywca statuetki Allegro Tech Hero - Dariusz Eliasz – Team Manager \u0026 Platform Architect w Allegro.","contentSnippet":"Jak wygląda praca architekta ekosystemu big data w Allegro? Jakie zadania realizuje nasz zespół odpowiedzialny za narzędzia i infrastrukturę dla przetwarzania danych? Kiedy możemy mówić o dużych danych i ile petabajtów przetwarza Allegro? Skąd pochodzą dane Allegro i dlaczego jest ich tak dużo oraz z jakiego powodu dopiero teraz przenosimy się do chmury? O tym wszystkim opowie zdobywca statuetki Allegro Tech Hero - Dariusz Eliasz – Team Manager \u0026 Platform Architect w Allegro.","guid":"https://podcast.allegro.tech/praca_architekta_ekosystemu_big_data_w_Allegro","isoDate":"2021-05-20T00:00:00.000Z","itunes":{"author":"Dariusz Eliasz","summary":"Jak wygląda praca architekta ekosystemu big data w Allegro? Jakie zadania realizuje nasz zespół odpowiedzialny za narzędzia i infrastrukturę dla przetwarzania danych? Kiedy możemy mówić o dużych danych i ile petabajtów przetwarza Allegro? Skąd pochodzą dane Allegro i dlaczego jest ich tak dużo oraz z jakiego powodu dopiero teraz przenosimy się do chmury? O tym wszystkim opowie zdobywca statuetki Allegro Tech Hero - Dariusz Eliasz – Team Manager \u0026 Platform Architect w Allegro.","explicit":"false"}},{"creator":{"name":["Bartosz Gałek"]},"title":"Od inżyniera do lidera w Allegro","link":"https://podcast.allegro.tech/od_inzyniera_do_lidera_w_allegro","pubDate":"Thu, 06 May 2021 00:00:00 GMT","author":{"name":["Bartosz Gałek"]},"enclosure":{"url":"https://www.buzzsprout.com/887914/8455586-sezon-ii-9-od-inzyniera-do-lidera-w-allegro-bartosz-galek.mp3","type":"audio/mpeg"},"content":"Czym jest Opbox i jakie wyzwania przed nim stoją? Jak w Allegro angażujemy się w rozwój kultury Open Source? Ile mamy projektów na GitHubie i jak świętujemy Hacktoberfest? W jaki sposób można rozwinąć się od inżyniera do lidera? Na te pytania w najnowszym Allegro Tech Podcast odpowie Bartek Gałek, Team Leader w Allegro.","contentSnippet":"Czym jest Opbox i jakie wyzwania przed nim stoją? Jak w Allegro angażujemy się w rozwój kultury Open Source? Ile mamy projektów na GitHubie i jak świętujemy Hacktoberfest? W jaki sposób można rozwinąć się od inżyniera do lidera? Na te pytania w najnowszym Allegro Tech Podcast odpowie Bartek Gałek, Team Leader w Allegro.","guid":"https://podcast.allegro.tech/od_inzyniera_do_lidera_w_allegro","isoDate":"2021-05-06T00:00:00.000Z","itunes":{"author":"Bartosz Gałek","summary":"Czym jest Opbox i jakie wyzwania przed nim stoją? Jak w Allegro angażujemy się w rozwój kultury Open Source? Ile mamy projektów na GitHubie i jak świętujemy Hacktoberfest? W jaki sposób można rozwinąć się od inżyniera do lidera? Na te pytania w najnowszym Allegro Tech Podcast odpowie Bartek Gałek, Team Leader w Allegro.","explicit":"false"}}]},"__N_SSG":true},"page":"/","query":{},"buildId":"jvS2iwz_TaC-EZro3Eupc","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>